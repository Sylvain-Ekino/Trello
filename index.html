<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trello ‚Üí Calendrier</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e5e7eb;
      --shadow: 0 20px 50px rgba(2,6,23,.08);
      --shadow-sm: 0 8px 20px rgba(2,6,23,.08);
      --radius: 18px;

      --gantt-row-h: 34px;
      --gantt-bar-h: 18px;
      --gantt-grid: rgba(15,23,42,.06);
      --gantt-grid-strong: rgba(15,23,42,.10);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% 0%, rgba(99,102,241,.10), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(14,165,233,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    /* Top app bar */
    .appbar{
      position: sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(246,247,251,.75);
      border-bottom: 1px solid rgba(229,231,235,.9);
    }
    .appbar-inner{
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap: 10px;
      font-weight: 800; letter-spacing: .2px;
    }
    .dot{
      width: 12px; height: 12px; border-radius: 999px;
      background: linear-gradient(135deg, #6366f1, #0ea5e9);
      box-shadow: 0 10px 30px rgba(99,102,241,.35);
    }
    .sub{
      font-weight: 600; color: var(--muted); font-size: 12px;
    }

    /* Controls */
    .controls{
      display:flex; align-items:center; gap: 10px;
      flex-wrap: wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      padding: 9px 10px;
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
    }
    .chip strong{ font-size: 12px; color: var(--muted); font-weight: 700; }
    .select{
      border: 0;
      outline: none;
      background: transparent;
      font-weight: 700;
      color: var(--text);
      max-width: 240px;
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.9);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: transform .08s ease, box-shadow .08s ease, background .08s ease;
      user-select: none;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 30px rgba(2,6,23,.10); }
    .btn:active{ transform: translateY(0); box-shadow: var(--shadow-sm); }
    .btn.primary{
      border: 1px solid rgba(99,102,241,.35);
      background: linear-gradient(135deg, rgba(99,102,241,.14), rgba(14,165,233,.12));
    }

    .tokenbar{
      display:flex; align-items:center; gap:8px;
      border: 1px dashed rgba(100,116,139,.35);
      background: rgba(255,255,255,.65);
      padding: 9px 10px;
      border-radius: 14px;
    }
    .tokenbar input{
      border: 0; outline:none; background: transparent;
      min-width: 220px;
      font-weight: 700;
    }

    .status{
      max-width: 1280px;
      margin: 10px auto 0;
      padding: 0 16px 10px;
      display:flex; gap: 10px; flex-wrap: wrap;
      align-items:center;
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
    }
    .error{ color: #b91c1c; }

    /* Layout */
    .wrap{
      max-width: 1280px;
      margin: 14px auto 40px;
      padding: 0 16px;
    }
    .panel{
      background: var(--card);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .panel-head{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(229,231,235,.9);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .panel-head .title{
      font-weight: 900;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .seg{
      display:inline-flex;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(246,247,251,.55);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .seg button{
      border:0;
      background: transparent;
      padding: 9px 11px;
      font-weight: 900;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(255,255,255,.92);
    }

    .toggle{
      display:flex; align-items:center; gap: 8px;
      color: var(--muted); font-weight: 700; font-size: 13px;
      user-select: none;
    }
    .toggle input{ transform: translateY(1px); }

    #calendar{
      padding: 10px 10px 0;
    }

    /* FullCalendar modern tweaks */
    .fc .fc-toolbar-title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .fc .fc-button{
      border-radius: 12px !important;
      border: 1px solid var(--border) !important;
      background: rgba(255,255,255,.9) !important;
      color: var(--text) !important;
      font-weight: 800 !important;
      box-shadow: var(--shadow-sm);
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .fc .fc-button:hover{ transform: translateY(-1px); box-shadow: 0 14px 30px rgba(2,6,23,.10); }
    .fc .fc-button.fc-button-active{
      border-color: rgba(99,102,241,.35) !important;
      background: linear-gradient(135deg, rgba(99,102,241,.14), rgba(14,165,233,.12)) !important;
    }
    .fc .fc-scrollgrid, .fc .fc-scrollgrid table{
      border-color: rgba(229,231,235,.9) !important;
    }
    .fc .fc-daygrid-day-number{
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
    }
    .fc .fc-col-header-cell-cushion{
      color: var(--muted);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 11px;
    }

    /* Events => pill */
    .fc .fc-event{
      border-radius: 999px !important;
      border-width: 1px !important;
      padding: 2px 8px !important;
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
      overflow: hidden;
    }
    .fc .fc-event:hover{
      filter: brightness(1.03);
      box-shadow: 0 14px 32px rgba(2,6,23,.14);
    }
    .compact .fc .fc-event{
      padding: 1px 7px !important;
      font-size: 11px;
    }

    /* Tooltip */
    .tt{
      position: fixed; z-index: 9999;
      width: min(460px, calc(100vw - 24px));
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 16px;
      box-shadow: 0 25px 70px rgba(2,6,23,.16);
      padding: 12px 12px 10px;
      font-size: 13px;
      line-height: 1.35;
      pointer-events: none;
    }
    .tt h4{ margin:0 0 6px 0; font-size: 13px; font-weight: 900; }
    .tt .meta{ color: var(--muted); margin-bottom: 10px; font-weight: 700; }
    .tt .sec{ margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(229,231,235,.9); }
    .tt ul{ margin: 0; padding-left: 18px; }
    .tt li{ margin: 2px 0; }
    .tt .done{ text-decoration: line-through; color: var(--muted); }

    /* ===== GANTT ===== */
    #gantt{
      padding: 10px 10px 14px;
      display:none;
    }
    .ganttmode #gantt{ display:block; }
    .ganttmode #calendar .fc-view-harness{ display:none; } /* garde toolbar FullCalendar */

    .ganttmode #ganttOptions{ display:inline-flex !important; }

    .gantt-shell{
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      background: rgba(255,255,255,.9);
    }

    .gantt-top{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(229,231,235,.95);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .gantt-top .range{
      font-weight: 900;
      letter-spacing: .2px;
    }
    .gantt-top .hint{
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }

    .gantt-grid{
      position: relative;
      display:grid;
      grid-template-columns: minmax(220px, 360px) 1fr;
      min-height: 60px;
    }
    .compact .gantt-grid{ grid-template-columns: minmax(200px, 320px) 1fr; }

    .gantt-left{
      border-right: 1px solid rgba(229,231,235,.95);
      background: linear-gradient(180deg, rgba(246,247,251,.65), rgba(255,255,255,.9));
    }
    .gantt-right{
      position: relative;
      background:
        repeating-linear-gradient(
          to right,
          var(--gantt-grid) 0px,
          var(--gantt-grid) 1px,
          transparent 1px,
          transparent var(--gantt-day-w, 26px)
        );
    }
    .gantt-right::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to right,
          transparent 0,
          transparent calc(var(--gantt-week-w, 182px) - 1px),
          var(--gantt-grid-strong) calc(var(--gantt-week-w, 182px) - 1px),
          var(--gantt-grid-strong) var(--gantt-week-w, 182px)
        );
      pointer-events:none;
      opacity:.8;
    }

    .gantt-head{
      display:grid;
      grid-template-columns: minmax(220px, 360px) 1fr;
      border-bottom: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
    }
    .gantt-head .hl{
      padding: 10px 12px;
      font-weight: 900;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      border-right: 1px solid rgba(229,231,235,.95);
    }
    .gantt-head .hr{
      position: relative;
      padding: 10px 12px;
      overflow:hidden;
    }
    .ticks{
      display:flex;
      gap: 0;
      align-items:center;
      height: 18px;
      position: relative;
    }
    .tick{
      width: var(--gantt-week-w, 182px);
      min-width: var(--gantt-week-w, 182px);
      color: var(--muted);
      font-weight: 900;
      font-size: 11px;
      letter-spacing: .02em;
      text-transform: uppercase;
      opacity:.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 8px;
    }

    .gantt-rows{
      display:block;
      max-height: min(68vh, 900px);
      overflow:auto;
      position: relative;
    }

    /* Swimlanes (group by list) */
    .group-head{
      display:grid;
      grid-template-columns: minmax(220px, 360px) 1fr;
      background: rgba(246,247,251,.75);
      border-top: 1px solid rgba(229,231,235,.95);
      border-bottom: 1px solid rgba(229,231,235,.75);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .group-head .ghl{
      padding: 10px 12px;
      border-right: 1px solid rgba(229,231,235,.75);
      display:flex; align-items:center; gap: 10px;
      min-width:0;
    }
    .group-pill{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.9);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      cursor: pointer;
      user-select:none;
    }
    .group-pill span{
      color: var(--muted);
      font-weight: 900;
      font-size: 11px;
    }
    .group-head .ghr{ position: relative; }

    .gantt-row{
      display:grid;
      grid-template-columns: minmax(220px, 360px) 1fr;
      border-bottom: 1px solid rgba(229,231,235,.75);
      min-height: var(--gantt-row-h);
    }
    .compact{
      --gantt-row-h: 28px;
      --gantt-bar-h: 16px;
    }

    .gantt-row .lcell{
      padding: 8px 12px;
      border-right: 1px solid rgba(229,231,235,.75);
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
    }
    .lcell .name{
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lcell .meta{
      font-weight: 800;
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .lcell .stack{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width:0;
    }

    .gantt-row .rcell{
      position: relative;
      padding: 0;
    }

    .bar{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      height: var(--gantt-bar-h);
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 20px rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      padding: 0 8px;
      gap: 8px;
      cursor: pointer;
      min-width: 10px;
      overflow:hidden;
    }
    .bar:hover{
      filter: brightness(1.03);
      box-shadow: 0 14px 28px rgba(2,6,23,.14);
    }
    .bar .t{
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .milestone{
      position:absolute;
      top: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 20px rgba(2,6,23,.10);
      cursor:pointer;
    }
    .milestone:hover{
      filter: brightness(1.05);
      box-shadow: 0 14px 28px rgba(2,6,23,.14);
    }

    .todayLine{
      position:absolute;
      top:0; bottom:0;
      width: 2px;
      background: rgba(239,68,68,.75);
      box-shadow: 0 0 0 3px rgba(239,68,68,.10);
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="appbar">
    <div class="appbar-inner">
      <div>
        <div class="brand"><span class="dot"></span> Trello Calendar <span class="sub">Trimestre ‚Ä¢ style planning</span></div>
      </div>

      <div class="controls">
        <div class="chip">
          <strong>Tag</strong>
          <select id="labelFilter" class="select">
            <option value="__ALL__">Tous</option>
          </select>
        </div>

        <div class="chip" title="Filtrer par texte (nom / liste)">
          <strong>Recherche</strong>
          <input id="searchInput" class="select" style="max-width:220px" placeholder="ex: onboarding‚Ä¶" />
        </div>

        <button class="btn" id="refreshBtn">Rafra√Æchir</button>
        <button class="btn" id="logoutBtn" title="Oublier le token">Oublier</button>

        <div class="tokenbar">
          <input id="tokenInput" type="password" placeholder="Trello token" />
          <button class="btn primary" id="saveTokenBtn">Valider</button>
        </div>
      </div>
    </div>

    <div class="status">
      <span id="status"></span>
      <span id="error" class="error"></span>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-head">
        <div class="title">
          <span>Vue trimestre</span>
          <div class="seg" role="tablist" aria-label="Mode d'affichage">
            <button id="modeCalendarBtn" class="active" type="button">Calendrier</button>
            <button id="modeGanttBtn" type="button">Gantt</button>
          </div>

          <div id="ganttOptions" class="seg" style="display:none" aria-label="Options Gantt">
            <button id="ganttGroupBtn" type="button" title="Regrouper par liste">Par liste</button>
            <button id="ganttZoom1Btn" type="button" title="Zoom 1 mois">1M</button>
            <button id="ganttZoom3Btn" type="button" class="active" title="Zoom 3 mois">3M</button>
            <button id="ganttZoom6Btn" type="button" title="Zoom 6 mois">6M</button>
          </div>
        </div>

        <label class="toggle"><input type="checkbox" id="compactToggle" /> Mode compact</label>
      </div>

      <div id="calendar"></div>
      <div id="gantt"></div>
    </div>
  </div>

  <script>
    const TRELLO = {
      key: "ec995ad68de9cdaafd64b131e5fa00ec",
      boardId: "6490c5416cea9255ba3b0383"
    };

    const API_BASE = "https://api.trello.com/1";
    const CARD_FIELDS = "name,due,start,closed,url,idLabels,labels,idList";
    const DONE_LIST_NAMES = new Set(["üéâ Termin√©"]);

    const TRELLO_LABEL_COLOR_TO_HEX = {
      green:  "#22c55e",
      yellow: "#eab308",
      orange: "#f97316",
      red:    "#ef4444",
      purple: "#a855f7",
      blue:   "#3b82f6",
      sky:    "#0ea5e9",
      lime:   "#84cc16",
      pink:   "#ec4899",
      black:  "#111827"
    };

    let allEvents = [];
    let calendar;
    let listIdToName = new Map();
    let doneListIds = new Set();
    let labelIdToHex = new Map();

    const checklistCache = new Map();
    let tooltipEl = null;

    const VIEW_MODE_KEY = "tc_view_mode";
    function getViewMode(){ return localStorage.getItem(VIEW_MODE_KEY) || "calendar"; }
    function setViewMode(mode){ localStorage.setItem(VIEW_MODE_KEY, mode); }

    const SEARCH_KEY = "tc_search";
    const GROUP_KEY = "tc_gantt_group";
    const COLLAPSE_KEY = "tc_gantt_collapsed";
    const ZOOM_KEY = "tc_gantt_zoom"; // "1" | "3" | "6"

    function getSearch(){ return localStorage.getItem(SEARCH_KEY) || ""; }
    function setSearch(v){ localStorage.setItem(SEARCH_KEY, v || ""); }
    function getGroupByList(){ return (localStorage.getItem(GROUP_KEY) || "1") === "1"; }
    function setGroupByList(v){ localStorage.setItem(GROUP_KEY, v ? "1" : "0"); }
    function getCollapsed(){
      try { return new Set(JSON.parse(localStorage.getItem(COLLAPSE_KEY) || "[]")); }
      catch { return new Set(); }
    }
    function setCollapsed(set){
      localStorage.setItem(COLLAPSE_KEY, JSON.stringify([...set]));
    }
    function getZoom(){ return localStorage.getItem(ZOOM_KEY) || "3"; }
    function setZoom(z){ localStorage.setItem(ZOOM_KEY, z); }

    function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
    function setError(msg) { document.getElementById("error").textContent = msg || ""; }

    function getToken() { return localStorage.getItem("trello_token"); }
    function saveToken(token) { localStorage.setItem("trello_token", token); }
    function forgetToken() {
      localStorage.removeItem("trello_token");
      document.getElementById("tokenInput").value = "";
      calendar?.removeAllEvents();
      setError("");
      setStatus("Token supprim√© sur ce navigateur.");
      renderGanttIfNeeded(true);
    }

    function qs(params) { return new URLSearchParams(params).toString(); }

    function uniqBy(arr, keyFn) {
      const seen = new Set();
      return arr.filter(x => {
        const k = keyFn(x);
        if (seen.has(k)) return false;
        seen.add(k);
        return true;
      });
    }

    async function fetchBoardLists(token) {
      const url = `${API_BASE}/boards/${encodeURIComponent(TRELLO.boardId)}/lists?` + qs({
        key: TRELLO.key, token, fields: "name", filter: "open"
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Trello API error (${res.status})`);
      return res.json();
    }

    async function fetchBoardCards(token) {
      const url = `${API_BASE}/boards/${encodeURIComponent(TRELLO.boardId)}/cards?` + qs({
        key: TRELLO.key, token, fields: CARD_FIELDS, filter: "open"
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Trello API error (${res.status})`);
      return res.json();
    }

    async function fetchCardChecklists(token, cardId) {
      const url = `${API_BASE}/cards/${encodeURIComponent(cardId)}/checklists?` + qs({
        key: TRELLO.key, token
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Trello API error (${res.status})`);
      return res.json();
    }

    function isDoneListName(name) { return DONE_LIST_NAMES.has(name); }

    function pickEventColorFromLabels(labels) {
      const firstColored = (labels || []).find(l => l && l.color);
      if (!firstColored) return null;
      return TRELLO_LABEL_COLOR_TO_HEX[firstColored.color] || null;
    }

    function makeExclusiveEnd(dueIso) {
      const d = new Date(dueIso);
      d.setDate(d.getDate() + 1);
      return d.toISOString();
    }

    function cardToEvent(card) {
      if (doneListIds.has(card.idList)) return null;
      if (!card.start && !card.due) return null;

      const listName = listIdToName.get(card.idList) || "Liste";
      const title = `[${listName}] ${card.name}`;

      const labels = (card.labels || []).map(l => ({ id: l.id, name: l.name, color: l.color }));
      const baseColor = pickEventColorFromLabels(labels);

      let start = card.start || card.due;
      let end = null;
      if (card.start && card.due) end = makeExclusiveEnd(card.due);

      return {
        id: card.id,
        title,
        start,
        end: end || undefined,
        allDay: true,
        url: card.url,
        backgroundColor: baseColor || undefined,
        borderColor: baseColor || undefined,
        textColor: baseColor ? "#ffffff" : undefined,
        extendedProps: {
          labelIds: card.idLabels || [],
          labels,
          listName,
          baseColor: baseColor || null
        }
      };
    }

    function rebuildLabelDropdown(events) {
      const select = document.getElementById("labelFilter");
      const labels = [];

      for (const ev of events) {
        for (const l of (ev.extendedProps.labels || [])) {
          if (l.name && l.id) labels.push(l);
        }
      }

      labelIdToHex = new Map();
      for (const l of labels) {
        const hex = l.color ? (TRELLO_LABEL_COLOR_TO_HEX[l.color] || null) : null;
        if (hex) labelIdToHex.set(l.id, hex);
      }

      const unique = uniqBy(labels, l => l.id).sort((a,b) => (a.name || "").localeCompare(b.name || "", "fr"));
      const current = select.value || "__ALL__";

      select.innerHTML = "";
      select.appendChild(new Option("Tous", "__ALL__"));
      for (const l of unique) select.appendChild(new Option(l.name || "(Sans nom)", l.id));

      select.value = [...select.options].some(o => o.value === current) ? current : "__ALL__";
    }

    function applyFilter() {
      const labelId = document.getElementById("labelFilter").value;
      const q = (document.getElementById("searchInput")?.value || "").trim().toLowerCase();

      let filtered = (labelId === "__ALL__")
        ? allEvents
        : allEvents.filter(ev => (ev.extendedProps.labelIds || []).includes(labelId));

      if (q) {
        filtered = filtered.filter(ev => {
          const t = (ev.title || "").toLowerCase();
          const ln = (ev.extendedProps?.listName || "").toLowerCase();
          return t.includes(q) || ln.includes(q);
        });
      }

      if (labelId !== "__ALL__") {
        const hex = labelIdToHex.get(labelId) || null;
        if (hex) {
          filtered = filtered.map(ev => ({
            ...ev,
            backgroundColor: hex,
            borderColor: hex,
            textColor: "#ffffff"
          }));
        }
      }

      calendar.removeAllEvents();
      calendar.addEventSource(filtered);
      setStatus(`${filtered.length} t√¢che(s) affich√©e(s)`);

      renderGanttIfNeeded();
    }

    // Tooltip
    function ensureTooltip() {
      if (tooltipEl) return tooltipEl;
      tooltipEl = document.createElement("div");
      tooltipEl.className = "tt";
      tooltipEl.style.display = "none";
      document.body.appendChild(tooltipEl);
      return tooltipEl;
    }

    function moveTooltip(mouseEvent) {
      if (!tooltipEl) return;
      const pad = 14;
      let x = mouseEvent.clientX + pad;
      let y = mouseEvent.clientY + pad;

      const rect = tooltipEl.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (x + rect.width + pad > vw) x = vw - rect.width - pad;
      if (y + rect.height + pad > vh) y = vh - rect.height - pad;

      tooltipEl.style.left = x + "px";
      tooltipEl.style.top = y + "px";
    }

    function hideTooltip() {
      if (!tooltipEl) return;
      tooltipEl.style.display = "none";
      tooltipEl.innerHTML = "";
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderChecklistHtml(checklists) {
      if (!checklists || checklists.length === 0) {
        return `<div class="meta">Aucune checklist</div>`;
      }
      const maxLists = 2, maxItems = 10;
      let html = "";
      for (const cl of checklists.slice(0, maxLists)) {
        const items = (cl.checkItems || []);
        const done = items.filter(i => i.state === "complete").length;
        html += `<div class="meta"><strong>${escapeHtml(cl.name)}</strong> ‚Äî ${done}/${items.length}</div>`;
        html += "<ul>";
        for (const it of items.slice(0, maxItems)) {
          const isDone = it.state === "complete";
          html += `<li class="${isDone ? "done" : ""}">${escapeHtml(it.name)}</li>`;
        }
        if (items.length > maxItems) html += `<li class="muted">+${items.length - maxItems} autres‚Ä¶</li>`;
        html += "</ul>";
      }
      if (checklists.length > maxLists) {
        html += `<div class="muted sec">+${checklists.length - maxLists} checklist(s) non affich√©e(s)‚Ä¶</div>`;
      }
      return html;
    }

    async function load() {
      setError("");

      const token = getToken();
      if (!token) {
        setStatus("Renseigne ton token Trello puis clique sur ‚ÄúValider‚Äù.");
        calendar?.removeAllEvents();
        renderGanttIfNeeded(true);
        return;
      }

      setStatus("Chargement Trello‚Ä¶");

      const lists = await fetchBoardLists(token);
      listIdToName = new Map(lists.map(l => [l.id, l.name]));
      doneListIds = new Set(lists.filter(l => isDoneListName(l.name)).map(l => l.id));

      const cards = await fetchBoardCards(token);
      allEvents = cards.map(cardToEvent).filter(Boolean);

      rebuildLabelDropdown(allEvents);
      applyFilter();
      setError("");
    }

    // ===== GANTT rendering =====
    function clampDate(d, min, max){
      const t = d.getTime();
      if (t < min.getTime()) return new Date(min);
      if (t > max.getTime()) return new Date(max);
      return d;
    }

    function startOfDay(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }

    function diffDays(a, b){
      const ms = startOfDay(b).getTime() - startOfDay(a).getTime();
      return Math.round(ms / 86400000);
    }

    function formatRange(start, end){
      const fmt = new Intl.DateTimeFormat("fr", { day:"2-digit", month:"short", year:"numeric" });
      const s = fmt.format(start);
      const eInc = new Date(end);
      eInc.setDate(eInc.getDate() - 1);
      const e = fmt.format(eInc);
      return `${s} ‚Üí ${e}`;
    }

    function getFilteredEventsFromCalendar(){
      const sources = calendar.getEvents();
      return sources.map(ev => ({
        id: ev.id,
        title: ev.title,
        start: ev.startStr,
        end: ev.endStr || undefined,
        allDay: ev.allDay,
        url: ev.url,
        backgroundColor: ev.backgroundColor,
        borderColor: ev.borderColor,
        textColor: ev.textColor,
        extendedProps: ev.extendedProps
      }));
    }

    function computeScaleVars(totalDays){
      const dayW = Math.max(14, Math.min(30, Math.floor((window.innerWidth - 520) / Math.max(28, totalDays))));
      const weekW = dayW * 7;
      return { dayW, weekW };
    }

    function weekTicks(rangeStart, rangeEnd){
      const ticks = [];
      const d = startOfDay(rangeStart);
      const day = d.getDay(); // 0=Sun..6=Sat
      const deltaToMon = (day === 0) ? 1 : (day <= 1 ? (1 - day) : (8 - day));
      d.setDate(d.getDate() + deltaToMon);

      const fmt = new Intl.DateTimeFormat("fr", { day:"2-digit", month:"short" });
      while (d < rangeEnd) {
        ticks.push(fmt.format(d));
        d.setDate(d.getDate() + 7);
      }
      return ticks;
    }

    function renderGanttIfNeeded(forceEmpty=false){
      const mode = getViewMode();
      document.body.classList.toggle("ganttmode", mode === "gantt");

      const calBtn = document.getElementById("modeCalendarBtn");
      const ganttBtn = document.getElementById("modeGanttBtn");
      calBtn.classList.toggle("active", mode !== "gantt");
      ganttBtn.classList.toggle("active", mode === "gantt");

      const ganttOptions = document.getElementById("ganttOptions");
      if (ganttOptions) ganttOptions.style.display = (mode === "gantt") ? "inline-flex" : "none";

      const ganttEl = document.getElementById("gantt");
      if (mode !== "gantt") {
        ganttEl.innerHTML = "";
        return;
      }

      const token = getToken();
      if (forceEmpty || !token) {
        ganttEl.innerHTML = `
          <div class="gantt-shell">
            <div class="gantt-top">
              <div class="range">Gantt</div>
              <div class="hint">Renseigne un token pour afficher les t√¢ches.</div>
            </div>
          </div>
        `;
        return;
      }

      const view = calendar.view;
      const rangeStart = startOfDay(view.currentStart);
      const rangeEnd = startOfDay(view.currentEnd); // exclusive
      const totalDays = Math.max(1, diffDays(rangeStart, rangeEnd));

      const { dayW, weekW } = computeScaleVars(totalDays);

      const events = getFilteredEventsFromCalendar()
        .filter(ev => ev.start)
        .map(ev => {
          const s = startOfDay(new Date(ev.start));
          const e = ev.end ? startOfDay(new Date(ev.end)) : null; // end exclusive if present
          return { ...ev, _s: s, _e: e };
        })
        .sort((a,b) => a._s - b._s);

      const ticks = weekTicks(rangeStart, rangeEnd);
      const rangeLabel = formatRange(rangeStart, rangeEnd);

      const today = startOfDay(new Date());
      const todayOffset = diffDays(rangeStart, today);
      const showToday = today >= rangeStart && today < rangeEnd;

      const groupBy = getGroupByList();
      const collapsed = getCollapsed();

      function groupKey(ev){
        return (ev.extendedProps?.listName || "Sans liste");
      }

      // group -> events
      const groups = new Map();
      for (const ev of events) {
        const k = groupKey(ev);
        if (!groups.has(k)) groups.set(k, []);
        groups.get(k).push(ev);
      }

      const groupNames = groupBy
        ? [...groups.keys()].sort((a,b) => a.localeCompare(b, "fr"))
        : ["__ALL__"];

      let rowsHtml = "";
      for (const gName of groupNames) {
        const gEvents = groupBy ? (groups.get(gName) || []) : events;
        const sorted = gEvents.slice().sort((a,b) => (a._s - b._s) || (a.title||"").localeCompare(b.title||"", "fr"));

        if (groupBy) {
          const isCollapsed = collapsed.has(gName);
          rowsHtml += `
            <div class="group-head" data-group="${escapeHtml(gName)}">
              <div class="ghl">
                <div class="group-pill" data-action="toggle-group" title="Cliquer pour replier/d√©plier">
                  ${escapeHtml(gName)} <span>(${sorted.length})</span> ${isCollapsed ? "‚ñ∏" : "‚ñæ"}
                </div>
              </div>
              <div class="ghr"></div>
            </div>
          `;
          if (isCollapsed) continue;
        }

        for (const ev of sorted) {
          const listName = ev.extendedProps?.listName || "";
          const color = ev.backgroundColor || ev.extendedProps?.baseColor || "#475569";
          const textColor = ev.textColor || "#ffffff";

          const hasRange = !!(ev._s && ev._e);
          const isBar = hasRange && ev._e > ev._s;
          const isMilestone = !isBar;

          // Clamp within visible range (end shown as inclusive)
          let s = clampDate(ev._s, rangeStart, new Date(rangeEnd.getTime() - 86400000));
          let e = ev._e ? clampDate(new Date(ev._e.getTime() - 86400000), rangeStart, new Date(rangeEnd.getTime() - 86400000)) : s;

          const leftDays = diffDays(rangeStart, s);
          const rightDays = diffDays(rangeStart, e);

          const leftPx = leftDays * dayW;
          const widthPx = Math.max(dayW, (rightDays - leftDays + 1) * dayW);

          const safeTitle = escapeHtml(ev.title);
          const safeList = escapeHtml(listName);

          rowsHtml += `
            <div class="gantt-row" data-id="${escapeHtml(ev.id)}" data-url="${escapeHtml(ev.url || "")}">
              <div class="lcell">
                <div class="stack">
                  <div class="name" title="${safeTitle}">${safeTitle}</div>
                  <div class="meta" title="${safeList}">${safeList}</div>
                </div>
              </div>
              <div class="rcell">
                ${
                  isMilestone
                    ? `<div class="milestone" style="left:${leftPx + (dayW/2)}px; background:${color};" title="${safeTitle}"></div>`
                    : `<div class="bar" style="left:${leftPx}px; width:${widthPx}px; background:${color}; color:${textColor}; border-color:${color};" title="${safeTitle}">
                        <span class="t">${safeTitle}</span>
                      </div>`
                }
              </div>
            </div>
          `;
        }

        if (!groupBy) break;
      }

      ganttEl.innerHTML = `
        <div class="gantt-shell" style="--gantt-day-w:${dayW}px; --gantt-week-w:${weekW}px;">
          <div class="gantt-top">
            <div>
              <div class="range">Gantt ‚Ä¢ ${escapeHtml(rangeLabel)}</div>
              <div class="hint">${events.length} t√¢che(s) dans la plage visible ‚Ä¢ Survol = checklists</div>
            </div>
            <div class="hint">Astuce: utilise Prev/Next/Today (toolbar en haut)</div>
          </div>

          <div class="gantt-head">
            <div class="hl">T√¢ches</div>
            <div class="hr">
              <div class="ticks">
                ${ticks.map(t => `<div class="tick">${escapeHtml(t)}</div>`).join("")}
              </div>
            </div>
          </div>

          <div class="gantt-grid">
            <div class="gantt-left"></div>
            <div class="gantt-right">
              ${showToday ? `<div class="todayLine" style="left:${(todayOffset * dayW) + (dayW/2)}px"></div>` : ``}
            </div>
          </div>

          <div class="gantt-rows">
            ${rowsHtml || `<div style="padding:14px 12px; color:var(--muted); font-weight:800;">Aucune t√¢che sur cette p√©riode.</div>`}
          </div>
        </div>
      `;

      attachGanttInteractions();
    }

    function attachGanttInteractions(){
      const ganttEl = document.getElementById("gantt");
      const token = getToken();
      if (!token) return;

      ganttEl.onmousemove = (e) => { if (e) moveTooltip(e); };

      ganttEl.onclick = (e) => {
        const actionEl = e.target.closest("[data-action='toggle-group']");
        if (actionEl) {
          const head = actionEl.closest(".group-head");
          const g = head?.getAttribute("data-group");
          if (g) {
            const collapsed = getCollapsed();
            if (collapsed.has(g)) collapsed.delete(g); else collapsed.add(g);
            setCollapsed(collapsed);
            renderGanttIfNeeded();
          }
          return;
        }

        const row = e.target.closest(".gantt-row");
        if (!row) return;
        const url = row.getAttribute("data-url");
        if (url) window.open(url, "_blank", "noopener,noreferrer");
      };

      ganttEl.onmouseleave = (e) => {
        if (e.target === ganttEl) hideTooltip();
      };

      ganttEl.onmouseover = async (e) => {
        const row = e.target.closest(".gantt-row");
        if (!row) return;

        const cardId = row.getAttribute("data-id");
        if (!cardId) return;

        const ev = calendar.getEventById(cardId);
        if (!ev) return;

        const tt = ensureTooltip();
        const listName = ev.extendedProps?.listName || "";

        tt.innerHTML = `
          <h4>${escapeHtml(ev.title)}</h4>
          <div class="meta">${escapeHtml(listName)}</div>
          <div class="meta">Chargement des checklists‚Ä¶</div>
        `;
        tt.style.display = "block";
        if (e) moveTooltip(e);

        try {
          if (!checklistCache.has(cardId)) checklistCache.set(cardId, { loaded: false, checklists: [] });
          const cached = checklistCache.get(cardId);

          if (!cached.loaded) {
            cached.checklists = await fetchCardChecklists(token, cardId);
            cached.loaded = true;
          }

          tt.innerHTML = `
            <h4>${escapeHtml(ev.title)}</h4>
            <div class="meta">${escapeHtml(listName)}</div>
            ${renderChecklistHtml(cached.checklists)}
          `;
        } catch (err) {
          tt.innerHTML = `
            <h4>${escapeHtml(ev.title)}</h4>
            <div class="meta">${escapeHtml(listName)}</div>
            <div class="error">Impossible de charger les checklists</div>
          `;
        }
      };
    }

    function syncGanttOptionsUI(){
      const mode = getViewMode();
      const opt = document.getElementById("ganttOptions");
      if (opt) opt.style.display = (mode === "gantt") ? "inline-flex" : "none";

      const groupBtn = document.getElementById("ganttGroupBtn");
      const z1 = document.getElementById("ganttZoom1Btn");
      const z3 = document.getElementById("ganttZoom3Btn");
      const z6 = document.getElementById("ganttZoom6Btn");

      const groupBy = getGroupByList();
      const z = getZoom();

      if (groupBtn) groupBtn.classList.toggle("active", groupBy);
      if (z1) z1.classList.toggle("active", z === "1");
      if (z3) z3.classList.toggle("active", z === "3");
      if (z6) z6.classList.toggle("active", z === "6");
    }

    function applyZoomView(){
      const z = getZoom();
      if (!calendar) return;
      if (z === "1") calendar.changeView("multiMonth1");
      else if (z === "6") calendar.changeView("multiMonth6");
      else calendar.changeView("multiMonthQuarter");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById("calendar");

      calendar = new FullCalendar.Calendar(el, {
        locale: "fr",
        firstDay: 1,
        height: "auto",

        initialView: "multiMonthQuarter",
        views: {
          multiMonthQuarter: { type: "multiMonth", duration: { months: 3 }, buttonText: "Trimestre" },
          multiMonth1: { type: "multiMonth", duration: { months: 1 }, buttonText: "1 mois" },
          multiMonth6: { type: "multiMonth", duration: { months: 6 }, buttonText: "6 mois" }
        },
        multiMonthMaxColumns: 3,
        showNonCurrentDates: false,
        fixedWeekCount: false,
        weekNumbers: true,

        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "multiMonthQuarter,dayGridMonth,timeGridWeek,listMonth"
        },

        dayMaxEvents: true,
        eventDisplay: "block",

        datesSet: () => {
          renderGanttIfNeeded();
        },

        eventClick(info) {
          info.jsEvent.preventDefault();
          if (info.event.url) window.open(info.event.url, "_blank", "noopener,noreferrer");
        },

        eventMouseEnter: async (info) => {
          const token = getToken();
          if (!token) return;

          const cardId = info.event.id;
          const tt = ensureTooltip();
          const listName = info.event.extendedProps.listName || "";

          tt.innerHTML = `
            <h4>${escapeHtml(info.event.title)}</h4>
            <div class="meta">${escapeHtml(listName)}</div>
            <div class="meta">Chargement des checklists‚Ä¶</div>
          `;
          tt.style.display = "block";
          if (info.jsEvent) moveTooltip(info.jsEvent);

          try {
            if (!checklistCache.has(cardId)) checklistCache.set(cardId, { loaded: false, checklists: [] });
            const cached = checklistCache.get(cardId);

            if (!cached.loaded) {
              cached.checklists = await fetchCardChecklists(token, cardId);
              cached.loaded = true;
            }

            tt.innerHTML = `
              <h4>${escapeHtml(info.event.title)}</h4>
              <div class="meta">${escapeHtml(listName)}</div>
              ${renderChecklistHtml(cached.checklists)}
            `;
          } catch (e) {
            tt.innerHTML = `
              <h4>${escapeHtml(info.event.title)}</h4>
              <div class="meta">${escapeHtml(listName)}</div>
              <div class="error">Impossible de charger les checklists</div>
            `;
          }
        },
        eventMouseLeave: hideTooltip,
        eventMouseMove: (info) => { if (info.jsEvent) moveTooltip(info.jsEvent); }
      });

      calendar.render();

      // Restore & apply zoom (affects gantt range too)
      applyZoomView();

      // Mode buttons
      const modeCalendarBtn = document.getElementById("modeCalendarBtn");
      const modeGanttBtn = document.getElementById("modeGanttBtn");

      function syncModeUI(){
        const mode = getViewMode();
        document.body.classList.toggle("ganttmode", mode === "gantt");
        modeCalendarBtn.classList.toggle("active", mode !== "gantt");
        modeGanttBtn.classList.toggle("active", mode === "gantt");
        syncGanttOptionsUI();
        renderGanttIfNeeded();
      }

      modeCalendarBtn.addEventListener("click", () => { setViewMode("calendar"); syncModeUI(); });
      modeGanttBtn.addEventListener("click", () => { setViewMode("gantt"); syncModeUI(); });

      // Search restore + debounce
      const searchInput = document.getElementById("searchInput");
      searchInput.value = getSearch();
      searchInput.addEventListener("input", () => {
        setSearch(searchInput.value);
        clearTimeout(window.__searchT);
        window.__searchT = setTimeout(() => applyFilter(), 120);
      });

      // Filter
      document.getElementById("labelFilter").addEventListener("change", applyFilter);

      document.getElementById("refreshBtn").addEventListener("click", () =>
        load().catch(err => { setError(err.message); setStatus(""); })
      );

      document.getElementById("logoutBtn").addEventListener("click", forgetToken);

      document.getElementById("saveTokenBtn").addEventListener("click", () => {
        const input = document.getElementById("tokenInput");
        const token = input.value.trim();
        if (!token) { setError("Token manquant."); return; }
        saveToken(token);
        input.value = "";
        load().catch(err => { setError(err.message); setStatus(""); });
      });

      document.getElementById("compactToggle").addEventListener("change", (e) => {
        document.body.classList.toggle("compact", !!e.target.checked);
        renderGanttIfNeeded();
      });

      // Gantt option buttons
      const ganttGroupBtn = document.getElementById("ganttGroupBtn");
      const z1 = document.getElementById("ganttZoom1Btn");
      const z3 = document.getElementById("ganttZoom3Btn");
      const z6 = document.getElementById("ganttZoom6Btn");

      function setZoomAndView(z){
        setZoom(z);
        applyZoomView();
        syncGanttOptionsUI();
        renderGanttIfNeeded();
      }

      ganttGroupBtn.addEventListener("click", () => {
        setGroupByList(!getGroupByList());
        syncGanttOptionsUI();
        renderGanttIfNeeded();
      });
      z1.addEventListener("click", () => setZoomAndView("1"));
      z3.addEventListener("click", () => setZoomAndView("3"));
      z6.addEventListener("click", () => setZoomAndView("6"));

      // On resize, keep gantt scale responsive
      window.addEventListener("resize", () => {
        clearTimeout(window.__ganttResizeT);
        window.__ganttResizeT = setTimeout(() => renderGanttIfNeeded(), 120);
      });

      // Restore mode + options
      syncGanttOptionsUI();
      syncModeUI();

      load().catch(err => { setError(err.message); setStatus(""); });
    });
  </script>
</body>
</html>
