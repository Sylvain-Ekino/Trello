<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trello Gantt</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

<style>
:root{
  --bg:#f6f7fb; --border:#e5e7eb; --muted:#64748b;
  --left:320px; /* un peu plus large pour afficher sous-tÃ¢ches + date limite */
  --row:28px;   /* hauteur de ligne carte */
  --subrow:24px;/* hauteur de ligne sous-tÃ¢che */
  --padY:6px;
  --barH:14px;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:#0f172a}
.container{
  width:100%;
  max-width:none;      /* âœ… 100% largeur navigateur */
  margin:0;            /* âœ… plus de centrage 1280px */
  padding:0 10px;
}

.topbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
.controls{display:flex;gap:6px;flex-wrap:wrap;padding:6px 0;align-items:center}

.chip,.seg,.btn,.token{
  border:1px solid var(--border);
  background:#fff;border-radius:999px;padding:4px 6px;font-weight:800;
}
.chip{display:inline-flex;gap:6px;align-items:center;position:relative}
.chip strong{font-size:11px;color:var(--muted);font-weight:900}
.chip input,.token input{border:0;outline:0;background:transparent;font-weight:900;font-size:12px}

.seg{display:inline-flex;gap:2px;padding:2px}
.seg button{border:0;background:none;font-weight:900;opacity:.4;cursor:pointer}
.seg button.active{opacity:1}

.btn{cursor:pointer}
.token{display:flex;gap:4px}

.panel{margin-top:6px;border:1px solid var(--border);border-radius:12px;background:#fff;overflow:hidden}

#calendar{padding:4px 6px;border-bottom:1px solid var(--border)}
.fc .fc-view-harness{display:none}
.fc .fc-toolbar-title{font-size:13px;font-weight:900}
.fc .fc-button{padding:4px 6px!important;font-size:11px!important}

#gantt{padding:6px}
.shell{border:1px solid var(--border);border-radius:12px;overflow:hidden}
.head{display:grid;grid-template-columns:var(--left) 1fr;border-bottom:1px solid var(--border)}
.hl{border-right:1px solid var(--border);padding:4px 6px;font-size:10px;font-weight:900;color:var(--muted)}
.hr{padding:4px 6px;overflow:hidden}
.ticks{display:flex}
.tick{width:var(--week);font-size:10px;font-weight:900;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.scroll{display:grid;grid-template-columns:var(--left) 1fr;max-height:75vh}
.left{border-right:1px solid var(--border);overflow:auto}
.right{position:relative;overflow:auto;
  background:repeating-linear-gradient(to right,#0001 0,#0001 1px,transparent 1px,transparent var(--day))}
.right::before{
  content:"";position:absolute;inset:0;
  background:repeating-linear-gradient(
    to right,
    transparent 0,
    transparent calc(var(--week)-1px),
    #0002 calc(var(--week)-1px),
    #0002 var(--week)
  );
  pointer-events:none;
}

/* âœ… Ligne verticale "Aujourd'hui" */
.todayline{
  position:absolute;
  top:0; bottom:0;
  width:2px;
  background:#ef4444;
  opacity:.65;
  pointer-events:none;
  z-index:5;
}
.todayline::after{
  content:"Aujourdâ€™hui";
  position:absolute;
  top:6px;
  left:6px;
  font-size:10px;
  font-weight:900;
  color:#ef4444;
  background:#fff;
  border:1px solid rgba(239,68,68,.25);
  padding:2px 6px;
  border-radius:999px;
  box-shadow:0 12px 30px rgba(2,6,23,.10);
  white-space:nowrap;
}

.rowL, .rowR{
  border-bottom:1px solid var(--border);
}
.rowL{
  display:flex;align-items:center;gap:8px;
  padding:0 8px;
  height:var(--row);
  cursor:pointer;
  user-select:none;
}
.rowL:hover{background:#f8fafc}
.rowL .chev{width:14px;opacity:.55;font-weight:900}
.rowL .title{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:900;
}
.rowL .due{
  flex:0 0 auto;
  font-size:11px;font-weight:900;color:var(--muted);
}

.subL{
  display:flex;align-items:center;gap:8px;
  padding:0 8px 0 28px; /* indentation */
  height:var(--subrow);
  cursor:pointer;
  user-select:none;
}
.subL:hover{background:#f8fafc}
.subL .dot{
  width:8px;height:8px;border-radius:2px;transform:rotate(45deg);
  border:1px solid rgba(15,23,42,.10);
}
.subL .stitle{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:800;
}
.subL .sdue{
  flex:0 0 auto;
  font-size:11px;font-weight:900;color:var(--muted);
}

.rowR{
  height:var(--row);
  position:relative;
}
.subR{
  height:var(--subrow);
  position:relative;
}

.bar{
  position:absolute;
  height:var(--barH);
  border-radius:8px;
  padding:0 6px;
  font-size:11px;font-weight:900;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  cursor:pointer;
  top:50%;
  transform:translateY(-50%);
  box-shadow:0 10px 18px rgba(2,6,23,.10);
  border:1px solid rgba(15,23,42,.10);
}
.milestone{
  position:absolute;width:10px;height:10px;
  transform:translate(-50%,-50%) rotate(45deg);
  border-radius:2px;cursor:pointer;
  top:50%;
  box-shadow:0 10px 18px rgba(2,6,23,.10);
  border:1px solid rgba(15,23,42,.10);
}

/* Dropdown tags (checkbox list) */
.ddbtn{
  border:0;background:transparent;
  font-weight:900;font-size:12px;padding:0;
  cursor:pointer;display:inline-flex;align-items:center;gap:6px;
  max-width: 220px;
}
.ddbtn .lbl{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ddbtn .caret{opacity:.6;font-size:11px}
.dd{
  position:absolute;top: calc(100% + 6px);left:0;
  min-width: 260px;
  max-width: min(360px, calc(100vw - 22px));
  background:#fff;border:1px solid var(--border);border-radius:12px;
  box-shadow: 0 18px 45px rgba(2,6,23,.14);
  padding:6px;display:none;z-index:999;
}
.dd.open{display:block}
.dd .search{
  width:100%;border:1px solid var(--border);
  border-radius:10px;padding:8px 10px;
  font-weight:900;font-size:12px;outline:none;margin:6px 0 4px;
}
.dd .row{
  display:flex;align-items:center;gap:10px;
  padding:8px 8px;border-radius:10px;
}
.dd .row:hover{background:#f8fafc}
.dd input[type="checkbox"]{width:16px;height:16px}
.dd .name{
  font-weight:900;font-size:12px;min-width:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.dd .dotc{
  width:10px;height:10px;border-radius:999px;flex:0 0 auto;
  border:1px solid rgba(15,23,42,.10);
}
.dd .actions{
  display:flex;gap:6px;padding:6px 6px 4px;
  border-top:1px solid var(--border);margin-top:6px;
}
.dd .mini{
  border:1px solid var(--border);background:#fff;border-radius:10px;
  padding:6px 8px;font-weight:900;font-size:12px;cursor:pointer;
}

@media (max-width: 760px){
  :root{ --left: 240px; }
}
@media (max-width: 520px){
  :root{ --left: 190px; }
  .rowL .due, .subL .sdue{display:none;}
}

/* Tooltip */
.tt{
  position:fixed;z-index:999;
  background:#fff;border:1px solid var(--border);
  border-radius:10px;padding:8px;font-size:12px;
  box-shadow:0 20px 50px rgba(2,6,23,.18);
  max-width:420px;pointer-events:none;
  display:none;
}
.tt h4{margin:0 0 4px;font-size:12px}
.tt .meta{color:var(--muted);font-weight:900;margin-bottom:6px}
.tt ul{margin:0;padding-left:16px}
.tt .done{text-decoration:line-through;color:var(--muted)}
</style>
</head>

<body>
<div class="topbar">
  <div class="container">
    <div class="controls">
      <div class="chip" id="tagsChip">
        <strong>Tags</strong>
        <button class="ddbtn" id="tagsBtn" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="lbl" id="tagsBtnLabel">Tous</span>
          <span class="caret">â–¾</span>
        </button>
        <div class="dd" id="tagsDropdown" role="menu" aria-label="Tags">
          <input class="search" id="tagsSearch" placeholder="Filtrer tagsâ€¦" />
          <div id="tagsList"></div>
          <div class="actions">
            <button class="mini" id="tagsAll" type="button">Tous</button>
            <button class="mini" id="tagsNone" type="button">Aucun</button>
          </div>
        </div>
      </div>

      <div class="chip">
        <strong>Recherche</strong>
        <input id="searchInput"/>
      </div>

      <div class="seg">
        <button id="z1">1M</button>
        <button id="z3" class="active">3M</button>
        <button id="z6">6M</button>
      </div>

      <button class="btn" id="refresh">â†»</button>
      <button class="btn" id="logout">âœ•</button>

      <div class="token">
        <input id="tokenInput" type="password" placeholder="Token"/>
        <button class="btn" id="saveToken">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="panel">
    <div id="calendar"></div>
    <div id="gantt"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const TRELLO={key:"ec995ad68de9cdaafd64b131e5fa00ec",boardId:"6490c5416cea9255ba3b0383"};
const DONE=new Set(["ðŸŽ‰ TerminÃ©"]);
const COLORS={
  green:"#22c55e",yellow:"#eab308",orange:"#f97316",red:"#ef4444",
  purple:"#a855f7",blue:"#3b82f6",sky:"#0ea5e9",
  lime:"#84cc16",pink:"#ec4899",black:"#111827"
};
const API="https://api.trello.com/1";

let calendar;
let allCards=[];      // source cards (already excluding ðŸŽ‰ TerminÃ© + no dates)
let filteredCards=[]; // after tag/search filters
let listNames=new Map();
let doneListIds=new Set();

let allTags=[];              // {name,color,hex} sorted
let selectedTags=new Set();  // by name
const TAGS_KEY="tc_selected_tags";
const EXPAND_KEY="tc_expanded_cards";

let expandedCards=new Set(); // cardId
const checklistCache=new Map(); // cardId -> {loaded, checklists}

/* ================= HELPERS ================= */
const qs=o=>new URLSearchParams(o).toString();
const token=()=>localStorage.getItem("trello_token");
const day=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x};
const diffDays=(a,b)=>Math.round((day(b)-day(a))/86400000);
const esc=s=>String(s).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m]));
function fmtDue(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  return new Intl.DateTimeFormat("fr",{day:"2-digit",month:"short"}).format(d);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

/* ================= ZOOM BUTTONS ACTIVE STATE ================= */
function setZoomActive(viewType){
  const map = { multiMonth1:"z1", multiMonthQuarter:"z3", multiMonth6:"z6" };
  const activeId = map[viewType] || "z3";
  ["z1","z3","z6"].forEach(id=>{
    const b=document.getElementById(id);
    if(!b) return;
    b.classList.toggle("active", id===activeId);
  });
}

/* ================= TOOLTIP (checklists) ================= */
let ttEl=null;
function ensureTT(){
  if(ttEl) return ttEl;
  ttEl=document.createElement("div");
  ttEl.className="tt";
  document.body.appendChild(ttEl);
  return ttEl;
}
function moveTT(e){
  if(!ttEl || ttEl.style.display==="none") return;
  const pad=12;
  let x=e.clientX+pad, y=e.clientY+pad;
  const r=ttEl.getBoundingClientRect();
  const vw=window.innerWidth, vh=window.innerHeight;
  if(x+r.width+pad>vw) x=vw-r.width-pad;
  if(y+r.height+pad>vh) y=vh-r.height-pad;
  ttEl.style.left=x+"px"; ttEl.style.top=y+"px";
}
function hideTT(){ if(ttEl){ ttEl.style.display="none"; ttEl.innerHTML=""; } }

async function fetchCardChecklists(cardId){
  const url = `${API}/cards/${encodeURIComponent(cardId)}/checklists?` + qs({key:TRELLO.key, token:token()});
  const res = await fetch(url);
  if(!res.ok) throw new Error("Checklist fetch failed");
  return res.json();
}
function renderChecklistHtml(checklists){
  if(!checklists || checklists.length===0) return `<div class="meta">Aucune checklist</div>`;
  const maxLists=2, maxItems=10;
  let html="";
  for(const cl of checklists.slice(0,maxLists)){
    const items=(cl.checkItems||[]);
    const done=items.filter(i=>i.state==="complete").length;
    html += `<div class="meta"><strong>${esc(cl.name)}</strong> â€” ${done}/${items.length}</div>`;
    html += "<ul>";
    for(const it of items.slice(0,maxItems)){
      const isDone=it.state==="complete";
      html += `<li class="${isDone?"done":""}">${esc(it.name)}</li>`;
    }
    if(items.length>maxItems) html += `<li class="meta">+${items.length-maxItems}â€¦</li>`;
    html += "</ul>";
  }
  return html;
}

/* ================= TAGS (Aâ†’Z) ================= */
function rebuildTagsModel(){
  const map=new Map(); // name -> {name,color,hex}
  for(const c of allCards){
    for(const l of c.labels){
      const name=(l.name||"").trim();
      if(!name) continue;
      if(!map.has(name)){
        const hex = l.color ? (COLORS[l.color] || null) : null;
        map.set(name,{name,color:l.color||null,hex});
      }else{
        const cur=map.get(name);
        if(!cur.color && l.color){
          cur.color=l.color;
          cur.hex=COLORS[l.color] || cur.hex;
        }
      }
    }
  }
  allTags=[...map.values()].sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}));
}
function restoreSelectedTags(){
  selectedTags=new Set();
  try{
    const raw=localStorage.getItem(TAGS_KEY);
    const arr=raw?JSON.parse(raw):[];
    for(const t of arr){
      if(allTags.some(x=>x.name===t)) selectedTags.add(t);
    }
  }catch{}
}
function persistSelectedTags(){
  localStorage.setItem(TAGS_KEY, JSON.stringify([...selectedTags]));
}
function setTagsBtnLabel(){
  const el=document.getElementById("tagsBtnLabel");
  const n=selectedTags.size;
  if(n===0) el.textContent="Tous";
  else if(n===1) el.textContent=[...selectedTags][0];
  else el.textContent=`${n} tags`;
}
function renderTagsDropdown(){
  const listEl=document.getElementById("tagsList");
  const q=(document.getElementById("tagsSearch").value||"").trim().toLowerCase();
  listEl.innerHTML="";

  for(const t of allTags){
    if(q && !t.name.toLowerCase().includes(q)) continue;

    const id="tag_" + btoa(unescape(encodeURIComponent(t.name))).replaceAll("=","");
    const checked=selectedTags.has(t.name);

    const row=document.createElement("label");
    row.className="row";
    row.setAttribute("for", id);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.id=id;
    cb.checked=checked;
    cb.addEventListener("change", ()=>{
      if(cb.checked) selectedTags.add(t.name);
      else selectedTags.delete(t.name);
      persistSelectedTags();
      setTagsBtnLabel();
      applyFilters();
    });

    const dot=document.createElement("span");
    dot.className="dotc";
    dot.style.background = t.hex || "#e2e8f0";

    const name=document.createElement("div");
    name.className="name";
    name.textContent=t.name;

    row.appendChild(cb);
    row.appendChild(dot);
    row.appendChild(name);
    listEl.appendChild(row);
  }

  setTagsBtnLabel();
}
function openTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.add("open");
  document.getElementById("tagsBtn").setAttribute("aria-expanded","true");
  setTimeout(()=>document.getElementById("tagsSearch").focus(), 0);
}
function closeTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.remove("open");
  document.getElementById("tagsBtn").setAttribute("aria-expanded","false");
}
function toggleTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.contains("open") ? closeTags() : openTags();
}

/* ================= EXPAND STATE ================= */
function restoreExpanded(){
  expandedCards=new Set();
  try{
    const raw=localStorage.getItem(EXPAND_KEY);
    const arr=raw?JSON.parse(raw):[];
    for(const id of arr) expandedCards.add(id);
  }catch{}
}
function persistExpanded(){
  localStorage.setItem(EXPAND_KEY, JSON.stringify([...expandedCards]));
}

/* ================= LOAD ================= */
async function fetchBoardLists(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/lists?` + qs({
    key:TRELLO.key, token:token(), fields:"name", filter:"open"
  });
  const res = await fetch(url);
  if(!res.ok) throw new Error("Lists fetch failed");
  return res.json();
}
async function fetchBoardCards(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/cards?` + qs({
    key:TRELLO.key, token:token(), fields:"name,start,due,idList,labels,url", filter:"open"
  });
  const res = await fetch(url);
  if(!res.ok) throw new Error("Cards fetch failed");
  return res.json();
}

async function load(){
  if(!token()){ renderGantt([]); return; }

  const [lists,cards]=await Promise.all([fetchBoardLists(), fetchBoardCards()]);

  listNames=new Map(lists.map(l=>[l.id,l.name]));
  doneListIds=new Set(lists.filter(l=>DONE.has(l.name)).map(l=>l.id));

  allCards = cards.map(c=>{
    if(doneListIds.has(c.idList)) return null;
    if(!c.start && !c.due) return null;

    const start=c.start||c.due;
    const end=(c.start && c.due)
      ? new Date(new Date(c.due).getTime()+86400000).toISOString()
      : undefined;

    const labels=(c.labels||[]).map(l=>({name:l.name||"", color:l.color||null}));
    const firstColored=labels.find(l=>l.color)?.color;
    const baseColor=COLORS[firstColored] || "#475569";

    return {
      id:c.id,
      title:c.name,
      start,
      end,
      due:c.due || null,
      url:c.url,
      list:listNames.get(c.idList)||"",
      labels,
      baseColor
    };
  }).filter(Boolean);

  rebuildTagsModel();
  restoreSelectedTags();
  renderTagsDropdown();

  restoreExpanded();
  applyFilters();
}

/* ================= FILTERS ================= */
function applyFilters(){
  const q=(document.getElementById("searchInput").value||"").trim().toLowerCase();
  const selected=[...selectedTags];

  filteredCards = allCards.filter(c=>{
    const tagOK = selected.length===0 || c.labels.some(l=>selected.includes((l.name||"").trim()));
    const textOK = !q || c.title.toLowerCase().includes(q) || c.list.toLowerCase().includes(q);
    return tagOK && textOK;
  });

  // couleur homogÃ¨ne si 1 seul tag cochÃ©
  if(selected.length===1){
    const tag=selected[0];
    const info=allTags.find(t=>t.name===tag);
    if(info?.hex){
      filteredCards = filteredCards.map(c=>({ ...c, baseColor: info.hex }));
    }
  }

  calendar.removeAllEvents();
  calendar.addEventSource(filteredCards.map(c=>({
    id:c.id, title:c.title, start:c.start, end:c.end || undefined, allDay:true,
    url:c.url,
    backgroundColor:c.baseColor, borderColor:c.baseColor, textColor:"#fff",
    extendedProps:{ listName:c.list }
  })));

  renderGantt(filteredCards);
}

/* ================= GANTT RENDER (cards + subtasks) ================= */
function computeDayWidth(totalDays){
  const usable = Math.max(
    320,
    window.innerWidth - (parseInt(getComputedStyle(document.documentElement).getPropertyValue("--left")) || 320) - 60
  );
  const base = Math.floor(usable / Math.max(20, totalDays));
  return clamp(base, 10, 24);
}

function getViewRange(){
  const v=calendar.view;
  const rangeStart=day(v.currentStart);
  const rangeEnd=day(v.currentEnd); // exclusive
  const totalDays=Math.max(1, diffDays(rangeStart, rangeEnd));
  return { rangeStart, rangeEnd, totalDays };
}

function subTasksFromChecklists(cardId, checklists){
  // Trello checkItems can have `due` (ISO). We only display items with due.
  // We also exclude completed checkItems to respect "no completed tasks" spirit.
  const items=[];
  for(const cl of (checklists||[])){
    for(const it of (cl.checkItems||[])){
      if(it.state === "complete") continue;
      if(!it.due) continue;
      items.push({
        id: `${cardId}::${it.id}`,
        cardId,
        title: it.name || "(sans nom)",
        due: it.due,
        checklistName: cl.name || "",
      });
    }
  }
  // sort by due
  items.sort((a,b)=>new Date(a.due)-new Date(b.due));
  return items;
}

function renderGantt(cards){
  const g=document.getElementById("gantt");
  if(!cards.length){ g.innerHTML=""; return; }

  const { rangeStart, rangeEnd, totalDays } = getViewRange();
  const dayW = computeDayWidth(totalDays);
  const weekW = dayW * 7;
  document.documentElement.style.setProperty("--day", dayW + "px");
  document.documentElement.style.setProperty("--week", weekW + "px");

  const milestoneLabel = "milestones";
  const milestoneCards = cards.filter(c=>c.labels.some(l=>(l.name||"").trim().toLowerCase()===milestoneLabel));
  const regularCards = cards.filter(c=>!c.labels.some(l=>(l.name||"").trim().toLowerCase()===milestoneLabel));

  // group by list (still compact)
  const byList=new Map();
  for(const c of regularCards){
    if(!byList.has(c.list)) byList.set(c.list, []);
    byList.get(c.list).push(c);
  }
  const listOrder=[...byList.keys()].sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
  for(const k of listOrder){
    byList.get(k).sort((a,b)=>new Date(a.start)-new Date(b.start));
  }

  // build rows
  let leftHtml="";
  let rightHtml="";
  const minWidth = totalDays * dayW;

  // helper to position date -> x
  function xForDate(iso){
    const d=day(new Date(iso));
    const idx=diffDays(rangeStart, d);
    return clamp(idx, 0, totalDays-1) * dayW;
  }

  // âœ… Today line (only if inside current range)
  const today = day(new Date());
  let todayLine = "";
  if(today >= rangeStart && today < rangeEnd){
    const idx = diffDays(rangeStart, today);
    const tx = (idx * dayW) + (dayW / 2);
    todayLine = `<div class="todayline" style="left:${tx}px"></div>`;
  }

  if(milestoneCards.length){
    milestoneCards.sort((a,b)=>new Date(a.start)-new Date(b.start));
    leftHtml += `<div class="rowL" style="cursor:default; background:#fff;">
      <div class="chev"></div>
      <div class="title" style="font-size:11px; color:var(--muted);">Milestones (${milestoneCards.length})</div>
      <div class="due"></div>
    </div>`;

    let barsHtml="";
    for(const c of milestoneCards){
      const sx = xForDate(c.start);
      let ex = sx;
      let w = dayW;

      if(c.end){
        const endInc = new Date(day(new Date(c.end)).getTime() - 86400000);
        const eIdx = diffDays(rangeStart, endInc);
        ex = clamp(eIdx, 0, totalDays-1) * dayW;
        w = Math.max(dayW, (ex - sx + dayW));
      }

      const barEl = c.end
        ? `<div class="bar" data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}"
              style="left:${sx}px;width:${w}px;background:${c.baseColor};color:#fff;border-color:${c.baseColor};"
              title="${esc(c.title)}">${esc(c.title)}</div>`
        : `<div class="milestone" data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}"
              style="left:${sx + (dayW/2)}px;background:${c.baseColor};"
              title="${esc(c.title)}"></div>`;

      barsHtml += barEl;
    }

    rightHtml += `<div class="rowR">${barsHtml}</div>`;
  }

  for(const listName of listOrder){
    // tiny list separator row (minimal, still useful)
    leftHtml += `<div class="rowL" style="height:22px; cursor:default; background:#fff;">
      <div class="chev"></div><div class="title" style="font-size:11px; color:var(--muted);">${esc(listName)}</div><div class="due"></div>
    </div>`;
    rightHtml += `<div class="rowR" style="height:22px;"></div>`;

    for(const c of byList.get(listName)){
      const expanded = expandedCards.has(c.id);
      const chev = expanded ? "â–¾" : "â–¸";
      const dueTxt = fmtDue(c.due);

      leftHtml += `
        <div class="rowL" data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}" title="Clic: sous-tÃ¢ches â€¢ Ctrl/Cmd+clic: ouvrir Trello">
          <div class="chev">${chev}</div>
          <div class="title">${esc(c.title)}</div>
          <div class="due">${esc(dueTxt)}</div>
        </div>
      `;

      const sx = xForDate(c.start);
      let ex = sx;
      let w = dayW;

      if(c.end){
        const endInc = new Date(day(new Date(c.end)).getTime() - 86400000);
        const eIdx = diffDays(rangeStart, endInc);
        ex = clamp(eIdx, 0, totalDays-1) * dayW;
        w = Math.max(dayW, (ex - sx + dayW));
      }

      const barEl = c.end
        ? `<div class="bar" data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}"
              style="left:${sx}px;width:${w}px;background:${c.baseColor};color:#fff;border-color:${c.baseColor};"
              title="${esc(c.title)}">${esc(c.title)}</div>`
        : `<div class="milestone" data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}"
              style="left:${sx + (dayW/2)}px;background:${c.baseColor};"
              title="${esc(c.title)}"></div>`;

      rightHtml += `<div class="rowR">${barEl}</div>`;

      // subtasks rows
      if(expanded){
        const cached = checklistCache.get(c.id);
        const subtasks = cached?.loaded ? subTasksFromChecklists(c.id, cached.checklists) : [];

        if(!cached || !cached.loaded){
          leftHtml += `<div class="subL" data-kind="sub" data-card="${esc(c.id)}"><span class="dot" style="background:#cbd5e1"></span><div class="stitle">â€¦</div><div class="sdue"></div></div>`;
          rightHtml += `<div class="subR"></div>`;
        } else if(subtasks.length === 0){
          leftHtml += `<div class="subL" data-kind="sub" data-card="${esc(c.id)}"><span class="dot" style="background:#cbd5e1"></span><div class="stitle">(aucune sous-tÃ¢che datÃ©e)</div><div class="sdue"></div></div>`;
          rightHtml += `<div class="subR"></div>`;
        } else {
          for(const st of subtasks){
            const dx = xForDate(st.due);
            const dueLabel = fmtDue(st.due);

            leftHtml += `
              <div class="subL" data-kind="sub" data-card="${esc(c.id)}" data-sub="${esc(st.id)}" title="${esc(st.checklistName)}">
                <span class="dot" style="background:${c.baseColor}"></span>
                <div class="stitle">${esc(st.title)}</div>
                <div class="sdue">${esc(dueLabel)}</div>
              </div>
            `;
            rightHtml += `
              <div class="subR">
                <div class="milestone" data-kind="sub" data-card="${esc(c.id)}" data-sub="${esc(st.id)}"
                  style="left:${dx + (dayW/2)}px;background:${c.baseColor};"
                  title="${esc(st.title)}"></div>
              </div>
            `;
          }
        }
      }
    }
  }

  g.innerHTML = `
    <div class="shell">
      <div class="head">
        <div class="hl"></div>
        <div class="hr">
          <div class="ticks">
            ${Array.from({length:Math.max(1,(totalDays/7|0))}).map((_,i)=>`<div class="tick">S${i+1}</div>`).join("")}
          </div>
        </div>
      </div>

      <div class="scroll">
        <div class="left" id="gLeft">${leftHtml}</div>
        <div class="right" id="gRight">
          <div style="position:relative;min-width:${minWidth}px">
            ${todayLine}
            ${rightHtml}
          </div>
        </div>
      </div>
    </div>
  `;

  // sync vertical scroll
  const L=document.getElementById("gLeft");
  const R=document.getElementById("gRight");
  let syncing=false;
  const sync = (from, to) => () => {
    if(syncing) return;
    syncing=true;
    to.scrollTop = from.scrollTop;
    syncing=false;
  };
  L.addEventListener("scroll", sync(L,R), {passive:true});
  R.addEventListener("scroll", sync(R,L), {passive:true});

  bindGanttInteractions();
}

/* ================= INTERACTIONS ================= */
function bindGanttInteractions(){
  const root=document.getElementById("gantt");
  root.onmousemove = (e)=>moveTT(e);

  root.onclick = async (e)=>{
    const el = e.target.closest("[data-kind]");
    if(!el) return;

    const kind = el.getAttribute("data-kind");
    const cardId = el.getAttribute("data-card");

    // Ctrl/Cmd click => open Trello
    const isOpenShortcut = e.ctrlKey || e.metaKey;
    const url = el.getAttribute("data-url");

    if(isOpenShortcut && url){
      window.open(url,"_blank","noopener,noreferrer");
      return;
    }

    // Click on card toggles expand/collapse (not open)
    if(kind === "card" && cardId){
      if(expandedCards.has(cardId)) expandedCards.delete(cardId);
      else expandedCards.add(cardId);
      persistExpanded();

      // if expanding, lazy-load checklists then re-render
      if(expandedCards.has(cardId)){
        if(!checklistCache.has(cardId)) checklistCache.set(cardId,{loaded:false,checklists:[]});
        const cached = checklistCache.get(cardId);
        if(!cached.loaded){
          try{
            cached.checklists = await fetchCardChecklists(cardId);
            cached.loaded = true;
          }catch{
            cached.checklists = [];
            cached.loaded = true;
          }
        }
      }

      renderGantt(filteredCards);
      return;
    }
  };

  // Tooltip hover: show card checklists on card bars; show subtask info on sub milestones
  root.onmouseover = async (e)=>{
    const el = e.target.closest("[data-kind]");
    if(!el) return;

    const kind = el.getAttribute("data-kind");
    const cardId = el.getAttribute("data-card");
    if(!cardId || !token()) return;

    const tt=ensureTT();
    tt.style.display="block";
    moveTT(e);

    // find card data
    const card = allCards.find(c=>c.id===cardId);
    const title = card?.title || "";
    const listName = card?.list || "";

    if(kind === "sub"){
      // Subtask: show its title + due
      const subId = el.getAttribute("data-sub") || "";
      const cached = checklistCache.get(cardId);
      const subtasks = cached?.loaded ? subTasksFromChecklists(cardId, cached.checklists) : [];
      const st = subtasks.find(x=>x.id===subId);
      tt.innerHTML = `<h4>${esc(st?.title || title)}</h4><div class="meta">${esc(fmtDue(st?.due || ""))}</div><div class="meta">${esc(st?.checklistName || "")}</div>`;
      return;
    }

    // Card hover: show checklists (lazy+cache)
    tt.innerHTML = `<h4>${esc(title)}</h4><div class="meta">${esc(listName)}</div><div class="meta">Chargementâ€¦</div>`;
    try{
      if(!checklistCache.has(cardId)) checklistCache.set(cardId,{loaded:false,checklists:[]});
      const cached = checklistCache.get(cardId);
      if(!cached.loaded){
        cached.checklists = await fetchCardChecklists(cardId);
        cached.loaded = true;
      }
      tt.innerHTML = `<h4>${esc(title)}</h4><div class="meta">${esc(listName)}</div>${renderChecklistHtml(cached.checklists)}`;
    }catch{
      tt.innerHTML = `<h4>${esc(title)}</h4><div class="meta">${esc(listName)}</div><div class="meta">Erreur</div>`;
    }
  };

  root.onmouseleave = ()=>hideTT();
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded",()=>{
  calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale:"fr",
    initialView:"multiMonthQuarter",
    views:{
      multiMonthQuarter:{type:"multiMonth",duration:{months:3}},
      multiMonth1:{type:"multiMonth",duration:{months:1}},
      multiMonth6:{type:"multiMonth",duration:{months:6}}
    },
    headerToolbar:{left:"prev,next today",center:"title",right:""},
    datesSet:()=>{
      setZoomActive(calendar.view.type);
      applyFilters();
    }
  });
  calendar.render();

  // zoom buttons
  document.getElementById("z1").onclick=()=>{
    calendar.changeView("multiMonth1");
    setZoomActive("multiMonth1");
  };
  document.getElementById("z3").onclick=()=>{
    calendar.changeView("multiMonthQuarter");
    setZoomActive("multiMonthQuarter");
  };
  document.getElementById("z6").onclick=()=>{
    calendar.changeView("multiMonth6");
    setZoomActive("multiMonth6");
  };

  // search
  document.getElementById("searchInput").addEventListener("input", ()=>{
    clearTimeout(window.__qT);
    window.__qT=setTimeout(applyFilters, 80);
  });

  // token actions
  document.getElementById("refresh").onclick=()=>load();
  document.getElementById("logout").onclick=()=>{localStorage.removeItem("trello_token"); renderGantt([]);};
  document.getElementById("saveToken").onclick=()=>{
    localStorage.setItem("trello_token", (document.getElementById("tokenInput").value||"").trim());
    document.getElementById("tokenInput").value="";
    load();
  };

  // tags dropdown
  const btn=document.getElementById("tagsBtn");
  const dd=document.getElementById("tagsDropdown");
  btn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleTags(); });
  dd.addEventListener("click", (e)=>e.stopPropagation());
  document.getElementById("tagsSearch").addEventListener("input", ()=>renderTagsDropdown());
  document.getElementById("tagsAll").addEventListener("click", ()=>{
    selectedTags = new Set(allTags.map(t=>t.name));
    persistSelectedTags();
    renderTagsDropdown();
    applyFilters();
  });
  document.getElementById("tagsNone").addEventListener("click", ()=>{
    selectedTags.clear();
    persistSelectedTags();
    renderTagsDropdown();
    applyFilters();
  });
  document.addEventListener("click", ()=>closeTags());
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeTags(); });

  // responsive
  window.addEventListener("resize", ()=>{ clearTimeout(window.__rT); window.__rT=setTimeout(()=>renderGantt(filteredCards), 120); });

  // restore persisted
  restoreExpanded();
  restoreSelectedTags();
  setTagsBtnLabel();
  setZoomActive("multiMonthQuarter");

  load();
});
</script>
</body>
</html>
