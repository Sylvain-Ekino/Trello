<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Roadmap Volkswagen</title>

<!-- Favicon (SVG inline) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='24' fill='%231f2937'/%3E%3Cpath d='M26 28l16 44h6l12-30 12 30h6l16-44h-7L74 62 62 32h-4L46 62 33 28h-7z' fill='%23fff'/%3E%3C/svg%3E"/>

<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/multimonth@6.1.15/index.global.min.css">

<style>
:root{
  --bg:#0b1220;
  --panel:#0f1a2e;
  --panel2:#0c1628;
  --muted:#9aa7bd;
  --text:#e7eefc;
  --border:rgba(255,255,255,.08);
  --shadow: 0 12px 30px rgba(0,0,0,.35);
  --radius:18px;
  --radius2:14px;
  --accent:#60a5fa;
  --danger:#fb7185;
  --warn:#fbbf24;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
  background: radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.18), transparent 60%),
              radial-gradient(900px 600px at 90% 10%, rgba(251,113,133,.12), transparent 55%),
              radial-gradient(900px 700px at 40% 110%, rgba(34,197,94,.10), transparent 55%),
              var(--bg);
  color:var(--text);
  overflow:hidden;
}

a{color:inherit}
button{font:inherit}

.app{
  height:100%;
  display:flex;
  flex-direction:column;
  padding:14px;
  gap:12px;
}

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo{
  width:38px;height:38px;border-radius:14px;
  background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(251,113,133,.85));
  box-shadow: var(--shadow);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
}
.brand h1{
  margin:0;
  font-size:18px;
  letter-spacing:.2px;
}
.brand .sub{
  color:var(--muted);
  font-size:12px;
  margin-top:2px;
}

.controls{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.chip{
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  border-radius: 999px;
  padding:8px 12px;
  display:flex;
  align-items:center;
  gap:8px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
.chip .dot{
  width:8px;height:8px;border-radius:50%;
  background: var(--accent);
  box-shadow: 0 0 0 3px rgba(96,165,250,.18);
}
.chip small{color:var(--muted)}
.chip b{font-weight:800}

.btn{
  border:1px solid var(--border);
  background: rgba(255,255,255,.04);
  color:var(--text);
  border-radius: 14px;
  padding:9px 12px;
  cursor:pointer;
  box-shadow: 0 10px 22px rgba(0,0,0,.22);
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.btn:hover{background: rgba(255,255,255,.06)}
.btn:active{transform: translateY(1px)}
.btn.primary{
  border-color: rgba(96,165,250,.35);
  background: rgba(96,165,250,.16);
}
.btn.danger{
  border-color: rgba(251,113,133,.35);
  background: rgba(251,113,133,.12);
}
.btn.ghost{
  background: transparent;
  box-shadow:none;
}
.btn:disabled{opacity:.55;cursor:not-allowed}

.segment{
  display:flex;
  border:1px solid var(--border);
  border-radius: 14px;
  overflow:hidden;
  background: rgba(255,255,255,.03);
}
.segment button{
  border:0;
  background: transparent;
  color: var(--muted);
  padding:9px 12px;
  cursor:pointer;
}
.segment button.active{
  color: var(--text);
  background: rgba(255,255,255,.06);
}

.main{
  flex:1;
  display:grid;
  grid-template-columns: 1fr;
  gap:12px;
  min-height:0;
}

.panel{
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  min-height:0;
  overflow:hidden;
}

.panelHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  background: rgba(0,0,0,.12);
}
.panelHeader h2{
  margin:0;
  font-size:13px;
  letter-spacing:.25px;
  text-transform:uppercase;
  color: rgba(231,238,252,.92);
}
.panelHeader .right{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

#calendar{
  height:100%;
  min-height:0;
  padding:10px;
}

.fc{
  --fc-border-color: rgba(255,255,255,.09);
  --fc-page-bg-color: transparent;
  --fc-neutral-bg-color: rgba(255,255,255,.04);
  --fc-neutral-text-color: var(--muted);
  --fc-today-bg-color: rgba(96,165,250,.09);
  --fc-button-bg-color: rgba(255,255,255,.05);
  --fc-button-border-color: rgba(255,255,255,.12);
  --fc-button-text-color: var(--text);
  --fc-button-hover-bg-color: rgba(255,255,255,.08);
  --fc-button-hover-border-color: rgba(255,255,255,.18);
  --fc-button-active-bg-color: rgba(96,165,250,.18);
  --fc-button-active-border-color: rgba(96,165,250,.28);
  --fc-event-bg-color: rgba(96,165,250,.25);
  --fc-event-border-color: rgba(96,165,250,.35);
  --fc-event-text-color: var(--text);
  font-size: 12px;
}
.fc .fc-toolbar-title{
  font-size:14px;
  font-weight:900;
  letter-spacing:.2px;
}
.fc .fc-button{
  border-radius: 12px;
  padding: .35em .6em;
}
.fc .fc-button:focus{
  box-shadow:none;
}
.fc .fc-daygrid-day-number,
.fc .fc-col-header-cell-cushion{color: rgba(231,238,252,.88)}
.fc .fc-multimonth-title{color: rgba(231,238,252,.92); font-weight:900;}
.fc .fc-scrollgrid{border-radius: 14px; overflow:hidden}

.tooltip{
  position: fixed;
  z-index: 9999;
  pointer-events:none;
  max-width: 340px;
  background: rgba(12, 22, 40, .96);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 14px;
  box-shadow: 0 18px 44px rgba(0,0,0,.55);
  padding: 10px 10px;
  font-size: 12px;
  line-height: 1.25;
  transform: translate(-50%, -110%);
  opacity: 0;
  transition: opacity .08s ease;
}
.tooltip.show{opacity:1}
.tooltip .title{
  font-weight: 900;
  margin-bottom: 6px;
  font-size: 12px;
}
.tooltip .meta{
  color: var(--muted);
  font-size: 11px;
  margin-bottom: 6px;
}
.tooltip .checklist{
  margin-top:8px;
  border-top:1px dashed rgba(255,255,255,.14);
  padding-top:8px;
}
.tooltip .clTitle{font-weight:800;margin-bottom:6px}
.tooltip .item{
  display:flex;gap:6px;align-items:flex-start;
  margin:4px 0;
}
.tooltip .box{
  width:14px;height:14px;border-radius:5px;
  border:1px solid rgba(255,255,255,.18);
  margin-top:2px;
}
.tooltip .box.done{
  background: rgba(34,197,94,.25);
  border-color: rgba(34,197,94,.35);
}
.tooltip .item span{
  color: rgba(231,238,252,.92);
}
.tooltip .item.done span{
  color: rgba(154,167,189,.95);
  text-decoration: line-through;
}

.toast{
  position: fixed;
  bottom: 14px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(15, 26, 46, .96);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 16px;
  box-shadow: 0 20px 50px rgba(0,0,0,.55);
  padding: 12px 14px;
  display:flex;
  gap:10px;
  align-items:flex-start;
  max-width: 740px;
  width: calc(100% - 28px);
  opacity:0;
  pointer-events:none;
  transition: opacity .12s ease, transform .12s ease;
}
.toast.show{
  opacity:1;
  pointer-events:auto;
  transform: translateX(-50%) translateY(-2px);
}
.toast .left{
  width:10px;
  border-radius: 999px;
  background: rgba(251,191,36,.85);
  box-shadow: 0 0 0 3px rgba(251,191,36,.16);
  margin-top:2px;
}
.toast .content{
  flex:1;
}
.toast .content b{
  display:block;
  font-weight:900;
  margin-bottom:2px;
}
.toast .content small{color:var(--muted)}
.toast .actions{
  display:flex;
  gap:8px;
  align-items:center;
}

.modalOverlay{
  position: fixed; inset:0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(6px);
  z-index: 10000;
  display:none;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.modalOverlay.show{display:flex}
.modal{
  width:min(720px, 96vw);
  background: rgba(12,22,40,.98);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 22px;
  box-shadow: 0 30px 80px rgba(0,0,0,.70);
  overflow:hidden;
}
.modalHeader{
  padding:14px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.09);
}
.modalHeader h3{
  margin:0;
  font-size:14px;
  font-weight:900;
}
.modalBody{padding:14px}
.field{
  display:flex;
  flex-direction:column;
  gap:7px;
  margin-bottom:12px;
}
.field label{color:var(--muted);font-size:12px}
.field input, .field textarea{
  width:100%;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color:var(--text);
  padding:10px 12px;
  outline:none;
}
.field textarea{min-height:90px;resize:vertical}
.modalFooter{
  padding:14px;
  border-top:1px solid rgba(255,255,255,.09);
  display:flex;gap:10px;justify-content:flex-end;
}

.tagsDropdown{
  position:absolute;
  top:58px;
  left:14px;
  width: 280px;
  max-height: 380px;
  overflow:auto;
  background: rgba(12,22,40,.98);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 18px;
  box-shadow: 0 26px 70px rgba(0,0,0,.65);
  padding:10px;
  display:none;
  z-index: 2000;
}
.tagsDropdown.open{display:block}
.tagsDropdown .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius: 14px;
  cursor:pointer;
  border: 1px solid transparent;
}
.tagsDropdown .row:hover{
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.06);
}
.tagsDropdown .row .l{
  display:flex;align-items:center;gap:10px;
}
.tagsDropdown .swatch{
  width:12px;height:12px;border-radius:4px;
  border:1px solid rgba(255,255,255,.16);
}
.tagsDropdown input[type="checkbox"]{
  width:16px;height:16px;
  accent-color: var(--accent);
}
.tagsDropdown .top{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:0 4px 8px 4px;
  border-bottom:1px dashed rgba(255,255,255,.12);
  margin-bottom:8px;
}
.tagsDropdown .top .mini{
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 999px;
  padding:6px 10px;
  cursor:pointer;
  color: rgba(231,238,252,.88);
  font-size: 12px;
}
.tagsDropdown .top .mini:hover{background: rgba(255,255,255,.05)}
.tagsDropdown .hint{
  color: var(--muted);
  font-size: 11px;
  padding: 6px 6px 0 6px;
}

.kpi{
  display:flex; gap:10px; align-items:center;
}
.kpi .card{
  border:1px solid var(--border);
  background: rgba(255,255,255,.03);
  border-radius: 16px;
  padding:8px 10px;
  min-width: 140px;
}
.kpi .card b{display:block;font-weight:900;font-size:12px}
.kpi .card small{color:var(--muted)}
.kpi .card .value{font-weight:900; font-size:16px; margin-top:2px}

.footer{
  color: rgba(154,167,189,.95);
  font-size: 11px;
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding: 0 6px;
}
.footer a{color: rgba(96,165,250,.95); text-decoration:none}
.footer a:hover{text-decoration:underline}

/* ===== Roadmap (Gantt-like) ===== */
#gantt{
  padding:10px;
  height:100%;
  min-height:0;
}
#gantt .shell{
  height:100%;
  min-height:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#gantt .head{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
  align-items:flex-end;
}
#gantt .legend{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  color: var(--muted);
  font-size:12px;
}
#gantt .legend .pill{
  display:flex; gap:8px; align-items:center;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding:7px 10px;
  border-radius: 999px;
}
#gantt .legend .pill .sw{width:10px;height:10px;border-radius:4px;border:1px solid rgba(255,255,255,.16)}
#gantt .legend .pill b{color:rgba(231,238,252,.90);font-weight:900}
#gantt .legend .pill small{color:var(--muted)}
#gantt .table{
  border:1px solid rgba(255,255,255,.08);
  border-radius: 18px;
  overflow:hidden;
  background: rgba(0,0,0,.08);
  flex:1;
  min-height:0;
  display:flex;
  flex-direction:column;
}
#gantt .tableHeader{
  display:grid;
  grid-template-columns: 240px 1fr;
  border-bottom:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.12);
}
#gantt .tableHeader .left{
  padding:10px 12px;
  color: rgba(231,238,252,.90);
  font-weight:900;
  font-size:12px;
}
#gantt .tableHeader .right{
  position:relative;
  overflow:hidden;
}
#gantt .months{
  display:flex;
  width:100%;
  height:100%;
}
#gantt .month{
  border-left:1px solid rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  padding-left:10px;
  font-size:12px;
  font-weight:900;
  color: rgba(231,238,252,.86);
}
#gantt .body{
  display:grid;
  grid-template-columns: 240px 1fr;
  min-height:0;
  flex:1;
}
#gantt .lists{
  border-right:1px solid rgba(255,255,255,.08);
  overflow:auto;
}
#gantt .rows{
  position:relative;
  overflow:auto;
}
#gantt .listRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.06);
  background: rgba(255,255,255,.01);
}
#gantt .listRow:nth-child(odd){background: rgba(255,255,255,.02)}
#gantt .listRow .name{
  font-weight:900;
  font-size:12px;
  color: rgba(231,238,252,.92);
}
#gantt .listRow .count{
  font-size:11px;
  color: var(--muted);
}
#gantt .row{
  position:relative;
  height: 46px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
#gantt .row:nth-child(odd){background: rgba(255,255,255,.02)}
#gantt .gridLines{
  position:absolute; inset:0;
  pointer-events:none;
}
#gantt .gridLine{
  position:absolute; top:0; bottom:0;
  width:1px;
  background: rgba(255,255,255,.06);
}
#gantt .gridLine.week{
  background: rgba(96,165,250,.18);
}
#gantt .bar{
  position:absolute;
  top: 12px;
  height: 22px;
  border-radius: 999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(96,165,250,.22);
  box-shadow: 0 12px 28px rgba(0,0,0,.32);
  display:flex;
  align-items:center;
  padding:0 10px;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  cursor:pointer;
  transition: transform .08s ease, filter .15s ease;
}
#gantt .bar:hover{filter: brightness(1.05)}
#gantt .bar:active{transform: translateY(1px)}
#gantt .bar b{font-weight:900;font-size:12px}
#gantt .bar small{color: rgba(231,238,252,.88); margin-left:8px; font-size:11px}
#gantt .milestone{
  position:absolute;
  top: 7px;
  width: 32px;
  height: 32px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(96,165,250,.18);
  box-shadow: 0 16px 34px rgba(0,0,0,.45);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
}
#gantt .milestone:hover{filter: brightness(1.06)}
#gantt .milestone:active{transform: translateY(1px)}
#gantt .milestone span{font-size:12px}
#gantt .milestoneLabel{
  position:absolute;
  top: 42px;
  transform: translateX(-30%);
  font-size: 11px;
  color: rgba(231,238,252,.88);
  white-space: nowrap;
  pointer-events:none;
}

.kanban{
  display:none;
  height:100%;
  min-height:0;
  padding:10px;
}
.kanban.show{display:block}
.kanban .cols{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  height:100%;
  min-height:0;
}
.kanban .col{
  border:1px solid rgba(255,255,255,.08);
  border-radius: 18px;
  overflow:hidden;
  background: rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
  min-height:0;
}
.kanban .colHeader{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background: rgba(0,0,0,.12);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.kanban .colHeader b{
  font-weight:900;
  font-size:12px;
  letter-spacing:.25px;
  text-transform:uppercase;
}
.kanban .colHeader small{color:var(--muted)}
.kanban .cards{
  padding:10px;
  overflow:auto;
  min-height:0;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.kcard{
  border:1px solid rgba(255,255,255,.10);
  border-radius: 18px;
  padding:10px 10px;
  background: rgba(255,255,255,.03);
  box-shadow: 0 12px 28px rgba(0,0,0,.28);
}
.kcard .t{
  font-weight:900;
  font-size:12px;
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.kcard .meta{
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.kcard .reason{
  margin-top:8px;
  font-size:12px;
  color: rgba(231,238,252,.92);
  background: rgba(251,191,36,.08);
  border: 1px dashed rgba(251,191,36,.25);
  padding:8px 10px;
  border-radius: 14px;
}
.kcard .tags{
  margin-top:8px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.kcard .tag{
  font-size:11px;
  padding:5px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.03);
  color: rgba(231,238,252,.88);
}
.kcard .tag .sw{
  display:inline-block;
  width:8px;height:8px;border-radius:3px;
  margin-right:6px;
  border:1px solid rgba(255,255,255,.16);
  vertical-align:middle;
}

@media (min-width: 980px){
  .main{
    grid-template-columns: 1.2fr .8fr;
  }
}
@media (max-width: 980px){
  body{overflow:auto}
  .app{height:auto; overflow:visible}
  .panel{min-height: 520px}
}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">VW</div>
      <div>
        <h1>Roadmap Volkswagen</h1>
        <div class="sub">Calendrier + Roadmap Trello (Quarter view, tags & tooltips)</div>
      </div>
    </div>

    <div class="controls">
      <div class="chip" id="boardChip">
        <div class="dot"></div>
        <div>
          <div style="display:flex;gap:8px;align-items:baseline">
            <b id="boardName">‚Äî</b>
            <small id="kpiSmall"></small>
          </div>
          <small id="kpiHint">Connecte-toi pour charger les cartes.</small>
        </div>
      </div>

      <div class="chip" id="tagsChip">
        <div class="dot" id="tagDot"></div>
        <div>
          <small>Filtres</small>
          <div style="display:flex;gap:8px;align-items:baseline">
            <b id="tagsLabel">Tous</b>
            <small id="tagsCount"></small>
          </div>
        </div>
        <button class="btn ghost" id="tagsBtn" aria-haspopup="true" aria-expanded="false" title="Filtrer par √©tiquettes">‚ñº</button>
      </div>

      <div class="segment" role="tablist" aria-label="Vue">
        <button id="tabCalendar" class="active" role="tab" aria-selected="true">Calendrier</button>
        <button id="tabRoadmap" role="tab" aria-selected="false">Roadmap</button>
        <button id="tabKanban" role="tab" aria-selected="false">Bloqu√©es</button>
      </div>

      <button class="btn primary" id="connectBtn">Connexion</button>
      <button class="btn" id="refreshBtn" disabled>Rafra√Æchir</button>
      <button class="btn danger" id="logoutBtn" disabled>D√©connexion</button>
    </div>
  </div>

  <div class="main">
    <div class="panel" id="calendarPanel">
      <div class="panelHeader">
        <h2>Planning</h2>
        <div class="right">
          <div class="segment" id="zoomSeg" title="Zoom">
            <button data-zoom="1" class="active">1M</button>
            <button data-zoom="3">3M</button>
            <button data-zoom="6">6M</button>
          </div>
          <button class="btn" id="todayBtn">Aujourd‚Äôhui</button>
        </div>
      </div>
      <div id="calendar"></div>
    </div>

    <div class="panel" id="roadmapPanel" style="display:none">
      <div class="panelHeader">
        <h2>Roadmap</h2>
        <div class="right">
          <button class="btn" id="roadmapTodayBtn">Aujourd‚Äôhui</button>
        </div>
      </div>
      <div id="gantt"></div>
    </div>

    <div class="panel" id="kanbanPanel" style="display:none">
      <div class="panelHeader">
        <h2>Cartes bloqu√©es</h2>
        <div class="right">
          <small style="color:var(--muted)">Tri√©es par date + priorit√©</small>
        </div>
      </div>
      <div class="kanban" id="kanban"></div>
    </div>
  </div>

  <div class="footer">
    <div>Exclut ‚Äúüéâ Termin√©‚Äù ‚Ä¢ Pas de cartes archiv√©es ‚Ä¢ Tooltips = checklists</div>
    <div><a href="https://trello.com" target="_blank" rel="noreferrer">Trello</a> ‚Ä¢ <a href="https://fullcalendar.io" target="_blank" rel="noreferrer">FullCalendar</a></div>
  </div>
</div>

<div class="tagsDropdown" id="tagsDropdown" role="menu" aria-label="Filtres d‚Äô√©tiquettes">
  <div class="top">
    <button class="mini" id="tagsAll">Tous</button>
    <button class="mini" id="tagsNone">Aucun</button>
  </div>
  <div id="tagsList"></div>
  <div class="hint">S√©lectionne 1 tag pour une couleur homog√®ne.</div>
</div>

<div class="tooltip" id="tooltip"></div>

<div class="toast" id="toast">
  <div class="left" id="toastDot"></div>
  <div class="content">
    <b id="toastTitle">‚Äî</b>
    <small id="toastHint">‚Äî</small>
  </div>
  <div class="actions">
    <button class="btn" id="toastRetryBtn">R√©essayer</button>
    <button class="btn primary" id="toastConnectBtn">Reconnex.</button>
    <button class="btn" id="toastCloseBtn">Fermer</button>
  </div>
</div>

<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalHeader">
      <h3>Connexion Trello</h3>
      <button class="btn" id="modalClose">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="field">
        <label>Board ID (ex: 5abbe4b7ddc1b351ef961414)</label>
        <input id="boardIdInput" placeholder="Colle l‚ÄôID du board"/>
      </div>
      <div class="field">
        <label>API Key (publique)</label>
        <input id="keyInput" placeholder="Colle ta key Trello"/>
      </div>
      <div class="field">
        <label>Token (personnel)</label>
        <textarea id="tokenInput" placeholder="Colle ton token Trello"></textarea>
      </div>
      <small style="color:var(--muted)">
        Astuce : tu peux g√©n√©rer un token via Trello (cl√© publique + autorisation). Le token est stock√© localement dans ton navigateur.
      </small>
    </div>
    <div class="modalFooter">
      <button class="btn" id="modalCancel">Annuler</button>
      <button class="btn primary" id="modalSave">Enregistrer</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/multimonth@6.1.15/index.global.min.js"></script>

<script>
/* =========================================
   Trello Calendar Builder - single file app
   ========================================= */

const LS_KEY = "trello_calendar_vw_v4";
const DONE = "üéâ Termin√©";

let trello = { key:"", token:"", boardId:"" };
let allTags = [];          // {name,color,hex}
let allCards = [];         // normalized cards
let blockedCards = [];     // subset with custom field "Raison" or flags
let filteredCards = [];
let filteredBlockedCards = [];
let doneListIds = new Set();

let calendar = null;
let tagsMode = "all"; // all | some | none
let selectedTags = new Set();
let zoomMonths = 3;

const tooltipEl = document.getElementById("tooltip");

// Checklist cache: in-memory + localStorage TTL
const CHECKLIST_TTL_MS = 20 * 60 * 1000;
let checklistMem = new Map(); // cardId -> {t, data}

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    trello = {
      key: s.key || "",
      token: s.token || "",
      boardId: s.boardId || ""
    };
    zoomMonths = s.zoomMonths || 3;
    tagsMode = s.tagsMode || "all";
    selectedTags = new Set(s.selectedTags || []);
  }catch(e){}
}
function saveState(){
  const s = {
    key: trello.key,
    token: trello.token,
    boardId: trello.boardId,
    zoomMonths,
    tagsMode,
    selectedTags: [...selectedTags]
  };
  localStorage.setItem(LS_KEY, JSON.stringify(s));
}

function fmtDate(d){
  if(!d) return "‚Äî";
  const dt = new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const da = String(dt.getDate()).padStart(2,"0");
  return `${da}/${m}/${y}`;
}

function day(d){
  const x = new Date(d);
  x.setHours(0,0,0,0);
  return x;
}
function diffDays(a,b){
  return Math.round((day(b)-day(a))/86400000);
}

function setLoading(on){
  document.getElementById("refreshBtn").disabled = on || !isConnected();
  document.getElementById("logoutBtn").disabled = on || !isConnected();
  document.getElementById("connectBtn").disabled = on;
}
function isConnected(){
  return !!(trello.key && trello.token && trello.boardId);
}

function showBanner(title, hint, {retry=true,reconnect=true}={}){
  const toast=document.getElementById("toast");
  const tTitle=document.getElementById("toastTitle");
  const tHint=document.getElementById("toastHint");
  const retryBtn=document.getElementById("toastRetryBtn");
  const connBtn=document.getElementById("toastConnectBtn");

  tTitle.textContent = title || "Info";
  tHint.textContent = hint || "";
  retryBtn.style.display = retry ? "" : "none";
  connBtn.style.display = reconnect ? "" : "none";

  toast.classList.add("show");
}
function hideBanner(){
  document.getElementById("toast").classList.remove("show");
}

document.getElementById("toastCloseBtn").addEventListener("click", hideBanner);
document.getElementById("toastRetryBtn").addEventListener("click", ()=>{
  hideBanner();
  if(isConnected()) initBoard();
});
document.getElementById("toastConnectBtn").addEventListener("click", ()=>{
  hideBanner();
  openModal();
});

function openModal(){
  document.getElementById("modalOverlay").classList.add("show");
  document.getElementById("boardIdInput").value = trello.boardId || "";
  document.getElementById("keyInput").value = trello.key || "";
  document.getElementById("tokenInput").value = trello.token || "";
}
function closeModal(){
  document.getElementById("modalOverlay").classList.remove("show");
}
document.getElementById("connectBtn").addEventListener("click", openModal);
document.getElementById("modalClose").addEventListener("click", closeModal);
document.getElementById("modalCancel").addEventListener("click", closeModal);
document.getElementById("modalSave").addEventListener("click", ()=>{
  trello.boardId = document.getElementById("boardIdInput").value.trim();
  trello.key = document.getElementById("keyInput").value.trim();
  trello.token = document.getElementById("tokenInput").value.trim();

  saveState();
  closeModal();
  if(isConnected()) initBoard();
  else showBanner("Infos manquantes.", "Renseigne Board ID, Key et Token.", {retry:false,reconnect:true});
});

document.getElementById("logoutBtn").addEventListener("click", ()=>{
  trello = {key:"",token:"",boardId:""};
  saveState();
  allTags=[]; allCards=[]; blockedCards=[]; filteredCards=[]; filteredBlockedCards=[];
  selectedTags = new Set();
  tagsMode = "all";
  renderTagsChip();
  renderTagsDropdown();
  setKpi();
  calendar.removeAllEvents();
  document.getElementById("boardName").textContent="‚Äî";
  showBanner("D√©connect√©.", "Tu peux te reconnecter avec un autre token.", {retry:false,reconnect:true});
});

document.getElementById("refreshBtn").addEventListener("click", ()=>{
  if(isConnected()) initBoard();
});

document.getElementById("todayBtn").addEventListener("click", ()=> calendar.today());
document.getElementById("roadmapTodayBtn").addEventListener("click", ()=> calendar.today());

/* ================= View switching ================= */
const tabCalendar = document.getElementById("tabCalendar");
const tabRoadmap  = document.getElementById("tabRoadmap");
const tabKanban   = document.getElementById("tabKanban");

function setActiveTab(tab){
  tabCalendar.classList.toggle("active", tab==="calendar");
  tabRoadmap.classList.toggle("active", tab==="roadmap");
  tabKanban.classList.toggle("active", tab==="kanban");

  document.getElementById("calendarPanel").style.display = tab==="calendar" ? "" : "none";
  document.getElementById("roadmapPanel").style.display  = tab==="roadmap" ? "" : "none";
  document.getElementById("kanbanPanel").style.display   = tab==="kanban" ? "" : "none";

  if(tab==="roadmap"){
    renderGantt(filteredCards, getHomogeneousColorIfAny());
    setTimeout(forceRoadmapScrollHeight, 20);
  }
  if(tab==="kanban"){
    renderKanban(filteredBlockedCards, getHomogeneousColorIfAny());
  }

  // persist in URL
  const u=new URL(location.href);
  u.searchParams.set("tab", tab);
  history.replaceState(null,"",u.toString());
}

tabCalendar.addEventListener("click", ()=> setActiveTab("calendar"));
tabRoadmap.addEventListener("click", ()=> setActiveTab("roadmap"));
tabKanban.addEventListener("click", ()=> setActiveTab("kanban"));

/* ================= Zoom ================= */
document.getElementById("zoomSeg").addEventListener("click", (e)=>{
  const b=e.target.closest("button[data-zoom]");
  if(!b) return;
  zoomMonths = parseInt(b.dataset.zoom,10);
  for(const x of document.querySelectorAll("#zoomSeg button")){
    x.classList.toggle("active", x===b);
  }
  saveState();
  applyZoom();
});

function applyZoom(){
  if(!calendar) return;
  if(zoomMonths===1) calendar.changeView("dayGridMonth");
  else if(zoomMonths===3) calendar.changeView("multiMonthQuarter");
  else calendar.changeView("multiMonthYear");
  // URL
  const u=new URL(location.href);
  u.searchParams.set("zoom", String(zoomMonths));
  history.replaceState(null,"",u.toString());
}

/* ================= Tags dropdown ================= */
const dd=document.getElementById("tagsDropdown");
const tagsBtn=document.getElementById("tagsBtn");

function openTags(){
  dd.classList.add("open");
  tagsBtn.setAttribute("aria-expanded","true");
}
function closeTags(){
  dd.classList.remove("open");
  tagsBtn.setAttribute("aria-expanded","false");
}
tagsBtn.addEventListener("click", (e)=>{
  e.stopPropagation();
  if(dd.classList.contains("open")) closeTags();
  else openTags();
});
document.addEventListener("click", (e)=>{
  if(!dd.contains(e.target) && e.target!==tagsBtn) closeTags();
});

document.getElementById("tagsAll").addEventListener("click", ()=>{
  tagsMode="all";
  selectedTags=new Set(allTags.map(t=>t.name));
  persistSelectedTags();
  renderTagsDropdown();
  applyFilters();
});
document.getElementById("tagsNone").addEventListener("click", ()=>{
  tagsMode="none";
  selectedTags.clear();
  persistSelectedTags();
  renderTagsDropdown();
  applyFilters();
});

function persistSelectedTags(){
  saveState();
  // URL
  const u=new URL(location.href);
  const tags=[...selectedTags];
  if(tagsMode==="some" && tags.length) u.searchParams.set("tags", tags.join("|"));
  else u.searchParams.delete("tags");
  u.searchParams.set("tagsMode", tagsMode);
  history.replaceState(null,"",u.toString());
}

function renderTagsChip(){
  const label=document.getElementById("tagsLabel");
  const count=document.getElementById("tagsCount");
  const dot=document.getElementById("tagDot");

  if(tagsMode==="none"){
    label.textContent="Aucun";
    count.textContent="";
    dot.style.background = "rgba(251,113,133,.95)";
    dot.style.boxShadow = "0 0 0 3px rgba(251,113,133,.16)";
    return;
  }
  if(tagsMode==="some" && selectedTags.size===1){
    const name=[...selectedTags][0];
    label.textContent=name;
    count.textContent="";
    const tag=allTags.find(t=>t.name===name);
    if(tag?.hex){
      dot.style.background = tag.hex;
      dot.style.boxShadow = "0 0 0 3px rgba(96,165,250,.14)";
    }else{
      dot.style.background = "rgba(96,165,250,.95)";
      dot.style.boxShadow = "0 0 0 3px rgba(96,165,250,.16)";
    }
    return;
  }
  if(tagsMode==="some"){
    label.textContent = `${selectedTags.size} tags`;
    count.textContent = "";
    dot.style.background = "rgba(96,165,250,.95)";
    dot.style.boxShadow = "0 0 0 3px rgba(96,165,250,.16)";
    return;
  }
  // all
  label.textContent="Tous";
  count.textContent="";
  dot.style.background = "rgba(96,165,250,.95)";
  dot.style.boxShadow = "0 0 0 3px rgba(96,165,250,.16)";
}

function renderTagsDropdown(){
  const listEl=document.getElementById("tagsList");
  listEl.innerHTML="";

  for(const t of allTags){
    // Hide internal label from filter dropdown (still exists on cards)
    if((t.name||"").trim() === SPRINT_VN_LABEL) continue;
    const id="tag_" + btoa(unescape(encodeURIComponent(t.name))).replaceAll("=","");
    const checked=selectedTags.has(t.name);

    const row=document.createElement("label");
    row.className="row";
    row.setAttribute("for", id);

    const left=document.createElement("div");
    left.className="l";

    const sw=document.createElement("div");
    sw.className="swatch";
    sw.style.background = t.hex || "rgba(255,255,255,.12)";

    const name=document.createElement("div");
    name.textContent = t.name || "(sans nom)";

    left.appendChild(sw);
    left.appendChild(name);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.id=id;
    cb.checked=checked;
    cb.addEventListener("change", ()=>{
      tagsMode = "some";
      if(cb.checked) selectedTags.add(t.name);
      else selectedTags.delete(t.name);
      if(selectedTags.size===0) tagsMode="all";
      persistSelectedTags();
      renderTagsChip();
      applyFilters();
    });

    row.appendChild(left);
    row.appendChild(cb);
    listEl.appendChild(row);
  }

  renderTags
