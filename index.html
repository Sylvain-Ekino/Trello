<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trello ‚Üí Gantt</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <style>
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e5e7eb;
      --shadow: 0 18px 45px rgba(2,6,23,.08);
      --shadow-sm: 0 8px 18px rgba(2,6,23,.08);
      --radius: 18px;

      /* Gantt sizing (compact always) */
      --gantt-left-w: 260px;
      --gantt-lane-h: 20px;
      --gantt-lane-gap: 6px;
      --gantt-pad-y: 10px;
      --gantt-bar-h: 16px;

      --grid: rgba(15,23,42,.06);
      --grid-strong: rgba(15,23,42,.10);
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(99,102,241,.10), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(14,165,233,.10), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    .container{
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 14px;
    }

    /* Sticky top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      background: rgba(246,247,251,.76);
      border-bottom: 1px solid rgba(229,231,235,.9);
    }
    .topbar-inner{
      padding: 12px 0 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .toprow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .dot{
      width: 11px; height: 11px; border-radius: 999px;
      background: linear-gradient(135deg, #6366f1, #0ea5e9);
      box-shadow: 0 10px 26px rgba(99,102,241,.30);
    }
    .sub{
      font-weight: 800;
      color: var(--muted);
      font-size: 12px;
    }

    .controls{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.90);
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
    }
    .chip strong{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .02em;
    }
    .select, .chip input{
      border: 0;
      outline: none;
      background: transparent;
      font-weight: 900;
      color: var(--text);
      max-width: 220px;
    }
    .chip input{ width: 190px; }
    @media (max-width: 520px){
      .chip input{ width: 140px; }
    }

    .seg{
      display:inline-flex;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(246,247,251,.55);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .seg button{
      border:0;
      background: transparent;
      padding: 8px 10px;
      font-weight: 900;
      color: var(--muted);
      cursor: pointer;
      user-select:none;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(255,255,255,.92);
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      padding: 9px 11px;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: transform .08s ease, box-shadow .08s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(2,6,23,.10); }
    .btn:active{ transform: translateY(0); box-shadow: var(--shadow-sm); }
    .btn.primary{
      border: 1px solid rgba(99,102,241,.35);
      background: linear-gradient(135deg, rgba(99,102,241,.14), rgba(14,165,233,.12));
    }

    .tokenbar{
      display:flex;
      align-items:center;
      gap:8px;
      border: 1px dashed rgba(100,116,139,.35);
      background: rgba(255,255,255,.68);
      padding: 8px 10px;
      border-radius: 14px;
    }
    .tokenbar input{
      border:0; outline:none; background: transparent;
      min-width: 200px;
      font-weight: 900;
    }
    @media (max-width: 720px){
      .tokenbar input{ min-width: 140px; }
    }

    .status{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
      padding-bottom: 2px;
    }
    .error{ color: #b91c1c; }

    /* Main panel centered */
    .wrap{
      padding: 14px 0 40px;
    }
    .panel{
      background: var(--card);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* FullCalendar used as navigation (toolbar only) */
    #calendar{
      padding: 8px 10px 0;
      border-bottom: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.9);
    }
    .fc .fc-toolbar{
      margin: 4px 0 10px !important;
    }
    .fc .fc-toolbar-title{
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .fc .fc-button{
      border-radius: 12px !important;
      border: 1px solid var(--border) !important;
      background: rgba(255,255,255,.92) !important;
      color: var(--text) !important;
      font-weight: 900 !important;
      box-shadow: var(--shadow-sm);
      transition: transform .08s ease, box-shadow .08s ease;
      padding: 8px 10px !important;
    }
    .fc .fc-button:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(2,6,23,.10); }
    .fc .fc-view-harness{ display:none; } /* IMPORTANT: hide grid, keep toolbar */

    /* Tooltip */
    .tt{
      position: fixed; z-index: 9999;
      width: min(460px, calc(100vw - 24px));
      background: rgba(255,255,255,.98);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 16px;
      box-shadow: 0 25px 70px rgba(2,6,23,.16);
      padding: 12px 12px 10px;
      font-size: 13px;
      line-height: 1.35;
      pointer-events: none;
    }
    .tt h4{ margin:0 0 6px 0; font-size: 13px; font-weight: 950; }
    .tt .meta{ color: var(--muted); margin-bottom: 10px; font-weight: 900; }
    .tt .sec{ margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(229,231,235,.9); }
    .tt ul{ margin: 0; padding-left: 18px; }
    .tt li{ margin: 2px 0; }
    .tt .done{ text-decoration: line-through; color: var(--muted); }

    /* ===== GANTT CORE ===== */
    #gantt{
      padding: 10px;
    }

    .gantt-shell{
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      background: rgba(255,255,255,.9);
    }

    .gantt-top{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(229,231,235,.95);
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .gantt-top .range{
      font-weight: 950;
      letter-spacing: .2px;
    }
    .gantt-top .hint{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }

    .gantt-head{
      display:grid;
      grid-template-columns: var(--gantt-left-w) 1fr;
      border-bottom: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
    }
    .gantt-head .hl{
      padding: 10px 12px;
      font-weight: 950;
      color: var(--muted);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      border-right: 1px solid rgba(229,231,235,.95);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
    }
    .gantt-head .hr{
      position: relative;
      padding: 10px 12px;
      overflow:hidden;
    }

    .ticks{
      display:flex;
      align-items:center;
      height: 18px;
    }
    .tick{
      width: var(--gantt-week-w, 182px);
      min-width: var(--gantt-week-w, 182px);
      color: var(--muted);
      font-weight: 950;
      font-size: 11px;
      text-transform: uppercase;
      opacity:.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 8px;
    }

    /* Scroll area */
    .gantt-scroll{
      display:grid;
      grid-template-columns: var(--gantt-left-w) 1fr;
      max-height: min(72vh, 980px);
      overflow: hidden;
    }

    .gantt-left{
      border-right: 1px solid rgba(229,231,235,.95);
      background: linear-gradient(180deg, rgba(246,247,251,.65), rgba(255,255,255,.92));
      overflow:auto;
    }
    .gantt-rightWrap{
      overflow:auto;
      position: relative;
      background:
        repeating-linear-gradient(
          to right,
          var(--grid) 0px,
          var(--grid) 1px,
          transparent 1px,
          transparent var(--gantt-day-w, 22px)
        );
    }
    .gantt-rightWrap::before{
      content:"";
      position:absolute; inset:0;
      background:
        repeating-linear-gradient(
          to right,
          transparent 0,
          transparent calc(var(--gantt-week-w, 154px) - 1px),
          var(--grid-strong) calc(var(--gantt-week-w, 154px) - 1px),
          var(--grid-strong) var(--gantt-week-w, 154px)
        );
      pointer-events:none;
      opacity:.85;
    }

    .todayLine{
      position:absolute;
      top:0; bottom:0;
      width: 2px;
      background: rgba(239,68,68,.75);
      box-shadow: 0 0 0 3px rgba(239,68,68,.10);
      pointer-events:none;
      z-index: 2;
    }

    /* List rows (left) + lanes canvas (right) stay aligned by shared heights */
    .listRow{
      border-bottom: 1px solid rgba(229,231,235,.75);
      padding: 10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      user-select:none;
    }
    .listRow:hover{ background: rgba(255,255,255,.55); }
    .listName{
      font-weight: 950;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .listMeta{
      font-weight: 950;
      color: var(--muted);
      font-size: 11px;
      white-space: nowrap;
    }

    .laneBlock{
      position: relative;
      border-bottom: 1px solid rgba(229,231,235,.75);
      min-height: 44px;
    }
    .laneInner{
      position:absolute;
      inset:0;
      padding: var(--gantt-pad-y) 0;
      z-index: 1;
    }

    /* Bars */
    .bar{
      position:absolute;
      height: var(--gantt-bar-h);
      border-radius: 10px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      padding: 0 8px;
      gap: 8px;
      cursor: pointer;
      overflow:hidden;
      min-width: 12px;
      z-index: 3;
    }
    .bar:hover{
      filter: brightness(1.03);
      box-shadow: 0 14px 26px rgba(2,6,23,.14);
    }
    .bar .t{
      font-weight: 950;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .milestone{
      position:absolute;
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 18px rgba(2,6,23,.10);
      transform: translate(-50%, -50%) rotate(45deg);
      cursor:pointer;
      z-index: 3;
    }
    .milestone:hover{
      filter: brightness(1.05);
      box-shadow: 0 14px 26px rgba(2,6,23,.14);
    }

    /* Responsive tweaks */
    @media (max-width: 860px){
      :root{ --gantt-left-w: 220px; }
      .tokenbar input{ min-width: 130px; }
    }
    @media (max-width: 620px){
      :root{ --gantt-left-w: 170px; }
      .listMeta{ display:none; }
      .gantt-top{ padding: 10px; }
      .gantt-head .hl{ padding: 10px; }
      .gantt-head .hr{ padding: 10px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <div class="toprow">
          <div class="brand">
            <span class="dot"></span>
            Trello Gantt
            <span class="sub">ultra-compact ‚Ä¢ listes ‚Üí lanes</span>
          </div>

          <div class="controls">
            <div class="chip">
              <strong>Tag</strong>
              <select id="labelFilter" class="select">
                <option value="__ALL__">Tous</option>
              </select>
            </div>

            <div class="chip" title="Filtrer par texte (titre / liste)">
              <strong>Recherche</strong>
              <input id="searchInput" class="select" placeholder="ex: onboarding‚Ä¶" />
            </div>

            <div class="seg" aria-label="Zoom Gantt (dur√©e)">
              <button id="zoom1" type="button">1M</button>
              <button id="zoom3" type="button" class="active">3M</button>
              <button id="zoom6" type="button">6M</button>
            </div>

            <button class="btn" id="refreshBtn">Rafra√Æchir</button>
            <button class="btn" id="logoutBtn" title="Oublier le token">Oublier</button>

            <div class="tokenbar">
              <input id="tokenInput" type="password" placeholder="Trello token" />
              <button class="btn primary" id="saveTokenBtn">Valider</button>
            </div>
          </div>
        </div>

        <div class="status">
          <span id="status"></span>
          <span id="error" class="error"></span>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="container">
      <div class="panel">
        <!-- FullCalendar: toolbar only (center of app navigation) -->
        <div id="calendar"></div>

        <!-- Gantt -->
        <div id="gantt"></div>
      </div>
    </div>
  </div>

  <script>
    const TRELLO = {
      key: "ec995ad68de9cdaafd64b131e5fa00ec",
      boardId: "6490c5416cea9255ba3b0383"
    };

    const API_BASE = "https://api.trello.com/1";
    const CARD_FIELDS = "name,due,start,closed,url,idLabels,labels,idList";
    const DONE_LIST_NAMES = new Set(["üéâ Termin√©"]);

    const TRELLO_LABEL_COLOR_TO_HEX = {
      green:  "#22c55e",
      yellow: "#eab308",
      orange: "#f97316",
      red:    "#ef4444",
      purple: "#a855f7",
      blue:   "#3b82f6",
      sky:    "#0ea5e9",
      lime:   "#84cc16",
      pink:   "#ec4899",
      black:  "#111827"
    };

    let allEvents = [];
    let calendar;
    let listIdToName = new Map();
    let doneListIds = new Set();
    let labelIdToHex = new Map();

    const checklistCache = new Map();
    let tooltipEl = null;

    const SEARCH_KEY = "tc_search";
    const ZOOM_KEY = "tc_zoom"; // "1"|"3"|"6"
    const COLLAPSE_KEY = "tc_collapsed_lists"; // ["List name", ...]

    function setStatus(msg){ document.getElementById("status").textContent = msg || ""; }
    function setError(msg){ document.getElementById("error").textContent = msg || ""; }

    function getToken(){ return localStorage.getItem("trello_token"); }
    function saveToken(token){ localStorage.setItem("trello_token", token); }
    function forgetToken(){
      localStorage.removeItem("trello_token");
      document.getElementById("tokenInput").value = "";
      calendar?.removeAllEvents();
      setError("");
      setStatus("Token supprim√© sur ce navigateur.");
      renderGantt(true);
    }

    function getSearch(){ return localStorage.getItem(SEARCH_KEY) || ""; }
    function setSearch(v){ localStorage.setItem(SEARCH_KEY, v || ""); }

    function getZoom(){ return localStorage.getItem(ZOOM_KEY) || "3"; }
    function setZoom(z){ localStorage.setItem(ZOOM_KEY, z); }

    function getCollapsed(){
      try { return new Set(JSON.parse(localStorage.getItem(COLLAPSE_KEY) || "[]")); }
      catch { return new Set(); }
    }
    function setCollapsed(set){
      localStorage.setItem(COLLAPSE_KEY, JSON.stringify([...set]));
    }

    function qs(params){ return new URLSearchParams(params).toString(); }

    function uniqBy(arr, keyFn){
      const seen = new Set();
      return arr.filter(x => {
        const k = keyFn(x);
        if (seen.has(k)) return false;
        seen.add(k);
        return true;
      });
    }

    async function fetchBoardLists(token){
      const url = `${API_BASE}/boards/${encodeURIComponent(TRELLO.boardId)}/lists?` + qs({
        key: TRELLO.key, token, fields: "name", filter: "open"
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Trello API error (${res.status})`);
      return res.json();
    }

    async function fetchBoardCards(token){
      const url = `${API_BASE}/boards/${encodeURIComponent(TRELLO.boardId)}/cards?` + qs({
        key: TRELLO.key, token, fields: CARD_FIELDS, filter: "open"
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Trello API error (${res.status})`);
      return res.json();
    }

    async function fetchCardChecklists(token, cardId){
      const url = `${API_BASE}/cards/${encodeURIComponent(cardId)}/checklists?` + qs({
        key: TRELLO.key, token
      });
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Trello API error (${res.status})`);
      return res.json();
    }

    function isDoneListName(name){ return DONE_LIST_NAMES.has(name); }

    function pickEventColorFromLabels(labels){
      const firstColored = (labels || []).find(l => l && l.color);
      if (!firstColored) return null;
      return TRELLO_LABEL_COLOR_TO_HEX[firstColored.color] || null;
    }

    function makeExclusiveEnd(dueIso){
      const d = new Date(dueIso);
      d.setDate(d.getDate() + 1);
      return d.toISOString();
    }

    function cardToEvent(card){
      if (doneListIds.has(card.idList)) return null;
      if (!card.start && !card.due) return null;

      const listName = listIdToName.get(card.idList) || "Liste";
      const title = card.name; // compact: no [Liste] prefix

      const labels = (card.labels || []).map(l => ({ id: l.id, name: l.name, color: l.color }));
      const baseColor = pickEventColorFromLabels(labels);

      const start = card.start || card.due;
      let end = undefined;
      if (card.start && card.due) end = makeExclusiveEnd(card.due);

      return {
        id: card.id,
        title,
        start,
        end,
        allDay: true,
        url: card.url,
        backgroundColor: baseColor || undefined,
        borderColor: baseColor || undefined,
        textColor: baseColor ? "#ffffff" : undefined,
        extendedProps: {
          labelIds: card.idLabels || [],
          labels,
          listName,
          baseColor: baseColor || null
        }
      };
    }

    function rebuildLabelDropdown(events){
      const select = document.getElementById("labelFilter");
      const labels = [];

      for (const ev of events) {
        for (const l of (ev.extendedProps.labels || [])) {
          if (l.name && l.id) labels.push(l);
        }
      }

      labelIdToHex = new Map();
      for (const l of labels) {
        const hex = l.color ? (TRELLO_LABEL_COLOR_TO_HEX[l.color] || null) : null;
        if (hex) labelIdToHex.set(l.id, hex);
      }

      const unique = uniqBy(labels, l => l.id).sort((a,b) => (a.name || "").localeCompare(b.name || "", "fr"));
      const current = select.value || "__ALL__";

      select.innerHTML = "";
      select.appendChild(new Option("Tous", "__ALL__"));
      for (const l of unique) select.appendChild(new Option(l.name || "(Sans nom)", l.id));

      select.value = [...select.options].some(o => o.value === current) ? current : "__ALL__";
    }

    function applyFilter(){
      const labelId = document.getElementById("labelFilter").value;
      const q = (document.getElementById("searchInput")?.value || "").trim().toLowerCase();

      let filtered = (labelId === "__ALL__")
        ? allEvents
        : allEvents.filter(ev => (ev.extendedProps.labelIds || []).includes(labelId));

      if (q) {
        filtered = filtered.filter(ev => {
          const t = (ev.title || "").toLowerCase();
          const ln = (ev.extendedProps?.listName || "").toLowerCase();
          return t.includes(q) || ln.includes(q);
        });
      }

      // homogeneous coloring when label selected
      if (labelId !== "__ALL__") {
        const hex = labelIdToHex.get(labelId) || null;
        if (hex) {
          filtered = filtered.map(ev => ({
            ...ev,
            backgroundColor: hex,
            borderColor: hex,
            textColor: "#ffffff"
          }));
        }
      }

      calendar.removeAllEvents();
      calendar.addEventSource(filtered);

      setStatus(`${filtered.length} t√¢che(s) affich√©e(s)`);
      renderGantt();
    }

    // Tooltip helpers
    function ensureTooltip(){
      if (tooltipEl) return tooltipEl;
      tooltipEl = document.createElement("div");
      tooltipEl.className = "tt";
      tooltipEl.style.display = "none";
      document.body.appendChild(tooltipEl);
      return tooltipEl;
    }

    function moveTooltip(mouseEvent){
      if (!tooltipEl) return;
      const pad = 14;
      let x = mouseEvent.clientX + pad;
      let y = mouseEvent.clientY + pad;

      const rect = tooltipEl.getBoundingClientRect();
      const vw = window.innerWidth;
      const vh = window.innerHeight;

      if (x + rect.width + pad > vw) x = vw - rect.width - pad;
      if (y + rect.height + pad > vh) y = vh - rect.height - pad;

      tooltipEl.style.left = x + "px";
      tooltipEl.style.top = y + "px";
    }

    function hideTooltip(){
      if (!tooltipEl) return;
      tooltipEl.style.display = "none";
      tooltipEl.innerHTML = "";
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderChecklistHtml(checklists){
      if (!checklists || checklists.length === 0) {
        return `<div class="meta">Aucune checklist</div>`;
      }
      const maxLists = 2, maxItems = 10;
      let html = "";
      for (const cl of checklists.slice(0, maxLists)) {
        const items = (cl.checkItems || []);
        const done = items.filter(i => i.state === "complete").length;
        html += `<div class="meta"><strong>${escapeHtml(cl.name)}</strong> ‚Äî ${done}/${items.length}</div>`;
        html += "<ul>";
        for (const it of items.slice(0, maxItems)) {
          const isDone = it.state === "complete";
          html += `<li class="${isDone ? "done" : ""}">${escapeHtml(it.name)}</li>`;
        }
        if (items.length > maxItems) html += `<li class="muted">+${items.length - maxItems} autres‚Ä¶</li>`;
        html += "</ul>";
      }
      if (checklists.length > maxLists) {
        html += `<div class="muted sec">+${checklists.length - maxLists} checklist(s) non affich√©e(s)‚Ä¶</div>`;
      }
      return html;
    }

    async function load(){
      setError("");

      const token = getToken();
      if (!token) {
        setStatus("Renseigne ton token Trello puis clique sur ‚ÄúValider‚Äù.");
        calendar?.removeAllEvents();
        renderGantt(true);
        return;
      }

      setStatus("Chargement Trello‚Ä¶");

      const lists = await fetchBoardLists(token);
      listIdToName = new Map(lists.map(l => [l.id, l.name]));
      doneListIds = new Set(lists.filter(l => isDoneListName(l.name)).map(l => l.id));

      const cards = await fetchBoardCards(token);
      allEvents = cards.map(cardToEvent).filter(Boolean);

      rebuildLabelDropdown(allEvents);
      applyFilter();
      setError("");
    }

    // ===== GANTT packing (overlap stacking) =====
    function startOfDay(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }
    function diffDays(a, b){
      const ms = startOfDay(b).getTime() - startOfDay(a).getTime();
      return Math.round(ms / 86400000);
    }
    function clampDate(d, min, max){
      const t = d.getTime();
      if (t < min.getTime()) return new Date(min);
      if (t > max.getTime()) return new Date(max);
      return d;
    }
    function formatRange(start, end){
      const fmt = new Intl.DateTimeFormat("fr", { day:"2-digit", month:"short", year:"numeric" });
      const s = fmt.format(start);
      const eInc = new Date(end);
      eInc.setDate(eInc.getDate() - 1);
      const e = fmt.format(eInc);
      return `${s} ‚Üí ${e}`;
    }
    function weekTicks(rangeStart, rangeEnd){
      const ticks = [];
      const d = startOfDay(rangeStart);
      const day = d.getDay(); // 0..6
      const deltaToMon = (day === 0) ? 1 : (day <= 1 ? (1 - day) : (8 - day));
      d.setDate(d.getDate() + deltaToMon);

      const fmt = new Intl.DateTimeFormat("fr", { day:"2-digit", month:"short" });
      while (d < rangeEnd) {
        ticks.push(fmt.format(d));
        d.setDate(d.getDate() + 7);
      }
      return ticks;
    }

    function computeScaleVars(totalDays){
      // responsive: smaller day width on small screens, but readable
      const vw = window.innerWidth;
      const reserved = Math.min(520, Math.max(360, Math.floor(vw * 0.45)));
      const base = Math.floor((vw - reserved) / Math.max(22, totalDays));
      const dayW = Math.max(10, Math.min(26, base));
      const weekW = dayW * 7;
      return { dayW, weekW };
    }

    function getFilteredEventsFromCalendar(){
      return calendar.getEvents().map(ev => ({
        id: ev.id,
        title: ev.title,
        start: ev.startStr,
        end: ev.endStr || undefined, // exclusive if present
        url: ev.url,
        backgroundColor: ev.backgroundColor,
        textColor: ev.textColor,
        extendedProps: ev.extendedProps
      }));
    }

    function packEventsIntoLanes(items){
      // items: {sDay, eDay, ...} inclusive day indices (integers)
      // classic greedy interval partitioning
      const lanesEnd = []; // last endDay per lane
      for (const it of items) {
        let placed = false;
        for (let i=0; i<lanesEnd.length; i++) {
          if (it.sDay > lanesEnd[i]) { // no overlap (strictly after)
            it.lane = i;
            lanesEnd[i] = it.eDay;
            placed = true;
            break;
          }
        }
        if (!placed) {
          it.lane = lanesEnd.length;
          lanesEnd.push(it.eDay);
        }
      }
      return { laneCount: lanesEnd.length };
    }

    function renderGantt(forceEmpty=false){
      const ganttEl = document.getElementById("gantt");
      const token = getToken();
      if (forceEmpty || !token) {
        ganttEl.innerHTML = `
          <div class="gantt-shell">
            <div class="gantt-top">
              <div class="range">Gantt</div>
              <div class="hint">Renseigne un token pour afficher les t√¢ches.</div>
            </div>
          </div>
        `;
        return;
      }

      const view = calendar.view;
      const rangeStart = startOfDay(view.currentStart);
      const rangeEnd = startOfDay(view.currentEnd); // exclusive
      const totalDays = Math.max(1, diffDays(rangeStart, rangeEnd));

      const { dayW, weekW } = computeScaleVars(totalDays);
      const ticks = weekTicks(rangeStart, rangeEnd);
      const rangeLabel = formatRange(rangeStart, rangeEnd);

      const today = startOfDay(new Date());
      const showToday = today >= rangeStart && today < rangeEnd;
      const todayOffset = diffDays(rangeStart, today);

      const collapsed = getCollapsed();

      // collect events by listName
      const events = getFilteredEventsFromCalendar()
        .filter(ev => ev.start)
        .map(ev => {
          const listName = ev.extendedProps?.listName || "Sans liste";
          const s = startOfDay(new Date(ev.start));
          const eEx = ev.end ? startOfDay(new Date(ev.end)) : null; // exclusive
          const hasRange = !!(eEx && eEx > s);
          // display end inclusive
          const eInc = hasRange ? new Date(eEx.getTime() - 86400000) : s;

          // clamp to visible
          const clampedS = clampDate(s, rangeStart, new Date(rangeEnd.getTime() - 86400000));
          const clampedE = clampDate(eInc, rangeStart, new Date(rangeEnd.getTime() - 86400000));

          const sDay = diffDays(rangeStart, clampedS);
          const eDay = diffDays(rangeStart, clampedE);

          return {
            ...ev,
            listName,
            _s: clampedS,
            _e: clampedE,
            sDay,
            eDay,
            isMilestone: !hasRange
          };
        });

      const byList = new Map();
      for (const ev of events) {
        if (!byList.has(ev.listName)) byList.set(ev.listName, []);
        byList.get(ev.listName).push(ev);
      }

      const listNames = [...byList.keys()].sort((a,b) => a.localeCompare(b, "fr"));

      // Precompute heights per list (packing)
      const listModels = listNames.map(name => {
        const items = (byList.get(name) || []).slice()
          .sort((a,b) => (a.sDay - b.sDay) || ((b.eDay - b.sDay) - (a.eDay - a.sDay)) || (a.title||"").localeCompare(b.title||"", "fr"));

        // pack
        const { laneCount } = packEventsIntoLanes(items);
        const collapsedNow = collapsed.has(name);

        const laneH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--gantt-lane-h")) || 20;
        const laneGap = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--gantt-lane-gap")) || 6;
        const padY = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--gantt-pad-y")) || 10;

        const height = collapsedNow
          ? 44
          : (padY*2 + laneCount*laneH + Math.max(0, laneCount-1)*laneGap);

        return { name, items, laneCount, height, collapsed: collapsedNow };
      });

      // Build left & right HTML with aligned heights
      let leftHtml = "";
      let rightHtml = "";

      for (const lm of listModels) {
        const safeName = escapeHtml(lm.name);
        const count = lm.items.length;
        const chevron = lm.collapsed ? "‚ñ∏" : "‚ñæ";

        leftHtml += `
          <div class="listRow" data-action="toggle-list" data-list="${safeName}" style="height:${lm.height}px">
            <div style="min-width:0">
              <div class="listName" title="${safeName}">${safeName}</div>
              <div class="listMeta">${count} carte(s) ‚Ä¢ ${lm.collapsed ? "repli√©" : `${lm.laneCount} lane(s)`}</div>
            </div>
            <div class="listMeta">${chevron}</div>
          </div>
        `;

        // Right lane block
        let bars = "";
        if (!lm.collapsed) {
          for (const it of lm.items) {
            const color = it.backgroundColor || it.extendedProps?.baseColor || "#475569";
            const textColor = it.textColor || "#ffffff";

            const leftPx = it.sDay * dayW;
            const widthPx = Math.max(dayW, (it.eDay - it.sDay + 1) * dayW);

            const laneH = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--gantt-lane-h")) || 20;
            const laneGap = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--gantt-lane-gap")) || 6;
            const padY = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--gantt-pad-y")) || 10;
            const topPx = padY + it.lane * (laneH + laneGap) + (laneH/2);

            const safeTitle = escapeHtml(it.title || "");

            if (it.isMilestone) {
              bars += `
                <div class="milestone"
                  data-id="${escapeHtml(it.id)}"
                  data-url="${escapeHtml(it.url || "")}"
                  style="left:${leftPx + (dayW/2)}px; top:${topPx}px; background:${color};"
                  title="${safeTitle}">
                </div>
              `;
            } else {
              bars += `
                <div class="bar"
                  data-id="${escapeHtml(it.id)}"
                  data-url="${escapeHtml(it.url || "")}"
                  style="left:${leftPx}px; top:${topPx}px; width:${widthPx}px; transform: translateY(-50%); background:${color}; color:${textColor}; border-color:${color};"
                  title="${safeTitle}">
                  <span class="t">${safeTitle}</span>
                </div>
              `;
            }
          }
        }

        rightHtml += `
          <div class="laneBlock" style="height:${lm.height}px">
            <div class="laneInner">
              ${bars}
            </div>
          </div>
        `;
      }

      const headerLeftExtra = `
        <span style="color:var(--muted); font-weight:950; font-size:11px; letter-spacing:.10em">LISTES</span>
        <span style="color:var(--muted); font-weight:950; font-size:11px">${listModels.length}</span>
      `;

      ganttEl.innerHTML = `
        <div class="gantt-shell" style="--gantt-day-w:${dayW}px; --gantt-week-w:${weekW}px;">
          <div class="gantt-top">
            <div>
              <div class="range">Gantt ‚Ä¢ ${escapeHtml(rangeLabel)}</div>
              <div class="hint">${events.length} t√¢che(s) ‚Ä¢ chevauchements empil√©s automatiquement</div>
            </div>
            <div class="hint">Clique une liste pour replier ‚Ä¢ Survol carte = checklists</div>
          </div>

          <div class="gantt-head">
            <div class="hl">${headerLeftExtra}</div>
            <div class="hr">
              <div class="ticks">
                ${ticks.map(t => `<div class="tick">${escapeHtml(t)}</div>`).join("")}
              </div>
            </div>
          </div>

          <div class="gantt-scroll">
            <div class="gantt-left">${leftHtml || ""}</div>
            <div class="gantt-rightWrap">
              ${showToday ? `<div class="todayLine" style="left:${(todayOffset * dayW) + (dayW/2)}px"></div>` : ``}
              <div style="position:relative; z-index:1; min-width:${totalDays * dayW}px">
                ${rightHtml || ""}
              </div>
            </div>
          </div>
        </div>
      `;

      attachGanttInteractions();
    }

    function attachGanttInteractions(){
      const ganttEl = document.getElementById("gantt");
      const token = getToken();
      if (!token) return;

      // tooltip move
      ganttEl.onmousemove = (e) => { if (e) moveTooltip(e); };

      // click handlers: list collapse or open card
      ganttEl.onclick = (e) => {
        const listToggle = e.target.closest("[data-action='toggle-list']");
        if (listToggle) {
          const name = listToggle.getAttribute("data-list");
          if (name) {
            const collapsed = getCollapsed();
            if (collapsed.has(name)) collapsed.delete(name);
            else collapsed.add(name);
            setCollapsed(collapsed);
            renderGantt();
          }
          return;
        }

        const cardEl = e.target.closest("[data-id][data-url]");
        if (cardEl) {
          const url = cardEl.getAttribute("data-url");
          if (url) window.open(url, "_blank", "noopener,noreferrer");
        }
      };

      // hover tooltip for cards/milestones
      ganttEl.onmouseover = async (e) => {
        const cardEl = e.target.closest("[data-id]");
        if (!cardEl) return;

        const cardId = cardEl.getAttribute("data-id");
        if (!cardId) return;

        const ev = calendar.getEventById(cardId);
        if (!ev) return;

        const tt = ensureTooltip();
        const listName = ev.extendedProps?.listName || "";

        tt.innerHTML = `
          <h4>${escapeHtml(ev.title)}</h4>
          <div class="meta">${escapeHtml(listName)}</div>
          <div class="meta">Chargement des checklists‚Ä¶</div>
        `;
        tt.style.display = "block";
        if (e) moveTooltip(e);

        try {
          if (!checklistCache.has(cardId)) checklistCache.set(cardId, { loaded: false, checklists: [] });
          const cached = checklistCache.get(cardId);

          if (!cached.loaded) {
            cached.checklists = await fetchCardChecklists(token, cardId);
            cached.loaded = true;
          }

          tt.innerHTML = `
            <h4>${escapeHtml(ev.title)}</h4>
            <div class="meta">${escapeHtml(listName)}</div>
            ${renderChecklistHtml(cached.checklists)}
          `;
        } catch (err) {
          tt.innerHTML = `
            <h4>${escapeHtml(ev.title)}</h4>
            <div class="meta">${escapeHtml(listName)}</div>
            <div class="error">Impossible de charger les checklists</div>
          `;
        }
      };

      ganttEl.onmouseleave = () => hideTooltip();
    }

    function syncZoomUI(){
      const z = getZoom();
      document.getElementById("zoom1").classList.toggle("active", z === "1");
      document.getElementById("zoom3").classList.toggle("active", z === "3");
      document.getElementById("zoom6").classList.toggle("active", z === "6");
    }

    function applyZoomView(){
      const z = getZoom();
      if (!calendar) return;
      if (z === "1") calendar.changeView("multiMonth1");
      else if (z === "6") calendar.changeView("multiMonth6");
      else calendar.changeView("multiMonthQuarter");
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Init FullCalendar (toolbar only)
      calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
        locale: "fr",
        firstDay: 1,
        height: "auto",

        initialView: "multiMonthQuarter",
        views: {
          multiMonthQuarter: { type: "multiMonth", duration: { months: 3 } },
          multiMonth1: { type: "multiMonth", duration: { months: 1 } },
          multiMonth6: { type: "multiMonth", duration: { months: 6 } }
        },

        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "" // avoid duplicate duration controls
        },

        datesSet: () => {
          renderGantt();
        }
      });

      calendar.render();

      // Restore search
      const searchInput = document.getElementById("searchInput");
      searchInput.value = getSearch();
      searchInput.addEventListener("input", () => {
        setSearch(searchInput.value);
        clearTimeout(window.__searchT);
        window.__searchT = setTimeout(() => applyFilter(), 120);
      });

      // Label filter
      document.getElementById("labelFilter").addEventListener("change", applyFilter);

      // Zoom buttons (single source of duration control)
      const setZoomAndRefresh = (z) => {
        setZoom(z);
        syncZoomUI();
        applyZoomView();   // triggers datesSet -> renderGantt()
      };
      document.getElementById("zoom1").addEventListener("click", () => setZoomAndRefresh("1"));
      document.getElementById("zoom3").addEventListener("click", () => setZoomAndRefresh("3"));
      document.getElementById("zoom6").addEventListener("click", () => setZoomAndRefresh("6"));

      syncZoomUI();
      applyZoomView();

      // Refresh / token actions
      document.getElementById("refreshBtn").addEventListener("click", () =>
        load().catch(err => { setError(err.message); setStatus(""); })
      );
      document.getElementById("logoutBtn").addEventListener("click", forgetToken);

      document.getElementById("saveTokenBtn").addEventListener("click", () => {
        const input = document.getElementById("tokenInput");
        const token = input.value.trim();
        if (!token) { setError("Token manquant."); return; }
        saveToken(token);
        input.value = "";
        load().catch(err => { setError(err.message); setStatus(""); });
      });

      // Responsive re-render (scale)
      window.addEventListener("resize", () => {
        clearTimeout(window.__ganttResizeT);
        window.__ganttResizeT = setTimeout(() => renderGantt(), 120);
      });

      load().catch(err => { setError(err.message); setStatus(""); });
    });
  </script>
</body>
</html>
