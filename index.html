<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Roadmap Volkswagen</title>

<!-- Favicon (SVG inline) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%230f172a'/%3E%3Cstop offset='1' stop-color='%231f2937'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='6' y='10' width='52' height='48' rx='12' fill='url(%23g)'/%3E%3Crect x='6' y='18' width='52' height='6' rx='3' fill='%23ffffff' opacity='.18'/%3E%3Crect x='16' y='6' width='6' height='12' rx='3' fill='%23ffffff' opacity='.9'/%3E%3Crect x='42' y='6' width='6' height='12' rx='3' fill='%23ffffff' opacity='.9'/%3E%3Cpath d='M18 32h28M18 40h20' stroke='%23ffffff' stroke-width='4' stroke-linecap='round' opacity='.9'/%3E%3C/svg%3E">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

<style>
/* =========================
   DESIGN POLISH (no behavior change)
   ========================= */
:root{
  --bg:#f6f7fb;
  --surface:#ffffff;
  --border:#e5e7eb;
  --muted:#64748b;
  --text:#0f172a;

  --left:320px;
  --row:28px;
  --subrow:24px;
  --barH:14px;

  --dayp: 1%;
  --weekp: 7%;

  --radius:12px;
  --radiusChip:999px;

  --shadowSm: 0 6px 18px rgba(2,6,23,.08);
  --shadowMd: 0 18px 45px rgba(2,6,23,.14);

  --gridDay: rgba(2,6,23,.06);
  --gridWeek: rgba(2,6,23,.12);
  --weekend: rgba(2,6,23,.055);

  --focus: rgba(15,23,42,.20);
  --selectBg: rgba(15,23,42,.055);
  --selectBgRight: rgba(15,23,42,.035);
  --selectAccent: rgba(15,23,42,.55);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  background:var(--bg);
  color:var(--text);

  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;

  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.container{width:100%;max-width:none;margin:0;padding:0 10px;}

.topbar{
  position:sticky;top:0;z-index:10;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  flex:0 0 auto;
}
.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  padding:6px 0; /* slightly tighter */
  align-items:center
}

.chip,.btn,.token{
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:var(--radiusChip);
  padding:6px 10px;
  font-weight:900;
  font-size:12px;
  line-height:1;
  height:34px;
  display:inline-flex;align-items:center;gap:8px;
  box-shadow: 0 1px 0 rgba(2,6,23,.02);
}
.btn{cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.chip strong{font-size:11px;color:var(--muted);font-weight:900}

.btn:focus-visible,
.viewtab:focus-visible,
.ddbtn:focus-visible,
.mini:focus-visible,
#saveToken:focus-visible,
#logout:focus-visible{
  outline:none;
  box-shadow: 0 0 0 3px var(--focus);
}

.viewtabs{display:flex;gap:6px;align-items:center}
.viewtab{
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:var(--radiusChip);
  padding:6px 10px;
  height:34px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  opacity:.6;
  display:inline-flex;align-items:center;
  transition: opacity .12s ease, transform .08s ease;
}
.viewtab:active{transform: translateY(1px)}
.viewtab.active{opacity:1}

.spacer{flex:1 1 auto}

.token{gap:6px}
.token input{
  border:0;outline:0;background:transparent;
  font-weight:900;font-size:12px;min-width:160px;
  color:var(--text);
}
.token input::placeholder{color:rgba(100,116,139,.85)}
.token button{height:34px}

.main{
  flex:1 1 auto;
  min-height:0;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.panel{
  margin-top:6px;
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:var(--surface);
  overflow:hidden;
  position:relative;

  flex:1 1 auto;
  min-height:0;
  display:flex;
  flex-direction:column;
}

/* FullCalendar: compact + custom zoom buttons */
#calendar{
  padding:2px 6px;
  border-bottom:1px solid var(--border);
  flex:0 0 auto
}
.fc .fc-view-harness{display:none}
.fc .fc-toolbar.fc-header-toolbar{margin:1px 0} /* tighter */
.fc .fc-toolbar-title{
  font-size:12px;
  font-weight:900;
  letter-spacing:.2px;
}
.fc .fc-button{
  padding:4px 8px!important;
  font-size:12px!important;
  line-height:1!important;
  height:28px!important;
}
.fc .fc-toolbar-chunk{display:flex;align-items:center;gap:6px}
.fc .fc-button-group > .fc-button{margin:0!important}

/* active state for 1M/3M/6M */
.fc .fc-button.is-active{
  background:#0f172a!important;
  border-color:#0f172a!important;
  color:#fff!important;
  opacity:1!important;
}
.fc .fc-button:not(.is-active){opacity:.75}

/* Gantt wrapper fills remaining height */
#gantt{
  padding:6px;
  flex:1 1 auto;
  min-height:0;
  overflow:hidden;
}
#kanban{
  flex:1 1 auto;
  min-height:0;
  overflow:auto;
  padding:8px;
  display:none;
}

.shell{
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;

  height:100%;
  min-height:0;
  display:flex;
  flex-direction:column;
  background:var(--surface);
}
.head{
  display:grid;
  grid-template-columns:var(--left) 1fr;
  border-bottom:1px solid var(--border);
  flex:0 0 auto;
}
.hl{
  border-right:1px solid var(--border);
  padding:6px 8px;
  font-size:10px;
  font-weight:900;
  color:var(--muted);
  display:flex;align-items:center
}
.hr{padding:6px 8px;overflow:hidden}

/* header rows */
.rowline{display:flex;margin-top:2px}

.tickW,
.monthTick{
  font-size:10px;
  font-weight:900;
  text-align:center;
  display:flex;
  align-items:center;
  justify-content:center;
  height:14px; /* makes centering consistent */
  line-height:14px;
}

.tickW{
  color:rgba(100,116,139,.92);
  letter-spacing:.2px;
}
.monthTick{
  color:rgba(15,23,42,.88);
  text-transform:capitalize;
}

/* 1M header (dates + days) */
.dayline,.dateline{display:flex;margin-top:2px}
.daytick,.datetick{
  width:var(--dayp);
  font-size:10px;
  font-weight:900;
  color:rgba(100,116,139,.90);
  text-align:center;
  height:14px;
  line-height:14px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.daytick.we{opacity:.55}
.datetick{color:rgba(15,23,42,.86)}

/* the ONLY vertical scroll */
.scroll{
  display:grid;
  grid-template-columns:var(--left) 1fr;
  min-height:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling: touch;
  scroll-behavior:smooth;
}

.left{
  border-right:1px solid var(--border);
  overflow:visible;
}
.right{
  position:relative;
  overflow:visible;
  background:#fff;
}

/* overlays */
.weekendLayer{
  position:absolute; inset:0;
  pointer-events:none;
  z-index:1;
}
.weekendBlock{
  position:absolute; top:0; bottom:0;
  background:var(--weekend);
}
.gridLayer{
  position:absolute; inset:0;
  pointer-events:none;
  z-index:2;
}
.gridLine{
  position:absolute; top:0; bottom:0;
  width:1px;
  background:var(--gridDay);
}
.gridLine.week{
  background:var(--gridWeek);
}

/* today line */
.todayline{
  position:absolute;top:0;bottom:0;width:2px;
  background:#ef4444;opacity:.60;pointer-events:none;
  z-index:6;
}

.rowL, .rowR{border-bottom:1px solid rgba(229,231,235,.9);}
.rowL{
  display:flex;align-items:center;gap:8px;padding:0 8px;height:var(--row);
  cursor:pointer;user-select:none;
  transition: background .10s ease;
}
.rowL:hover{background:#f8fafc}
.rowL .chev{width:14px;opacity:.55;font-weight:900}
.rowL .title{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:900;
}
.rowL .due{flex:0 0 auto;font-size:11px;font-weight:900;color:rgba(100,116,139,.95);}

.subL{
  display:flex;align-items:center;gap:8px;padding:0 8px 0 28px;height:var(--subrow);
  cursor:pointer;user-select:none;
  transition: background .10s ease;
}
.subL:hover{background:#f8fafc}
.subL .dot{
  width:8px;height:8px;border-radius:2px;transform:rotate(45deg);
  border:1px solid rgba(15,23,42,.10);
}
.subL .stitle{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:300;color:rgba(15,23,42,.88);
}
.subL .sdue{flex:0 0 auto;font-size:11px;font-weight:900;color:rgba(100,116,139,.95);}

.checkL{
  display:flex;align-items:center;gap:8px;padding:0 8px 0 28px;height:var(--subrow);
  cursor:default;user-select:none;background:#f8fafc;
}
.checkL .ctitle{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:800;color:rgba(100,116,139,.95);
}

.rowR{height:var(--row);position:relative;z-index:3}
.subR{height:var(--subrow);position:relative;z-index:3}

.bar{
  position:absolute;height:var(--barH);
  border-radius:10px;
  padding:0 6px;
  font-size:11px;
  font-weight:900;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  cursor:pointer;
  top:50%;
  transform:translateY(-50%);
  box-shadow: var(--shadowSm);
  border:1px solid rgba(15,23,42,.10);
  display:flex;align-items:center;justify-content:center;text-align:center;
  z-index:5;
}
.bar:active{transform: translateY(calc(-50% + 1px));}
.bar.overdue,.milestone.overdue{
  border-color:#ef4444;
  box-shadow: 0 0 0 2px rgba(239,68,68,.28), var(--shadowSm);
}
.milestone{
  position:absolute;width:11px;height:11px;
  transform:translate(-50%,-50%) rotate(45deg);
  border-radius:3px;
  cursor:pointer;
  top:50%;
  box-shadow: var(--shadowSm);
  border:1px solid rgba(15,23,42,.10);
  z-index:5;
}

/* Selection highlight (more product-like) */
.is-selected{ background:var(--selectBg) !important; }
.rowR.is-selected, .subR.is-selected{ background:var(--selectBgRight) !important; }
.rowL.is-selected, .subL.is-selected, .checkL.is-selected{
  box-shadow: inset 3px 0 0 var(--selectAccent);
}

/* dropdown tags */
.ddbtn{
  border:0;background:transparent;
  font-weight:900;font-size:12px;cursor:pointer;
  display:inline-flex;align-items:center;gap:6px;max-width:220px;
  padding:0;
}
.ddbtn .lbl{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ddbtn .caret{opacity:.6;font-size:11px}
.dd{
  position:absolute;top: calc(100% + 6px);
  min-width:260px;max-width:min(360px, calc(100vw - 22px));
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow: var(--shadowMd);
  padding:6px;display:none;z-index:999;
}
.dd.open{display:block}
.dd .row{display:flex;align-items:center;gap:10px;padding:8px 8px;border-radius:10px;}
.dd .row:hover{background:#f8fafc}
.dd input[type="checkbox"]{width:16px;height:16px}
.dd .name{font-weight:900;font-size:12px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dd .dotc{width:10px;height:10px;border-radius:999px;flex:0 0 auto;border:1px solid rgba(15,23,42,.10)}
.dd .actions{display:flex;gap:6px;padding:6px 6px 4px;border-top:1px solid var(--border);margin-top:6px;}
.dd .mini{
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:10px;
  padding:6px 8px;
  font-weight:900;font-size:12px;
  cursor:pointer
}
.dd .mini:active{transform: translateY(1px)}

@media (max-width: 760px){ :root{ --left: 240px; } }
@media (max-width: 520px){
  :root{ --left: 190px; }
  .rowL .due, .subL .sdue{display:none;}
}

/* kanban */
.kanbanGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;}
.kcol{
  background:#f8fafc;border:1px solid var(--border);
  border-radius:var(--radius);
  padding:8px;min-height:120px;
}
.kcol h3{margin:0 0 6px;font-size:12px;font-weight:900;color:rgba(100,116,139,.95);}
.kcard{
  background:var(--surface);
  border:1px solid var(--border);
  border-left:4px solid #94a3b8;
  border-radius:12px;
  padding:8px;
  font-size:12px;
  font-weight:900;
  margin-bottom:6px;
  box-shadow: var(--shadowSm);
}
.kmeta{margin-top:4px;font-size:11px;color:rgba(100,116,139,.95);font-weight:900}

/* banner + loading */
.banner{
  position:absolute;left:10px;right:10px;top:10px;z-index:20;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);
  padding:10px 12px;
  box-shadow: var(--shadowMd);
  display:none;
}
.banner .row{display:flex;align-items:center;gap:10px}
.banner .msg{font-weight:900;font-size:12px;color:var(--text);min-width:0;flex:1 1 auto}
.banner .hint{font-size:11px;font-weight:900;color:rgba(100,116,139,.95);margin-top:2px}
.banner .actions{display:flex;gap:6px}
.banner .mini{
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:10px;
  padding:6px 8px;
  font-weight:900;font-size:12px;
  cursor:pointer;white-space:nowrap
}

.loading{
  position:absolute;inset:0;z-index:15;display:none;
  background:rgba(246,247,251,.55);
  backdrop-filter: blur(3px);
  align-items:center;justify-content:center;
}
.loading .box{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:10px 12px;
  font-weight:900;font-size:12px;
  box-shadow: var(--shadowMd);
}

/* KPI bar bottom */
.kpiWrap{
  padding:8px 0 12px; /* slightly tighter */
  display:flex;justify-content:center;
  flex:0 0 auto;
}
.kpi{
  font-size:12px;font-weight:900;color:rgba(100,116,139,.95);
  display:inline-flex;gap:14px;align-items:center;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radiusChip);
  padding:8px 12px;
  box-shadow: 0 1px 0 rgba(2,6,23,.02);
}
.kpi b{color:var(--text)}

/* Fullscreen button */
.fsBtn{
  position:fixed;right:14px;bottom:14px;z-index:50;
  height:40px;min-width:40px;
  border:1px solid var(--border);
  background:var(--surface);
  border-radius:var(--radiusChip);
  box-shadow: var(--shadowMd);
  cursor:pointer;
  font-weight:900;font-size:12px;
  display:flex;align-items:center;justify-content:center;
}
.fsBtn:active{transform:translateY(1px)}
</style>
</head>

<body>
<div class="topbar">
  <div class="container">
    <div class="controls">
      <div class="viewtabs">
        <button class="viewtab active" id="tabGantt" type="button">T√¢ches en cours</button>
        <button class="viewtab" id="tabKanban" type="button">T√¢ches bloqu√©es</button>
      </div>

      <div class="chip" id="tagsChip">
        <strong>Tags</strong>
        <button class="ddbtn" id="tagsBtn" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="lbl" id="tagsBtnLabel">Tous</span>
          <span class="caret">‚ñæ</span>
        </button>
        <div class="dd" id="tagsDropdown" role="menu" aria-label="Tags">
          <div id="tagsList"></div>
          <div class="actions">
            <button class="mini" id="tagsAll" type="button">Tous</button>
            <button class="mini" id="tagsNone" type="button">Aucun</button>
          </div>
        </div>
      </div>

      <button class="btn" id="toggleAll">Afficher les sous-t√¢ches</button>

      <div class="spacer"></div>

      <button class="btn" id="logout" title="Oublier le token">Oublier le token</button>

      <div class="token" title="Token Trello (stock√© localement)">
        <input id="tokenInput" type="password" placeholder="Token Trello"/>
        <button class="btn" id="saveToken">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="container main">
  <div class="panel" id="panelRoot">
    <div class="banner" id="banner">
      <div class="row">
        <div class="msg" id="bannerMsg">‚Äî</div>
        <div class="actions">
          <button class="mini" id="bannerRetry" type="button">R√©essayer</button>
          <button class="mini" id="bannerReconnect" type="button">Reconnex.</button>
          <button class="mini" id="bannerClose" type="button">OK</button>
        </div>
      </div>
      <div class="hint" id="bannerHint"></div>
    </div>

    <div class="loading" id="loading">
      <div class="box" id="loadingText">Chargement‚Ä¶</div>
    </div>

    <div id="calendar"></div>
    <div id="gantt"></div>
    <div id="kanban"></div>
  </div>

  <div class="kpiWrap">
    <div class="kpi" id="kpiText">‚Äî</div>
  </div>
</div>

<button class="fsBtn" id="fsBtn" title="Plein √©cran">‚§¢</button>

<script>
/* ================= CONFIG ================= */
const TRELLO={key:"ec995ad68de9cdaafd64b131e5fa00ec",boardId:"6490c5416cea9255ba3b0383"};
const DONE=new Set(["üéâ Termin√©"]);
const BLOCKED_LISTS=new Set(["üîí Bloqu√©","‚úã En attente"]);
const COLORS={
  green:"#22c55e",yellow:"#eab308",orange:"#f97316",red:"#ef4444",
  purple:"#a855f7",blue:"#3b82f6",sky:"#0ea5e9",
  lime:"#84cc16",pink:"#ec4899",black:"#111827"
};
const API="https://api.trello.com/1";

/* localStorage keys */
const TAGS_KEY="tc_selected_tags";
const TAGS_NONE="__NONE__";
const EXPAND_KEY="tc_expanded_cards";
const URL_STATE_KEY="tc_url_state_v10";

/* checklist cache persistent */
const CL_CACHE_KEY="tc_checklist_cache_v1";
const CL_TTL_MS=20*60*1000;
const CL_MAX_ITEMS=120;

/* ================= STATE ================= */
let calendar;
let updateToggleBtn=null;

let allCards=[];
let filteredCards=[];
let blockedCards=[];
let filteredBlockedCards=[];

let listNames=new Map();
let doneListIds=new Set();
let blockedListIds=new Set();

let allTags=[];
let selectedTags=new Set();
let tagsMode="all";

let expandedCards=new Set();
const checklistCache=new Map();
let checklistPersistent=new Map();

/* selection */
let selectedRowKey = null;

/* ================= HELPERS ================= */
const qs=o=>new URLSearchParams(o).toString();
const token=()=>localStorage.getItem("trello_token");
const setToken=(t)=>localStorage.setItem("trello_token", t);
const clearToken=()=>localStorage.removeItem("trello_token");
const day=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x};
const diffDays=(a,b)=>Math.round((day(b)-day(a))/86400000);
const esc=s=>String(s).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m]));
function fmtDue(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  return new Intl.DateTimeFormat("fr",{day:"2-digit",month:"short"}).format(d);
}
function isOverdue(iso){
  if(!iso) return false;
  const d=day(new Date(iso));
  return d < day(new Date());
}

/* ISO week number (Mon-based) */
function isoWeek(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date - yearStart) / 86400000) + 1)/7);
}
function monthLabelFR(dt){
  return new Intl.DateTimeFormat("fr",{month:"long"}).format(dt);
}

/* ================= UI: banner/loading/kpi ================= */
const bannerEl=()=>document.getElementById("banner");
function showBanner(msg, hint="", {retry=true,reconnect=true}={}){
  const b=bannerEl();
  document.getElementById("bannerMsg").textContent=msg;
  document.getElementById("bannerHint").textContent=hint||"";
  document.getElementById("bannerRetry").style.display = retry ? "" : "none";
  document.getElementById("bannerReconnect").style.display = reconnect ? "" : "none";
  b.style.display="block";
}
function hideBanner(){ bannerEl().style.display="none"; }
function setLoading(on, text="Chargement‚Ä¶"){
  const el=document.getElementById("loading");
  document.getElementById("loadingText").textContent=text;
  el.style.display=on ? "flex" : "none";
}
function setKpi(){
  const el=document.getElementById("kpiText");
  const inProgress=filteredCards.length;
  const overdue=filteredCards.filter(c=>isOverdue(c.due)).length;
  const blocked=filteredBlockedCards.length;
  el.innerHTML = `<span><b>${inProgress}</b> en cours</span><span><b>${overdue}</b> en retard</span><span><b>${blocked}</b> bloqu√©es</span>`;
}

/* ================= URL state ================= */
function readUrlState(){
  const p=new URLSearchParams(location.search);
  const view=p.get("view");
  const zoom=p.get("zoom");
  const tagsRaw=p.get("tags")||"";
  const tags = tagsRaw ? tagsRaw.split(",").map(s=>decodeURIComponent(s)) : null;
  return {view, zoom, tags};
}
function writeUrlState(){
  const p=new URLSearchParams();
  const isKanban = document.getElementById("tabKanban").classList.contains("active");
  p.set("view", isKanban ? "kanban" : "gantt");

  const vt=calendar?.view?.type || "multiMonthQuarter";
  const zoom = (vt==="multiMonth1") ? "1" : (vt==="multiMonth6") ? "6" : "3";
  p.set("zoom", zoom);

  if(tagsMode==="none"){
    p.set("tags", encodeURIComponent(TAGS_NONE));
  }else if(selectedTags.size){
    p.set("tags", [...selectedTags].map(t=>encodeURIComponent(t)).join(","));
  }

  const next = `${location.pathname}?${p.toString()}`;
  history.replaceState(null,"",next);
  try{ localStorage.setItem(URL_STATE_KEY, next); }catch{}
}

/* ================= persistent checklist cache ================= */
function loadPersistentChecklistCache(){
  checklistPersistent=new Map();
  try{
    const raw=localStorage.getItem(CL_CACHE_KEY);
    if(!raw) return;
    const obj=JSON.parse(raw);
    const now=Date.now();
    for(const [cardId, entry] of Object.entries(obj||{})){
      if(!entry || typeof entry.t!=="number") continue;
      if(now - entry.t > CL_TTL_MS) continue;
      checklistPersistent.set(cardId, entry);
    }
  }catch{}
}
function persistChecklistCache(){
  try{
    const arr=[...checklistPersistent.entries()]
      .sort((a,b)=>(b[1]?.t||0)-(a[1]?.t||0))
      .slice(0, CL_MAX_ITEMS);
    const obj={};
    for(const [id, entry] of arr) obj[id]=entry;
    localStorage.setItem(CL_CACHE_KEY, JSON.stringify(obj));
  }catch{}
}
function getCachedChecklists(cardId){
  const mem=checklistCache.get(cardId);
  if(mem?.loaded) return mem.checklists;

  const p=checklistPersistent.get(cardId);
  if(p?.v){
    checklistCache.set(cardId,{loaded:true,checklists:p.v});
    return p.v;
  }
  return null;
}
function setCachedChecklists(cardId, checklists){
  checklistCache.set(cardId,{loaded:true,checklists});
  checklistPersistent.set(cardId,{t:Date.now(), v:checklists});
  persistChecklistCache();
}

/* ================= TAGS ================= */
function rebuildTagsModel(){
  const map=new Map();
  const tagCards=[...allCards, ...blockedCards];
  for(const c of tagCards){
    for(const l of c.labels){
      const name=(l.name||"").trim();
      if(!name) continue;
      // "Sprint VN" must not appear in tags dropdown
      if(name.toLowerCase() === "sprint vn") continue;
      if(!map.has(name)){
        const hex = l.color ? (COLORS[l.color] || null) : null;
        map.set(name,{name,color:l.color||null,hex});
      }else{
        const cur=map.get(name);
        if(!cur.color && l.color){
          cur.color=l.color;
          cur.hex=COLORS[l.color] || cur.hex;
        }
      }
    }
  }
  allTags=[...map.values()].sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}));
}
function restoreSelectedTags(){
  selectedTags=new Set();
  try{
    const raw=localStorage.getItem(TAGS_KEY);
    const arr=raw?JSON.parse(raw):[];
    if(arr.includes(TAGS_NONE)){ tagsMode="none"; return; }
    for(const t of arr){
      if(allTags.some(x=>x.name===t)) selectedTags.add(t);
    }
    tagsMode = selectedTags.size ? "some" : "all";
  }catch{}
}
function persistSelectedTags(){
  if(tagsMode === "none"){
    localStorage.setItem(TAGS_KEY, JSON.stringify([TAGS_NONE]));
    return;
  }
  localStorage.setItem(TAGS_KEY, JSON.stringify([...selectedTags]));
}
function setTagsBtnLabel(){
  const el=document.getElementById("tagsBtnLabel");
  if(tagsMode === "none"){ el.textContent="Aucun"; return; }
  const n=selectedTags.size;
  if(n===0) el.textContent="Tous";
  else if(n===1) el.textContent=[...selectedTags][0];
  else el.textContent=`${n} tags`;
}
function renderTagsDropdown(){
  const listEl=document.getElementById("tagsList");
  listEl.innerHTML="";

  for(const t of allTags){
    const id="tag_" + btoa(unescape(encodeURIComponent(t.name))).replaceAll("=","");
    const checked=selectedTags.has(t.name);

    const row=document.createElement("label");
    row.className="row";
    row.setAttribute("for", id);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.id=id;
    cb.checked=checked;
    cb.addEventListener("change", ()=>{
      tagsMode = "some";
      if(cb.checked) selectedTags.add(t.name);
      else selectedTags.delete(t.name);
      persistSelectedTags();
      setTagsBtnLabel();
      applyFilters();
    });

    const dot=document.createElement("span");
    dot.className="dotc";
    dot.style.background = t.hex || "#e2e8f0";

    const name=document.createElement("div");
    name.className="name";
    name.textContent=t.name;

    row.appendChild(cb);
    row.appendChild(dot);
    row.appendChild(name);
    listEl.appendChild(row);
  }

  setTagsBtnLabel();
}
function openTags(){
  const dd=document.getElementById("tagsDropdown");
  const btn=document.getElementById("tagsBtn");
  const chip=document.getElementById("tagsChip");
  dd.style.left = btn.offsetLeft + "px";
  dd.style.top  = (chip.offsetHeight + 6) + "px";
  dd.classList.add("open");
  btn.setAttribute("aria-expanded","true");
}
function closeTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.remove("open");
  document.getElementById("tagsBtn").setAttribute("aria-expanded","false");
}
function toggleTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.contains("open") ? closeTags() : openTags();
}

/* ================= EXPAND STATE ================= */
function restoreExpanded(){
  expandedCards=new Set();
  try{
    const raw=localStorage.getItem(EXPAND_KEY);
    const arr=raw?JSON.parse(raw):[];
    for(const id of arr) expandedCards.add(id);
  }catch{}
}
function persistExpanded(){
  localStorage.setItem(EXPAND_KEY, JSON.stringify([...expandedCards]));
}

/* ================= LOAD (Trello) ================= */
async function fetchBoardLists(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/lists?` + qs({
    key:TRELLO.key, token:token(), fields:"name", filter:"open"
  });
  const res = await fetch(url);
  if(!res.ok){ const e=new Error("Lists fetch failed"); e.status=res.status; throw e; }
  return res.json();
}
async function fetchBoardCards(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/cards?` + qs({
    key:TRELLO.key, token:token(), fields:"name,start,due,idList,labels,url,badges", customFieldItems:true, filter:"open"
  });
  const res = await fetch(url);
  if(!res.ok){ const e=new Error("Cards fetch failed"); e.status=res.status; throw e; }
  return res.json();
}
async function fetchBoardCustomFields(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/customFields?` + qs({
    key:TRELLO.key, token:token()
  });
  const res = await fetch(url);
  if(!res.ok){ const e=new Error("Custom fields fetch failed"); e.status=res.status; throw e; }
  return res.json();
}
function normalizeTrelloDate(iso){ return iso || null; }

async function load(){
  hideBanner();
  if(!token()){
    allCards=[]; blockedCards=[]; filteredCards=[]; filteredBlockedCards=[];
    setKpi();
    renderGantt([]);
    renderKanban([]);
    showBanner("Ajoute ton token Trello pour charger le board.", "Le token est stock√© localement dans ton navigateur.", {retry:false,reconnect:false});
    return;
  }

  setLoading(true, "Chargement Trello‚Ä¶");
  try{
    const [lists,cards,customFields]=await Promise.all([
      fetchBoardLists(),
      fetchBoardCards(),
      fetchBoardCustomFields()
    ]);

    listNames=new Map(lists.map(l=>[l.id,l.name]));
    doneListIds=new Set(lists.filter(l=>DONE.has(l.name)).map(l=>l.id));
    blockedListIds=new Set(lists.filter(l=>BLOCKED_LISTS.has(l.name)).map(l=>l.id));
    const customFieldNames=new Map(customFields.map(f=>[f.id, f.name]));

    const mappedCards = cards.map(c=>{
      const isBlocked = blockedListIds.has(c.idList);
      const startRaw=normalizeTrelloDate(c.start);
      const dueRaw=normalizeTrelloDate(c.due);

      if(!startRaw && !dueRaw && !isBlocked) return null;

      const start=startRaw||dueRaw;
      const end=(startRaw && dueRaw)
        ? new Date(new Date(dueRaw).getTime()+86400000).toISOString()
        : undefined;

      const labels=(c.labels||[]).map(l=>({name:l.name||"", color:l.color||null}));
      const firstColored=labels.find(l=>l.color)?.color;
      const baseColor=COLORS[firstColored] || "#475569";

      let reason="";
      for(const item of (c.customFieldItems||[])){
        const fieldName = customFieldNames.get(item.idCustomField);
        if(fieldName !== "Raison") continue;
        if(item.value?.text) reason = item.value.text;
        else if(item.value?.number) reason = item.value.number;
        break;
      }

      return {
        id:c.id,
        title:c.name,
        start,
        end,
        due:dueRaw,
        url:c.url,
        list:listNames.get(c.idList)||"",
        labels,
        baseColor,
        listId:c.idList,
        hasSubtasks:(c.badges?.checkItems || 0) > 0,
        reason
      };
    }).filter(Boolean);

    allCards = mappedCards.filter(c=>!doneListIds.has(c.listId) && !blockedListIds.has(c.listId));
    blockedCards = mappedCards.filter(c=>blockedListIds.has(c.listId));

    rebuildTagsModel();
    restoreSelectedTags();
    renderTagsDropdown();

    restoreExpanded();
    applyFilters();

  }catch(err){
    const status = err?.status;
    const isAuth = status===401 || status===400;
    const isRate = status===429;
    const msg = isAuth ? "Token invalide ou expir√©." : isRate ? "Trello limite le rythme (rate limit)." : "Erreur de chargement Trello.";
    const hint = isAuth
      ? "Clique ‚ÄúReconnex.‚Äù puis colle un nouveau token."
      : isRate
        ? "Attends quelques secondes puis r√©essaie."
        : "V√©rifie ta connexion r√©seau puis r√©essaie.";
    showBanner(msg, hint, {retry:!isAuth, reconnect:true});
    setKpi();
  }finally{
    setLoading(false);
  }
}

/* ================= FILTERS + color rules ================= */
function getHomogeneousColorIfAny(){
  if(tagsMode==="some" && selectedTags.size===1){
    const name=[...selectedTags][0];
    const tag=allTags.find(t=>t.name===name);
    return tag?.hex || null;
  }
  return null;
}

function applyFilters(){
  const selected=[...selectedTags];

  filteredCards = allCards.filter(c=>{
    const tagOK = tagsMode === "none"
      ? false
      : (selected.length===0 || c.labels.some(l=>selected.includes((l.name||"").trim())));
    return tagOK;
  });
  filteredBlockedCards = blockedCards.filter(c=>{
    const tagOK = tagsMode === "none"
      ? false
      : (selected.length===0 || c.labels.some(l=>selected.includes((l.name||"").trim())));
    return tagOK;
  });

  const homog = getHomogeneousColorIfAny();

  calendar.removeAllEvents();
  calendar.addEventSource(filteredCards.map(c=>{
    const col = homog || c.baseColor;
    return {
      id:c.id, title:c.title, start:c.start, end:c.end || undefined, allDay:true,
      url:c.url,
      backgroundColor:col, borderColor:col, textColor:"#fff",
      extendedProps:{ listName:c.list }
    };
  }));

  renderGantt(filteredCards, homog);
  renderKanban(filteredBlockedCards, homog);

  setKpi();
  if(typeof updateToggleBtn === "function") updateToggleBtn();
  syncZoomButtonsActive();
  writeUrlState();
}

/* ================= Header helpers ================= */
function getViewRange(){
  const v=calendar.view;
  const rangeStart=day(v.currentStart);
  const rangeEnd=day(v.currentEnd); // exclusive
  const totalDays=Math.max(1, diffDays(rangeStart, rangeEnd));
  return { rangeStart, rangeEnd, totalDays };
}
function setPercentVars(totalDays){
  const dayP = 100 / totalDays;
  document.documentElement.style.setProperty("--dayp", dayP + "%");
  document.documentElement.style.setProperty("--weekp", (dayP*7) + "%");
}

/**
 * Week header aligned to our day grid:
 * - We build chunks of 7 days starting from rangeStart
 * - Each chunk has width proportional to its number of days (last chunk can be shorter)
 * -> week labels are perfectly centered over the day columns
 */
function buildMonthWeekHeaderAligned(rangeStart, rangeEnd){
  const totalDays = diffDays(rangeStart, rangeEnd);

  const chunks=[];
  for(let i=0;i<totalDays;i+=7){
    const span = Math.min(7, totalDays - i);
    const dt = new Date(rangeStart.getTime() + i*86400000);
    chunks.push({
      startIndex:i,
      spanDays:span,
      weekNo: isoWeek(dt),
      month: dt.getMonth(),
      year: dt.getFullYear(),
      monthLabel: monthLabelFR(dt)
    });
  }

  const weeksHtml = chunks.map(ch=>{
    const wPct = (ch.spanDays / totalDays) * 100;
    return `<div class="tickW" style="width:${wPct}%">S${ch.weekNo}</div>`;
  }).join("");

  // group consecutive chunks by month/year for month row
  const monthGroups=[];
  for(const ch of chunks){
    const last=monthGroups[monthGroups.length-1];
    if(last && last.month===ch.month && last.year===ch.year){
      last.spanDays += ch.spanDays;
    }else{
      monthGroups.push({
        month: ch.month,
        year: ch.year,
        label: ch.monthLabel,
        spanDays: ch.spanDays
      });
    }
  }

  const monthsHtml = monthGroups.map(mg=>{
    const wPct = (mg.spanDays / totalDays) * 100;
    return `<div class="monthTick" style="width:${wPct}%">${esc(mg.label)}</div>`;
  }).join("");

  return { monthsHtml, weeksHtml };
}

/* ================= Checklist sub-tasks ================= */
function subTasksFromChecklists(cardId, checklists){
  const items=[];
  for(const cl of (checklists||[])){
    for(const it of (cl.checkItems||[])){
      if(it.state === "complete") continue;
      if(!it.due) continue;
      items.push({
        id: `${cardId}::${it.id}`,
        cardId,
        title: it.name || "(sans nom)",
        due: it.due,
        checklistName: cl.name || "",
      });
    }
  }
  items.sort((a,b)=>new Date(a.due)-new Date(b.due));
  return items;
}
function subTasksByChecklist(cardId, checklists){
  const groups=[];
  for(const cl of (checklists||[])){
    const items=[];
    for(const it of (cl.checkItems||[])){
      if(it.state === "complete") continue;
      if(!it.due) continue;
      items.push({
        id: `${cardId}::${it.id}`,
        cardId,
        title: it.name || "(sans nom)",
        due: it.due,
        checklistName: cl.name || "",
      });
    }
    if(items.length){
      items.sort((a,b)=>new Date(a.due)-new Date(b.due));
      groups.push({ name: cl.name || "", items });
    }
  }
  return groups;
}

/* ================= Selection helpers ================= */
function clearSelection(){
  document.querySelectorAll(".is-selected").forEach(el=>el.classList.remove("is-selected"));
}
function applySelectionByKey(key){
  clearSelection();
  if(!key) return;
  const els = document.querySelectorAll(`[data-rowkey="${CSS.escape(key)}"]`);
  els.forEach(el=>el.classList.add("is-selected"));
  if(key.startsWith("sub:")){
    const cardId = key.split(":")[1];
    document.querySelectorAll(`[data-rowkey="card:${CSS.escape(cardId)}"]`).forEach(el=>el.classList.add("is-selected"));
  }
}

/* ================= Overlays: weekend + grid (pixel-perfect) ================= */
function renderRightOverlays(rangeStart, totalDays){
  const right = document.getElementById("gRight");
  if(!right) return;

  const weekendLayer = right.querySelector(".weekendLayer");
  const gridLayer = right.querySelector(".gridLayer");
  if(!weekendLayer || !gridLayer) return;

  weekendLayer.innerHTML = "";
  gridLayer.innerHTML = "";

  const width = right.clientWidth || 1;

  // Weekend blocks: for each Saturday, shade Saturday+Sunday
  for(let i=0;i<totalDays;i++){
    const dt = new Date(rangeStart.getTime() + i*86400000);
    if(dt.getDay() === 6){
      const span = Math.min(2, totalDays - i);
      const left = Math.round((i * width) / totalDays);
      const rightX = Math.round(((i + span) * width) / totalDays);
      const w = Math.max(0, rightX - left);
      const block = document.createElement("div");
      block.className = "weekendBlock";
      block.style.left = left + "px";
      block.style.width = w + "px";
      weekendLayer.appendChild(block);
    }
  }

  // Grid lines: stable pixel positions (prevents thicker random lines)
  const posMap = new Map();
  for(let i=1;i<totalDays;i++){
    const x = Math.round((i * width) / totalDays);
    if(x <= 0 || x >= width) continue;
    const isWeek = (i % 7 === 0);
    const prev = posMap.get(x) || false;
    posMap.set(x, prev || isWeek);
  }
  const xs = [...posMap.keys()].sort((a,b)=>a-b);
  for(const x of xs){
    const line = document.createElement("div");
    line.className = "gridLine" + (posMap.get(x) ? " week" : "");
    line.style.left = x + "px";
    gridLayer.appendChild(line);
  }
}

/* ================= Scroll sizing (hard fix) ================= */
function forceRoadmapScrollHeight(){
  const shell = document.querySelector("#gantt .shell");
  const head = document.querySelector("#gantt .head");
  const scroll = document.getElementById("roadmapScroll");
  if(!shell || !head || !scroll) return;

  const shellH = shell.clientHeight || 0;
  const headH = head.offsetHeight || 0;
  const target = Math.max(120, shellH - headH);
  scroll.style.height = target + "px";
  scroll.style.overflowY = "auto";
}

/* ================= GANTT RENDER ================= */
function renderGantt(cards, homogeneousColor=null){
  const g=document.getElementById("gantt");
  const prevScrollTop = document.getElementById("roadmapScroll")?.scrollTop || 0;

  if(!cards.length){
    g.innerHTML = `
      <div class="shell" style="padding:12px;border:1px solid var(--border);border-radius:var(--radius)">
        <div style="font-weight:900;font-size:12px;color:var(--muted)">Aucune carte √† afficher avec ces filtres.</div>
      </div>`;
    return;
  }

  const { rangeStart, rangeEnd, totalDays } = getViewRange();
  const viewType = calendar.view.type;
  setPercentVars(totalDays);

  const milestoneLabel = "milestones";
  const productsLabel = "produits";
  const sprintVnLabel = "sprint vn";
  const sprintVnGateLabels = new Set([
    "plateformes build",
    "plateformes tma",
    "vw club build",
    "vw club tma"
  ]);

  function isSprintVnLineEnabled(){
    if(tagsMode === "none") return false;
    // "active" = checkbox checked in tags filter UI
    // Works for: explicit selections (tagsMode="some") and "Tous" button (all checked).
    for(const t of selectedTags){
      if(sprintVnGateLabels.has(String(t||"").trim().toLowerCase())) return true;
    }
    return false;
  }

  const milestoneCards = cards.filter(c=>c.labels.some(l=>(l.name||"").trim().toLowerCase()===milestoneLabel));
  const productCards = cards.filter(c=>c.labels.some(l=>(l.name||"").trim().toLowerCase()===productsLabel));
  const sprintVNCards = cards.filter(c=>c.labels.some(l=>(l.name||"").trim().toLowerCase()===sprintVnLabel));
  const showSprintVnLine = isSprintVnLineEnabled();

  const regularCards = cards.filter(c=>!c.labels.some(l=>{
    const name=(l.name||"").trim().toLowerCase();
    return name===milestoneLabel || name===productsLabel || name===sprintVnLabel;
  }));

  const byList=new Map();
  for(const c of regularCards){
    if(!byList.has(c.list)) byList.set(c.list, []);
    byList.get(c.list).push(c);
  }
  const listOrder=[...byList.keys()].sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
  for(const k of listOrder){
    byList.get(k).sort((a,b)=>new Date(a.start)-new Date(b.start));
  }

  function idxForDate(iso){
    const d=day(new Date(iso));
    return Math.max(0, Math.min(totalDays-1, diffDays(rangeStart, d)));
  }
  function pctForIdx(idx){ return (idx / totalDays) * 100; }
  function pctForSpan(days){ return (days / totalDays) * 100; }

  function renderBarOrMilestone(c, color){
    const sIdx = idxForDate(c.start);
    let spanDays = 1;

    if(c.end){
      const endInc = new Date(day(new Date(c.end)).getTime() - 86400000);
      const eIdx = Math.max(0, Math.min(totalDays-1, diffDays(rangeStart, endInc)));
      spanDays = Math.max(1, (eIdx - sIdx + 1));
    }

    const leftPct = pctForIdx(sIdx);
    const widthPct = pctForSpan(spanDays);
    const midPct = leftPct + (widthPct/2);

    const overdue = isOverdue(c.due);

    return c.end
      ? `<div class="bar ${overdue?"overdue":""}"
            data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}" data-has-subtasks="${c.hasSubtasks?"true":"false"}"
            style="left:${leftPct}%;width:${widthPct}%;background:${color};color:#fff;border-color:${color};">
            ${esc(c.title)}
          </div>`
      : `<div class="milestone ${overdue?"overdue":""}"
            data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}" data-has-subtasks="${c.hasSubtasks?"true":"false"}"
            style="left:${midPct}%;background:${color};"></div>`;
  }

  // Today line
  const today = day(new Date());
  let todayLine = "";
  if(today >= rangeStart && today < rangeEnd){
    const idx = diffDays(rangeStart, today);
    const xPct = ((idx + 0.5) / totalDays) * 100;
    todayLine = `<div class="todayline" style="left:${xPct}%"></div>`;
  }

  // Header rules:
  const showDates = (viewType === "multiMonth1");
  const showDays  = (viewType === "multiMonth1");
  const showMonthWeek = (viewType === "multiMonthQuarter" || viewType === "multiMonth6");

  const dayLetters = ['L','M','M','J','V','S','D'];
  const datesHtml = showDates ? Array.from({length: totalDays}).map((_,i)=>{
    const dt = new Date(rangeStart.getTime() + i*86400000);
    return `<div class="datetick">${String(dt.getDate()).padStart(2,"0")}</div>`;
  }).join("") : "";

  const daysHtml = showDays ? Array.from({length: totalDays}).map((_,i)=>{
    const dt = new Date(rangeStart.getTime() + i*86400000);
    const di = (dt.getDay() + 6) % 7;
    const isWE = di >= 5;
    return `<div class="daytick ${isWE?'we':''}">${dayLetters[di]}</div>`;
  }).join("") : "";

  let monthsHtml="", weeksHtml="";
  if(showMonthWeek){
    const h = buildMonthWeekHeaderAligned(rangeStart, rangeEnd);
    monthsHtml = h.monthsHtml;
    weeksHtml = h.weeksHtml;
  }

  // Rows
  let leftHtml = "";
  let rightHtml = "";

  leftHtml += `<div class="rowL" data-rowkey="card:milestones" style="cursor:default;">
    <div class="chev"></div>
    <div class="title" style="font-size:11px;color:var(--muted);">Milestones (${milestoneCards.length})</div>
    <div class="due"></div>
  </div>`;
  {
    let bars="";
    const sorted=[...milestoneCards].sort((a,b)=>new Date(a.start)-new Date(b.start));
    for(const c of sorted){
      const color = homogeneousColor || c.baseColor;
      bars += renderBarOrMilestone(c, color);
    }
    rightHtml += `<div class="rowR" data-rowkey="card:milestones">${bars}</div>`;
  }

  // Sprint VN (same display as Milestones) ‚Äî only when one of the gate filters is active
  if(showSprintVnLine){
    leftHtml += `<div class="rowL" data-rowkey="card:sprintvn" style="cursor:default;">
      <div class="chev"></div>
      <div class="title" style="font-size:11px;color:var(--muted);">Sprint VN (${sprintVNCards.length})</div>
      <div class="due"></div>
    </div>`;
    {
      let bars="";
      const sorted=[...sprintVNCards].sort((a,b)=>new Date(a.start)-new Date(b.start));
      for(const c of sorted){
        const color = homogeneousColor || c.baseColor;
        bars += renderBarOrMilestone(c, color);
      }
      rightHtml += `<div class="rowR" data-rowkey="card:sprintvn">${bars}</div>`;
    }
  }


  leftHtml += `<div class="rowL" data-rowkey="card:produits" style="cursor:default;">
    <div class="chev"></div>
    <div class="title" style="font-size:11px;color:var(--muted);">Produits (${productCards.length})</div>
    <div class="due"></div>
  </div>`;
  {
    let bars="";
    const sorted=[...productCards].sort((a,b)=>new Date(a.start)-new Date(b.start));
    for(const c of sorted){
      const color = homogeneousColor || c.baseColor;
      bars += renderBarOrMilestone(c, color);
    }
    rightHtml += `<div class="rowR" data-rowkey="card:produits">${bars}</div>`;
  }

  for(const listName of listOrder){
    for(const c of byList.get(listName)){
      const expanded = expandedCards.has(c.id);
      const hasSubtasks = c.hasSubtasks;
      const chev = !hasSubtasks ? "" : (expanded ? "‚ñæ" : "‚ñ∏");
      const dueTxt = fmtDue(c.due);

      leftHtml += `
        <div class="rowL" data-kind="card" data-card="${esc(c.id)}" data-url="${esc(c.url||"")}"
             data-has-subtasks="${hasSubtasks?"true":"false"}" data-rowkey="card:${esc(c.id)}">
          <div class="chev">${chev}</div>
          <div class="title">${esc(c.title)}</div>
          <div class="due">${esc(dueTxt)}</div>
        </div>`;

      const color = homogeneousColor || c.baseColor;
      rightHtml += `<div class="rowR" data-rowkey="card:${esc(c.id)}">${renderBarOrMilestone(c, color)}</div>`;

      if(expanded && hasSubtasks){
        const loadedChecklists = getCachedChecklists(c.id);
        const grouped = loadedChecklists ? subTasksByChecklist(c.id, loadedChecklists) : null;

        if(!loadedChecklists){
          leftHtml += `<div class="subL" data-kind="sub" data-card="${esc(c.id)}" data-rowkey="sub:${esc(c.id)}:loading">
            <span class="dot" style="background:#cbd5e1"></span><div class="stitle">Chargement‚Ä¶</div><div class="sdue"></div>
          </div>`;
          rightHtml += `<div class="subR" data-rowkey="sub:${esc(c.id)}:loading"></div>`;
        } else if(!grouped || grouped.length === 0){
          leftHtml += `<div class="subL" data-kind="sub" data-card="${esc(c.id)}" data-rowkey="sub:${esc(c.id)}:empty">
            <span class="dot" style="background:#cbd5e1"></span><div class="stitle">(aucune sous-t√¢che dat√©e)</div><div class="sdue"></div>
          </div>`;
          rightHtml += `<div class="subR" data-rowkey="sub:${esc(c.id)}:empty"></div>`;
        } else {
          for(const group of grouped){
            const gkey = `check:${c.id}:${group.name||"Checklist"}`;
            leftHtml += `<div class="checkL" data-card="${esc(c.id)}" data-rowkey="${esc(gkey)}"><div class="ctitle">${esc(group.name || "Checklist")}</div></div>`;
            rightHtml += `<div class="subR" data-rowkey="${esc(gkey)}"></div>`;

            for(const st of group.items){
              const di = idxForDate(st.due);
              const xPct = ((di + 0.5) / totalDays) * 100;
              const dueLabel = fmtDue(st.due);
              const rkey = `sub:${c.id}:${st.id}`;

              leftHtml += `
                <div class="subL" data-kind="sub" data-card="${esc(c.id)}" data-sub="${esc(st.id)}" data-rowkey="${esc(rkey)}">
                  <span class="dot" style="background:${color}"></span>
                  <div class="stitle">${esc(st.title)}</div>
                  <div class="sdue">${esc(dueLabel)}</div>
                </div>`;
              const overdueSub = isOverdue(st.due);
              rightHtml += `
                <div class="subR" data-rowkey="${esc(rkey)}">
                  <div class="milestone ${overdueSub?"overdue":""}" data-kind="sub" data-card="${esc(c.id)}" data-sub="${esc(st.id)}"
                       style="left:${xPct}%;background:${color};"></div>
                </div>`;
            }
          }
        }
      }
    }
  }

  g.innerHTML = `
    <div class="shell">
      <div class="head">
        <div class="hl"></div>
        <div class="hr">
          ${showMonthWeek ? `<div class="rowline">${monthsHtml}</div>` : ``}
          ${showMonthWeek ? `<div class="rowline">${weeksHtml}</div>` : ``}
          ${showDates ? `<div class="dateline">${datesHtml}</div>` : ``}
          ${showDays  ? `<div class="dayline">${daysHtml}</div>` : ``}
        </div>
      </div>

      <div class="scroll" id="roadmapScroll">
        <div class="left" id="gLeft">${leftHtml}</div>
        <div class="right" id="gRight">
          <div class="weekendLayer"></div>
          <div class="gridLayer"></div>
          ${todayLine}
          ${rightHtml}
        </div>
      </div>
    </div>`;

  const scrollEl = document.getElementById("roadmapScroll");
  if(scrollEl) scrollEl.scrollTop = prevScrollTop;

  bindGanttInteractions();
  applySelectionByKey(selectedRowKey);

  requestAnimationFrame(()=>{
    forceRoadmapScrollHeight();
    renderRightOverlays(rangeStart, totalDays);
  });
}

/* ================= INTERACTIONS ================= */
async function fetchCardChecklists(cardId){
  const url = `${API}/cards/${encodeURIComponent(cardId)}/checklists?` + qs({key:TRELLO.key, token:token()});
  const res = await fetch(url);
  if(!res.ok){
    const err=new Error("Checklist fetch failed");
    err.status=res.status;
    throw err;
  }
  return res.json();
}
async function ensureChecklistsLoaded(cardId){
  const cached = getCachedChecklists(cardId);
  if(cached) return cached;
  try{
    const cl = await fetchCardChecklists(cardId);
    setCachedChecklists(cardId, cl);
    return cl;
  }catch(err){
    setCachedChecklists(cardId, []);
    if(err?.status===401 || err?.status===400){
      showBanner("Token invalide ou expir√©.", "Reconnex. avec un nouveau token.", {retry:false,reconnect:true});
    }
    return [];
  }
}
function setSelectedRow(key){
  selectedRowKey = key;
  applySelectionByKey(key);
}
function bindGanttInteractions(){
  const root=document.getElementById("gantt");
  root.onclick = async (e)=>{
    const el = e.target.closest("[data-kind], .rowL, .subL");
    if(!el) return;

    const isOpenShortcut = e.ctrlKey || e.metaKey;
    const url = el.getAttribute("data-url");
    if(isOpenShortcut && url){
      window.open(url,"_blank","noopener,noreferrer");
      return;
    }

    const kind = el.getAttribute("data-kind");
    const cardId = el.getAttribute("data-card");

    if(el.getAttribute("data-rowkey")){
      setSelectedRow(el.getAttribute("data-rowkey"));
    }

    if(kind === "sub" && cardId){
      const subId = el.getAttribute("data-sub");
      if(subId) setSelectedRow(`sub:${cardId}:${subId}`);
      return;
    }

    if(kind === "card" && cardId){
      setSelectedRow(`card:${cardId}`);

      if(el.getAttribute("data-has-subtasks") !== "true") return;

      if(expandedCards.has(cardId)) expandedCards.delete(cardId);
      else expandedCards.add(cardId);
      persistExpanded();

      if(expandedCards.has(cardId)){
        await ensureChecklistsLoaded(cardId);
      }

      renderGantt(filteredCards, getHomogeneousColorIfAny());
      if(typeof updateToggleBtn === "function") updateToggleBtn();
      return;
    }
  };
}

/* ================= KANBAN ================= */
function renderKanban(cards, homogeneousColor=null){
  const k=document.getElementById("kanban");
  if(!cards.length){
    k.innerHTML = `<div style="font-weight:900;font-size:12px;color:var(--muted);padding:6px">Aucune carte bloqu√©e avec ces filtres.</div>`;
    return;
  }

  const byList=new Map();
  for(const c of cards){
    if(!byList.has(c.list)) byList.set(c.list, []);
    byList.get(c.list).push(c);
  }
  const listOrder=[...byList.keys()].sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
  for(const kname of listOrder){
    byList.get(kname).sort((a,b)=>{
      const da = a.start || a.due || 0;
      const db = b.start || b.due || 0;
      return new Date(da) - new Date(db);
    });
  }

  const cols=listOrder.map(listName=>{
    const cardsHtml = byList.get(listName).map(c=>{
      const reason = c.reason || "";
      const col = homogeneousColor || c.baseColor;
      return `
        <div class="kcard" style="border-left-color:${col}">
          ${esc(c.title)}
          ${reason ? `<div class="kmeta">${esc(reason)}</div>` : ""}
        </div>`;
    }).join("");
    return `<div class="kcol"><h3>${esc(listName)}</h3>${cardsHtml || `<div class="kmeta">Aucune carte</div>`}</div>`;
  }).join("");

  k.innerHTML = `<div class="kanbanGrid">${cols}</div>`;
}

/* ================= View ================= */
function setView(view){
  const gantt=document.getElementById("gantt");
  const kanban=document.getElementById("kanban");
  const calendarEl=document.getElementById("calendar");
  const tabG=document.getElementById("tabGantt");
  const tabK=document.getElementById("tabKanban");

  const showG = view === "gantt";
  gantt.style.display = showG ? "" : "none";
  kanban.style.display = showG ? "none" : "block";
  calendarEl.style.display = showG ? "" : "none";
  tabG.classList.toggle("active", showG);
  tabK.classList.toggle("active", !showG);

  writeUrlState();
}

/* ================= FullCalendar active buttons ================= */
function syncZoomButtonsActive(){
  const vt = calendar?.view?.type;
  const b1 = document.querySelector(".fc-m1-button");
  const b3 = document.querySelector(".fc-m3-button");
  const b6 = document.querySelector(".fc-m6-button");
  [b1,b3,b6].forEach(b=>b && b.classList.remove("is-active"));
  if(vt==="multiMonth1" && b1) b1.classList.add("is-active");
  else if(vt==="multiMonth6" && b6) b6.classList.add("is-active");
  else if(b3) b3.classList.add("is-active");
}

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded",()=>{
  loadPersistentChecklistCache();

  calendar=new FullCalendar.Calendar(document.getElementById("calendar"),{
    locale:"fr",
    initialView:"multiMonthQuarter",
    views:{
      multiMonthQuarter:{type:"multiMonth",duration:{months:3}},
      multiMonth1:{type:"multiMonth",duration:{months:1}},
      multiMonth6:{type:"multiMonth",duration:{months:6}}
    },
    customButtons:{
      m1:{ text:"1M", click:()=>calendar.changeView("multiMonth1") },
      m3:{ text:"3M", click:()=>calendar.changeView("multiMonthQuarter") },
      m6:{ text:"6M", click:()=>calendar.changeView("multiMonth6") }
    },
    headerToolbar:{left:"prev,next m1,m3,m6",center:"title",right:""},
    datesSet:()=>{
      applyFilters();
      syncZoomButtonsActive();
      requestAnimationFrame(forceRoadmapScrollHeight);
    }
  });
  calendar.render();
  syncZoomButtonsActive();

  // banner
  document.getElementById("bannerClose").onclick=()=>hideBanner();
  document.getElementById("bannerRetry").onclick=()=>load();
  document.getElementById("bannerReconnect").onclick=()=>{ document.getElementById("tokenInput")?.focus(); };

  // open/close all subtasks
  const toggleBtn = document.getElementById("toggleAll");
  updateToggleBtn = function(){
    const ids = (filteredCards||[]).filter(c=>c.hasSubtasks).map(c=>c.id);
    if(!ids.length){
      toggleBtn.disabled=true;
      toggleBtn.textContent="Afficher les sous-t√¢ches";
      return;
    }
    toggleBtn.disabled=false;
    const allOpen = ids.every(id=>expandedCards.has(id));
    toggleBtn.textContent = allOpen ? "Cacher les sous-t√¢ches" : "Afficher les sous-t√¢ches";
  };

  toggleBtn.onclick = async ()=>{
    const ids = (filteredCards||[]).filter(c=>c.hasSubtasks).map(c=>c.id);
    if(!ids.length) return;

    const allOpen = ids.every(id=>expandedCards.has(id));
    if(allOpen){
      ids.forEach(id=>expandedCards.delete(id));
      persistExpanded();
      renderGantt(filteredCards, getHomogeneousColorIfAny());
      updateToggleBtn();
      return;
    }

    ids.forEach(id=>expandedCards.add(id));
    persistExpanded();
    renderGantt(filteredCards, getHomogeneousColorIfAny());
    updateToggleBtn();

    const toLoad = ids.filter(id=>!getCachedChecklists(id));
    if(toLoad.length>=8) setLoading(true, "Chargement des checklists‚Ä¶");
    await Promise.allSettled(toLoad.map(async (cardId)=>{ await ensureChecklistsLoaded(cardId); }));
    if(toLoad.length>=8) setLoading(false);

    renderGantt(filteredCards, getHomogeneousColorIfAny());
  };

  // token
  document.getElementById("logout").onclick=()=>{
    clearToken();
    hideBanner();
    allCards=[]; blockedCards=[]; filteredCards=[]; filteredBlockedCards=[];
    selectedRowKey=null;
    renderGantt([]);
    renderKanban([]);
    setKpi();
    showBanner("Token supprim√©.", "Colle un token Trello pour recharger.", {retry:false,reconnect:false});
  };
  document.getElementById("saveToken").onclick=()=>{
    const v=(document.getElementById("tokenInput").value||"").trim();
    if(!v) return;
    setToken(v);
    document.getElementById("tokenInput").value="";
    load();
  };

  // tags dropdown
  const tagsBtn=document.getElementById("tagsBtn");
  const dd=document.getElementById("tagsDropdown");
  tagsBtn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleTags(); });
  dd.addEventListener("click", (e)=>e.stopPropagation());
  document.getElementById("tagsAll").addEventListener("click", ()=>{
    tagsMode="all";
    selectedTags=new Set(allTags.map(t=>t.name));
    persistSelectedTags();
    renderTagsDropdown();
    applyFilters();
  });
  document.getElementById("tagsNone").addEventListener("click", ()=>{
    tagsMode="none";
    selectedTags.clear();
    persistSelectedTags();
    renderTagsDropdown();
    applyFilters();
  });
  document.addEventListener("click", ()=>closeTags());
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeTags(); });

  // view tabs
  document.getElementById("tabGantt").addEventListener("click", ()=>setView("gantt"));
  document.getElementById("tabKanban").addEventListener("click", ()=>setView("kanban"));

  // fullscreen
  const fsBtn=document.getElementById("fsBtn");
  function setFsIcon(){
    const isFs = !!document.fullscreenElement;
    fsBtn.textContent = isFs ? "‚§°" : "‚§¢";
    fsBtn.title = isFs ? "Quitter le plein √©cran" : "Plein √©cran";
  }
  fsBtn.addEventListener("click", async ()=>{
    try{
      if(document.fullscreenElement) await document.exitFullscreen();
      else await document.documentElement.requestFullscreen();
      setFsIcon();
    }catch{}
  });
  document.addEventListener("fullscreenchange", setFsIcon);
  setFsIcon();

  // resize: re-render + recompute scroll height
  window.addEventListener("resize", ()=>{
    clearTimeout(window.__rT);
    window.__rT=setTimeout(()=>{
      renderGantt(filteredCards, getHomogeneousColorIfAny());
      forceRoadmapScrollHeight();
    }, 120);
  });

  restoreExpanded();

  // URL hydration
  (function hydrateFromUrl(){
    let s=readUrlState();
    if(!location.search && localStorage.getItem(URL_STATE_KEY)){
      try{
        const u=new URL(localStorage.getItem(URL_STATE_KEY), location.origin);
        s = {
          ...s,
          ...{
            view: u.searchParams.get("view"),
            zoom: u.searchParams.get("zoom"),
            tags: (u.searchParams.get("tags")||"") ? (u.searchParams.get("tags")||"").split(",").map(decodeURIComponent) : null
          }
        };
      }catch{}
    }

    if(s.view==="kanban") setView("kanban");
    else setView("gantt");

    if(s.zoom==="1") calendar.changeView("multiMonth1");
    else if(s.zoom==="6") calendar.changeView("multiMonth6");
    else calendar.changeView("multiMonthQuarter");

    syncZoomButtonsActive();
  })();

  load().then(()=>{
    const st=readUrlState();
    if(st.tags && st.tags.length){
      if(st.tags.length===1 && st.tags[0]===TAGS_NONE){
        tagsMode="none";
        selectedTags.clear();
      }else{
        tagsMode="some";
        selectedTags=new Set(st.tags.filter(t=>allTags.some(x=>x.name===t)));
      }
      persistSelectedTags();
      renderTagsDropdown();
      applyFilters();
    }else{
      restoreSelectedTags();
      renderTagsDropdown();
      applyFilters();
    }
  });
});
</script>
</body>
</html>
