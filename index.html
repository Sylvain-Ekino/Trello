<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trello Gantt</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

<style>
:root{
  --bg:#f6f7fb; --border:#e5e7eb; --muted:#64748b;
  --left:320px; /* un peu plus large pour afficher sous-tÃ¢ches + date limite */
  --row:28px;   /* hauteur de ligne carte */
  --subrow:24px;/* hauteur de ligne sous-tÃ¢che */
  --padY:6px;
  --barH:14px;
}

*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:#0f172a}
.container{
  width:100%;
  max-width:none;      /* âœ… 100% largeur navigateur */
  margin:0;            /* âœ… plus de centrage 1280px */
  padding:0 10px;
}

.topbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
.controls{display:flex;gap:6px;flex-wrap:wrap;padding:6px 0;align-items:center}

.chip,.seg,.btn,.token{
  border:1px solid var(--border);
  background:#fff;border-radius:999px;padding:4px 6px;font-weight:800;
}
.chip{display:inline-flex;gap:6px;align-items:center;position:relative}
.chip strong{font-size:11px;color:var(--muted);font-weight:900}
.chip input,.token input{border:0;outline:0;background:transparent;font-weight:900;font-size:12px}

.seg{display:inline-flex;gap:2px;padding:2px}
.seg button{border:0;background:none;font-weight:900;opacity:.4;cursor:pointer}
.seg button.active{opacity:1}

.btn{cursor:pointer}
.token{display:flex;gap:4px}
.viewtabs{display:flex;gap:4px}
.viewtab{
  border:1px solid var(--border);
  background:#fff;
  border-radius:999px;
  padding:4px 10px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
  opacity:.6;
}
.viewtab.active{opacity:1}

.panel{margin-top:6px;border:1px solid var(--border);border-radius:12px;background:#fff;overflow:hidden}

#calendar{padding:4px 6px;border-bottom:1px solid var(--border)}
.fc .fc-view-harness{display:none}
.fc .fc-toolbar-title{font-size:13px;font-weight:900}
.fc .fc-button{padding:4px 6px!important;font-size:11px!important}

#gantt{padding:6px}
.shell{border:1px solid var(--border);border-radius:12px;overflow:hidden}
.head{display:grid;grid-template-columns:var(--left) 1fr;border-bottom:1px solid var(--border)}
.hl{border-right:1px solid var(--border);padding:4px 6px;font-size:10px;font-weight:900;color:var(--muted)}
.hr{padding:4px 6px;overflow:hidden}
.ticks{display:flex}
.tick{width:var(--week);font-size:10px;font-weight:900;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.days{display:flex;border-top:1px solid var(--border)}
.day{
  width:var(--day);
  font-size:10px;
  font-weight:900;
  color:var(--muted);
  text-align:center;
  padding:2px 0 3px;
}
.day.weekend{background:rgba(15,23,42,.06)}

.scroll{display:grid;grid-template-columns:var(--left) 1fr;max-height:75vh;overflow-y:auto}
.left{border-right:1px solid var(--border);overflow:hidden}
.right{position:relative;overflow-x:auto;overflow-y:hidden;
  background:repeating-linear-gradient(to right,#0001 0,#0001 1px,transparent 1px,transparent var(--day))}
.right::before{
  content:"";position:absolute;inset:0;
  background:repeating-linear-gradient(
    to right,
    transparent 0,
    transparent calc(var(--week)-1px),
    #0002 calc(var(--week)-1px),
    #0002 var(--week)
  );
  pointer-events:none;
}
.weekends{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:1;
}
.weekend{
  position:absolute;
  top:0;
  bottom:0;
  background:rgba(15,23,42,.06);
}

/* âœ… Ligne verticale "Aujourd'hui" */
.todayline{
  position:absolute;
  top:0; bottom:0;
  width:2px;
  background:#ef4444;
  opacity:.65;
  pointer-events:none;
  z-index:5;
}

.rowL, .rowR{
  border-bottom:1px solid var(--border);
}
.rowL.milestoneRow,
.rowR.milestoneRow{
  position:sticky;
  top:0;
  z-index:6;
  background:#fff;
}
.rowR.milestoneRow{z-index:5}
.rowL{
  display:flex;align-items:center;gap:8px;
  padding:0 8px;
  height:var(--row);
  cursor:pointer;
  user-select:none;
}
.rowL:hover{background:#f8fafc}
.rowL .chev{width:14px;opacity:.55;font-weight:900}
.rowL .title{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:900;
}
.rowL .due{
  flex:0 0 auto;
  font-size:11px;font-weight:900;color:var(--muted);
}

.subL{
  display:flex;align-items:center;gap:8px;
  padding:0 8px 0 28px; /* indentation */
  height:var(--subrow);
  cursor:pointer;
  user-select:none;
}
.subL:hover{background:#f8fafc}
.subL .dot{
  width:8px;height:8px;border-radius:2px;transform:rotate(45deg);
  border:1px solid rgba(15,23,42,.10);
}
.subL .stitle{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:300;
}
.subL .sdue{
  flex:0 0 auto;
  font-size:11px;font-weight:900;color:var(--muted);
}
.checkL{
  display:flex;align-items:center;gap:8px;
  padding:0 8px 0 28px;
  height:var(--subrow);
  cursor:default;
  user-select:none;
  background:#f8fafc;
}
.checkL .ctitle{
  min-width:0;flex:1 1 auto;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  font-size:12px;font-weight:600;color:var(--muted);
}

.rowR{
  height:var(--row);
  position:relative;
}
.subR{
  height:var(--subrow);
  position:relative;
}

.bar{
  position:absolute;
  height:var(--barH);
  border-radius:8px;
  padding:0 6px;
  font-size:11px;font-weight:900;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  cursor:pointer;
  top:50%;
  transform:translateY(-50%);
  box-shadow:0 10px 18px rgba(2,6,23,.10);
  border:1px solid rgba(15,23,42,.10);
  display:flex;align-items:center;justify-content:center;
  text-align:center;
}
.bar.full-title{overflow:visible;text-overflow:clip}
.bar.overdue,
.milestone.overdue{
  border-color:#ef4444;
  box-shadow:0 0 0 2px rgba(239,68,68,.35), 0 10px 18px rgba(239,68,68,.2);
}
.milestone{
  position:absolute;width:10px;height:10px;
  transform:translate(-50%,-50%) rotate(45deg);
  border-radius:2px;cursor:pointer;
  top:50%;
  box-shadow:0 10px 18px rgba(2,6,23,.10);
  border:1px solid rgba(15,23,42,.10);
}

/* Dropdown tags (checkbox list) */
.ddbtn{
  border:0;background:transparent;
  font-weight:900;font-size:12px;padding:0;
  cursor:pointer;display:inline-flex;align-items:center;gap:6px;
  max-width: 220px;
}
.ddbtn .lbl{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ddbtn .caret{opacity:.6;font-size:11px}
.dd{
  position:absolute;top: calc(100% + 6px);left:0;
  min-width: 260px;
  max-width: min(360px, calc(100vw - 22px));
  background:#fff;border:1px solid var(--border);border-radius:12px;
  box-shadow: 0 18px 45px rgba(2,6,23,.14);
  padding:6px;display:none;z-index:999;
}
.dd.open{display:block}
.dd .search{
  width:100%;border:1px solid var(--border);
  border-radius:10px;padding:8px 10px;
  font-weight:900;font-size:12px;outline:none;margin:6px 0 4px;
}
.dd .row{
  display:flex;align-items:center;gap:10px;
  padding:8px 8px;border-radius:10px;
}
.dd .row:hover{background:#f8fafc}
.dd input[type="checkbox"]{width:16px;height:16px}
.dd .name{
  font-weight:900;font-size:12px;min-width:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.dd .dotc{
  width:10px;height:10px;border-radius:999px;flex:0 0 auto;
  border:1px solid rgba(15,23,42,.10);
}
.dd .actions{
  display:flex;gap:6px;padding:6px 6px 4px;
  border-top:1px solid var(--border);margin-top:6px;
}
.dd .mini{
  border:1px solid var(--border);background:#fff;border-radius:10px;
  padding:6px 8px;font-weight:900;font-size:12px;cursor:pointer;
}

@media (max-width: 760px){
  :root{ --left: 240px; }
}
@media (max-width: 520px){
  :root{ --left: 190px; }
  .rowL .due, .subL .sdue{display:none;}
}

/* Tooltip */
.tt{
  position:fixed;z-index:999;
  background:#fff;border:1px solid var(--border);
  border-radius:10px;padding:8px;font-size:12px;
  box-shadow:0 20px 50px rgba(2,6,23,.18);
  max-width:420px;pointer-events:none;
  display:none;
}
.tt h4{margin:0 0 4px;font-size:12px}
.tt .meta{color:var(--muted);font-weight:900;margin-bottom:6px}
.tt ul{margin:0;padding-left:16px}
.tt .done{text-decoration:line-through;color:var(--muted)}

.kanbanGrid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:10px;
}
.kcol{
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
  min-height:120px;
}
.kcol h3{
  margin:0 0 6px;
  font-size:12px;
  font-weight:900;
  color:var(--muted);
}
.kcard{
  background:#fff;
  border:1px solid var(--border);
  border-left:4px solid #94a3b8;
  border-radius:10px;
  padding:8px;
  font-size:12px;
  font-weight:900;
  margin-bottom:6px;
  box-shadow:0 6px 18px rgba(2,6,23,.08);
}
.kmeta{
  margin-top:4px;
  font-size:11px;
  color:var(--muted);
  font-weight:900;
}
</style>
</head>

<body>
<div class="topbar">
  <div class="container">
    <div class="controls">
      <div class="viewtabs">
        <button class="viewtab active" id="tabGantt" type="button">TÃ¢ches en cours</button>
        <button class="viewtab" id="tabKanban" type="button">TÃ¢ches bloquÃ©es</button>
      </div>

      <div class="chip" id="tagsChip">
        <strong>Tags</strong>
        <button class="ddbtn" id="tagsBtn" type="button" aria-haspopup="true" aria-expanded="false">
          <span class="lbl" id="tagsBtnLabel">Tous</span>
          <span class="caret">â–¾</span>
        </button>
        <div class="dd" id="tagsDropdown" role="menu" aria-label="Tags">
          <input class="search" id="tagsSearch" placeholder="Filtrer tagsâ€¦" />
          <div id="tagsList"></div>
          <div class="actions">
            <button class="mini" id="tagsAll" type="button">Tous</button>
            <button class="mini" id="tagsNone" type="button">Aucun</button>
          </div>
        </div>
      </div>

      <div class="chip">
        <strong>Recherche</strong>
        <input id="searchInput"/>
      </div>

      <div class="seg">
        <button id="z1">1M</button>
        <button id="z3" class="active">3M</button>
        <button id="z6">6M</button>
      </div>

      <button class="btn" id="refresh">â†»</button>
      <button class="btn" id="logout">âœ•</button>

      <div class="token">
        <input id="tokenInput" type="password" placeholder="Token"/>
        <button class="btn" id="saveToken">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="panel">
    <div id="calendar"></div>
    <div id="gantt"></div>
    <div id="kanban" style="display:none;padding:8px"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const TRELLO={key:"ec995ad68de9cdaafd64b131e5fa00ec",boardId:"6490c5416cea9255ba3b0383"};
const DONE=new Set(["ðŸŽ‰ TerminÃ©"]);
const BLOCKED_LISTS=new Set(["ðŸ”’ BloquÃ©","âœ‹ En attente"]);
const COLORS={
  green:"#22c55e",yellow:"#eab308",orange:"#f97316",red:"#ef4444",
  purple:"#a855f7",blue:"#3b82f6",sky:"#0ea5e9",
  lime:"#84cc16",pink:"#ec4899",black:"#111827"
};
const API="https://api.trello.com/1";

let calendar;
let allCards=[];      // source cards (already excluding ðŸŽ‰ TerminÃ© + no dates)
let filteredCards=[]; // after tag/search filters
let blockedCards=[];
let filteredBlockedCards=[];
let listNames=new Map();
let doneListIds=new Set();
let blockedListIds=new Set();

let allTags=[];              // {name,color,hex} sorted
let selectedTags=new Set();  // by name
const TAGS_KEY="tc_selected_tags";
const TAGS_NONE="__NONE__";
const EXPAND_KEY="tc_expanded_cards";
let tagsMode="all"; // all | none | some

let expandedCards=new Set(); // cardId
const checklistCache=new Map(); // cardId -> {loaded, checklists}

/* ================= HELPERS ================= */
const qs=o=>new URLSearchParams(o).toString();
const token=()=>localStorage.getItem("trello_token");
const day=d=>{const x=new Date(d);x.setHours(0,0,0,0);return x};
const diffDays=(a,b)=>Math.round((day(b)-day(a))/86400000);
const esc=s=>String(s).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m]));
function fmtDue(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  return new Intl.DateTimeFormat("fr",{day:"2-digit",month:"short"}).format(d);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function isOverdue(iso){
  if(!iso) return false;
  const d=day(new Date(iso));
  return d < day(new Date());
}

/* ================= ZOOM BUTTONS ACTIVE STATE ================= */
function setZoomActive(viewType){
  const map = { multiMonth1:"z1", multiMonthQuarter:"z3", multiMonth6:"z6" };
  const activeId = map[viewType] || "z3";
  ["z1","z3","z6"].forEach(id=>{
    const b=document.getElementById(id);
    if(!b) return;
    b.classList.toggle("active", id===activeId);
  });
}

/* ================= TOOLTIP (checklists) ================= */
let ttEl=null;
function ensureTT(){
  if(ttEl) return ttEl;
  ttEl=document.createElement("div");
  ttEl.className="tt";
  document.body.appendChild(ttEl);
  return ttEl;
}
function moveTT(e){
  if(!ttEl || ttEl.style.display==="none") return;
  const pad=12;
  let x=e.clientX+pad, y=e.clientY+pad;
  const r=ttEl.getBoundingClientRect();
  const vw=window.innerWidth, vh=window.innerHeight;
  if(x+r.width+pad>vw) x=vw-r.width-pad;
  if(y+r.height+pad>vh) y=vh-r.height-pad;
  ttEl.style.left=x+"px"; ttEl.style.top=y+"px";
}
function hideTT(){ if(ttEl){ ttEl.style.display="none"; ttEl.innerHTML=""; } }

async function fetchCardChecklists(cardId){
  const url = `${API}/cards/${encodeURIComponent(cardId)}/checklists?` + qs({key:TRELLO.key, token:token()});
  const res = await fetch(url);
  if(!res.ok) throw new Error("Checklist fetch failed");
  return res.json();
}
function renderChecklistHtml(checklists){
  if(!checklists || checklists.length===0) return `<div class="meta">Aucune checklist</div>`;
  const maxLists=2, maxItems=10;
  let html="";
  for(const cl of checklists.slice(0,maxLists)){
    const items=(cl.checkItems||[]);
    const done=items.filter(i=>i.state==="complete").length;
    html += `<div class="meta"><strong>${esc(cl.name)}</strong> â€” ${done}/${items.length}</div>`;
    html += "<ul>";
    for(const it of items.slice(0,maxItems)){
      const isDone=it.state==="complete";
      html += `<li class="${isDone?"done":""}">${esc(it.name)}</li>`;
    }
    if(items.length>maxItems) html += `<li class="meta">+${items.length-maxItems}â€¦</li>`;
    html += "</ul>";
  }
  return html;
}

/* ================= TAGS (Aâ†’Z) ================= */
function rebuildTagsModel(){
  const map=new Map(); // name -> {name,color,hex}
  const tagCards=[...allCards, ...blockedCards];
  for(const c of tagCards){
    for(const l of c.labels){
      const name=(l.name||"").trim();
      if(!name) continue;
      if(!map.has(name)){
        const hex = l.color ? (COLORS[l.color] || null) : null;
        map.set(name,{name,color:l.color||null,hex});
      }else{
        const cur=map.get(name);
        if(!cur.color && l.color){
          cur.color=l.color;
          cur.hex=COLORS[l.color] || cur.hex;
        }
      }
    }
  }
  allTags=[...map.values()].sort((a,b)=>a.name.localeCompare(b.name,"fr",{sensitivity:"base"}));
}
function restoreSelectedTags(){
  selectedTags=new Set();
  try{
    const raw=localStorage.getItem(TAGS_KEY);
    const arr=raw?JSON.parse(raw):[];
    if(arr.includes(TAGS_NONE)){
      tagsMode="none";
      return;
    }
    for(const t of arr){
      if(allTags.some(x=>x.name===t)) selectedTags.add(t);
    }
    tagsMode = selectedTags.size ? "some" : "all";
  }catch{}
}
function persistSelectedTags(){
  if(tagsMode === "none"){
    localStorage.setItem(TAGS_KEY, JSON.stringify([TAGS_NONE]));
    return;
  }
  localStorage.setItem(TAGS_KEY, JSON.stringify([...selectedTags]));
}
function setTagsBtnLabel(){
  const el=document.getElementById("tagsBtnLabel");
  if(tagsMode === "none"){
    el.textContent="Aucun";
    return;
  }
  const n=selectedTags.size;
  if(n===0) el.textContent="Tous";
  else if(n===1) el.textContent=[...selectedTags][0];
  else el.textContent=`${n} tags`;
}
function renderTagsDropdown(){
  const listEl=document.getElementById("tagsList");
  const q=(document.getElementById("tagsSearch").value||"").trim().toLowerCase();
  listEl.innerHTML="";

  for(const t of allTags){
    if(q && !t.name.toLowerCase().includes(q)) continue;

    const id="tag_" + btoa(unescape(encodeURIComponent(t.name))).replaceAll("=","");
    const checked=selectedTags.has(t.name);

    const row=document.createElement("label");
    row.className="row";
    row.setAttribute("for", id);

    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.id=id;
    cb.checked=checked;
    cb.addEventListener("change", ()=>{
      tagsMode = "some";
      if(cb.checked) selectedTags.add(t.name);
      else selectedTags.delete(t.name);
      persistSelectedTags();
      setTagsBtnLabel();
      applyFilters();
    });

    const dot=document.createElement("span");
    dot.className="dotc";
    dot.style.background = t.hex || "#e2e8f0";

    const name=document.createElement("div");
    name.className="name";
    name.textContent=t.name;

    row.appendChild(cb);
    row.appendChild(dot);
    row.appendChild(name);
    listEl.appendChild(row);
  }

  setTagsBtnLabel();
}
function openTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.add("open");
  document.getElementById("tagsBtn").setAttribute("aria-expanded","true");
  setTimeout(()=>document.getElementById("tagsSearch").focus(), 0);
}
function closeTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.remove("open");
  document.getElementById("tagsBtn").setAttribute("aria-expanded","false");
}
function toggleTags(){
  const dd=document.getElementById("tagsDropdown");
  dd.classList.contains("open") ? closeTags() : openTags();
}

/* ================= EXPAND STATE ================= */
function restoreExpanded(){
  expandedCards=new Set();
  try{
    const raw=localStorage.getItem(EXPAND_KEY);
    const arr=raw?JSON.parse(raw):[];
    for(const id of arr) expandedCards.add(id);
  }catch{}
}
function persistExpanded(){
  localStorage.setItem(EXPAND_KEY, JSON.stringify([...expandedCards]));
}

/* ================= LOAD ================= */
async function fetchBoardLists(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/lists?` + qs({
    key:TRELLO.key, token:token(), fields:"name", filter:"open"
  });
  const res = await fetch(url);
  if(!res.ok) throw new Error("Lists fetch failed");
  return res.json();
}
async function fetchBoardCards(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/cards?` + qs({
    key:TRELLO.key, token:token(), fields:"name,start,due,idList,labels,url,badges", customFieldItems:true, filter:"open"
  });
  const res = await fetch(url);
  if(!res.ok) throw new Error("Cards fetch failed");
  return res.json();
}

async function fetchBoardCustomFields(){
  const url = `${API}/boards/${encodeURIComponent(TRELLO.boardId)}/customFields?` + qs({
    key:TRELLO.key, token:token()
  });
  const res = await fetch(url);
  if(!res.ok) throw new Error("Custom fields fetch failed");
  return res.json();
}

/* ... (le reste du fichier continue tel qu'il est dans votre index.html) ... */
</script>
</body>
</html>
